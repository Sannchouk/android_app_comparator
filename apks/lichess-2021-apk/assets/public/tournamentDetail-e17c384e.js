import{m as t,q as a,z as e,C as n,b1 as s,af as o,b4 as i,w as r,o as l,cO as c,cP as u,cQ as m,ag as d,r as h,a7 as p,a5 as f,a8 as g,g as b,at as v,a2 as N,as as w,b as k,ap as y,h as P,s as M,c as C,A as _,cd as B,H as I,al as T,cR as j,cS as O}from"./main.js";import{l as S}from"./layout-c7d0a2f4.js";import{C as F}from"./CountdownTimer-265e230d.js";import{M as x}from"./miniBoard-183a9cfa.js";import{p as A,j as D,w as L,l as R,r as W,t as $}from"./tournamentXhr-b8f81bd7.js";import{S as q}from"./index-6048898c.js";import{c as V,C as J}from"./chat-fb252130.js";var H={controller(t){let a=!1;function e(t){"backbutton"!==t&&a&&r.backbutton.stack.pop(),a=!1}return{open:function(){r.backbutton.stack.push(e),a=!0},close:e,isOpen:()=>a,root:t}},view:function(r){if(!r.isOpen())return null;return r.root.tournament?t("div",{className:"modal",id:"tournamentFaqModal",oncreate:i},t("header",null,t("button",{className:"modal_close",oncreate:n(s(r.close,"tournamentFaqModal"))},o),t("h2",null,a("tournamentFAQ"))),t("div",{className:"modal_content"},t("div",{className:"tournamentFaq"},t("p",null,a("willBeNotified")),t("h2",null,a("isItRated")),t("p",null,a("someRated")),t("h2",null,a("howAreScoresCalculated")),t("p",null,a("howAreScoresCalculatedAnswer")),t("h2",null,a("berserk")),t("p",null,a("berserkAnswer")),t("h2",null,a("howIsTheWinnerDecided")),t("p",null,a("howIsTheWinnerDecidedAnswer")),t("h2",null,a("howDoesPairingWork")),t("p",null,a("howDoesPairingWorkAnswer")),t("h2",null,a("howDoesItEnd")),t("p",null,a("howDoesItEndAnswer")),t("h2",null,a("otherRules")),t("p",null,a("thereIsACountdown")),t("p",null,e("drawingWithinNbMoves",10))))):null}},Q={controller(t){let a=!1;const e=d(null);function n(t){"backbutton"!==t&&a&&r.backbutton.stack.pop(),a=!1}return{open:function(s){A(t.tournament.id,s).then((t=>{e(t),r.backbutton.stack.push(u(n,"tournamentPlayerInfoModal")),a=!0,h()})).catch(p)},close:n,isOpen:()=>a,root:t,playerData:e}},view:function(e){if(!e.isOpen())return null;if(!e.root.tournament)return null;const s=e.playerData();if(!s)return null;const i=s.player,d=s.pairings,h=d.length?(d.reduce(((t,a)=>t+a.op.rating),0)/d.length).toFixed(0):"0";return t("div",{className:"modal tournamentInfoModal",id:"tournamentPlayerInfoModal",oncreate:m},t("header",null,t("button",{className:"modal_close",oncreate:n(u(e.close,"tournamentPlayerInfoModal"))},o),t("h2",{className:"tournamentModalHeader"},i.rank+". ",nt(i),i.name+" ("+i.rating+") ")),t("div",{className:"modal_content"},t("div",{className:"tournamentPlayerInfo"},t("table",{className:"tournamentModalStats"},t("tr",null,t("td",{className:"statName"},a("gamesPlayed")),t("td",{className:"statData"},i.nb.game)),t("tr",null,t("td",{className:"statName"},a("winRate")),t("td",{className:"statData"},i.nb.game?(i.nb.win/i.nb.game*100).toFixed(0)+"%":"0%")),t("tr",null,t("td",{className:"statName"},a("berserkRate")),t("td",{className:"statData"},i.nb.game?(i.nb.berserk/i.nb.game*100).toFixed(0)+"%":"0%")),t("tr",null,t("td",{className:"statName"},"Average Opponent"),t("td",{className:"statData"},h)),t("tr",{className:i.performance?"":"invisible"},t("td",{className:"statName"},a("performance")),t("td",{className:"statData"},i.performance)))),t("div",{className:"tournamentPlayerGames"},t("table",{className:"tournamentModalTable",oncreate:l((t=>{const a=c(t);if(a){const t=a.dataset.id,e=a.dataset.color;r.set(`/game/${t}?color=${e}&goingBack=1`)}}),void 0,c)},d.map((function(a,e){let n,s="oppOutcome";return void 0===a.score||null===a.score?n="*":Array.isArray(a.score)?(n=a.score[0],2===a.score[1]?s+=" streak":3===a.score[1]&&(s+=" double")):n=a.score,t("tr",{className:"list_item","data-id":a.id,"data-color":a.color,key:a.id},t("td",{className:"oppRank"}," ",d.length-e," "),t("td",{className:"oppName"}," ",a.op.name," "),t("td",{className:"oppRating"}," ",a.op.rating," "),t("td",{className:"oppColor"}," ",t("span",{className:"color-icon "+a.color}," ")," "),t("td",{className:s}," ",n," "))}))))))}},U={controller(t){let a=!1;const e=d(null);function n(t){"backbutton"!==t&&a&&r.backbutton.stack.pop(),a=!1}return{open:function(t){r.backbutton.stack.push(u(n,"tournamentTeamInfoModal")),e(t),a=!0,h()},close:n,isOpen:()=>a,root:t,teamId:e}},view:function(a){if(!a.isOpen())return null;const e=a.root.tournament,s=a.teamId();if(!(e&&e.teamBattle&&e.teamStanding&&s))return null;const i=e.teamBattle.teams[s],r=e.teamStanding.find((t=>t.id===s));if(!i||!r)return null;return t("div.modal.tournamentInfoModal",{id:"tournamentTeamInfoModal",oncreate:m},[t("header",[t("buton.modal_close",{oncreate:n(u(a.close,"tournamentTeamInfoModal"))},[o]),t("h2.tournamentModalHeader",[t("span",[r.rank+". "]),t("span.ttc-"+a.root.teamColorMap[s],[i+" "]),t("span",["("+r.score+")"])])]),t("div.modal_content",[t("div.tournamentTeamPlayers",[t("table.tournamentModalTable",[r.players.map((function(a,e){return t("tr.list_item.bglight",{key:a.user.id},[t("td.teamPlayerRank",e+1),t("td.teamPlayerName",a.user.name),t("td.teamPlayerScore",a.score)])}))])])])])}};let E,G=!1;var X={open:function(t){r.backbutton.stack.push(Y),G=!0,E=t},close:Y,view:()=>f("tournament_addtl_info_popup",void 0,(()=>function(){const e=E.tournament,n=e.teamBattle,s=n?n.joinWith.map((t=>[n.teams[t],t])).filter((t=>t[0])):[];return t("form",{id:"tournamentPasswordForm",class:"tournamentForm",onsubmit:function(t){return t.preventDefault(),function(t){const a=t[0].elements,e=a[0].value,n=a[1].value;E.join(e,n),Y()}(t.target)}},t("fieldset",null,t("div",{className:"select_input no_arrow_after"+(e.private?"":" notVisible")},t("div",{className:"text_input_container"},t("label",null,"Password: "),t("input",{type:"text",id:"tournamentPassword",className:"passwordField"}))),t("div",{className:"select_input no_arrow_after"+(e.teamBattle?"":" notVisible")},g.renderSelect("Team","team",s,b.tournament.join.lastTeam,!1))),t("div",{className:"popupActionWrapper"},t("button",{className:"popupAction",type:"submit"},t("span",{className:"fa fa-check"}),a("join"))))}()),G,Y)};function Y(t){"backbutton"!==t&&G&&r.backbutton.stack.pop(),G=!1}function z(e){const s=e.tournament;if(!s)return null;const o="https://lichess.org/tournament/"+s.id;return t("div",{className:"actions_bar"},t("button",{key:"faqButton",className:"action_bar_button fa fa-question-circle",oncreate:n(e.faqCtrl.open,(()=>N.show({text:a("tournamentFAQ"),duration:"short",position:"bottom"})))}),t("button",{key:"shareButton",className:"action_bar_button fa fa-share-alt",oncreate:n((()=>q.share({url:o})),(()=>N.show({text:a("shareGameUrl"),duration:"short",position:"bottom"})))}),e.chat?t("button",{key:"chatButton",className:"action_bar_button fa fa-comments withChip",oncreate:n(e.chat.open,(()=>N.show({text:a("chatRoom"),duration:"short",position:"bottom"})))},e.chat.nbUnread>0?t("span",{className:"chip"},e.chat.nbUnread<=99?e.chat.nbUnread:99):null):t.fragment({key:"noChat"},[]),e.hasJoined?function(e,s){if(s.isFinished||b.game.supportedVariants.indexOf(s.variant)<0)return t.fragment({key:"noWithdrawButton"},[]);return t("button",{key:"withdrawButton",className:"action_bar_button fa fa-flag",oncreate:n(e.withdraw,(()=>N.show({text:a("withdraw"),duration:"short",position:"bottom"})))})}(e,s):function(e,s){if(!k.isConnected()||s.isFinished||b.game.supportedVariants.indexOf(s.variant)<0||!s.verdicts.accepted||s.teamBattle&&0===s.teamBattle.joinWith.length)return t.fragment({key:"noJoinButton"},[]);const o=(s.private||s.teamBattle)&&(i=s,null==i.me)?()=>X.open(e):()=>e.join();var i;return t("button",{key:"joinButton",className:"action_bar_button fa fa-play",oncreate:n(o,(()=>N.show({text:a("join"),duration:"short",position:"bottom"})))})}(e,s))}function K(a,e){return void 0===a?null:[e?e+" ":null,t(F,{seconds:a})]}function Z(e,n){return t("div",{className:"tournamentHeader"},function(a){const e=a.perf.name,n=w(a.clock);return t("div",{className:"tournamentTimeInfo"},t("strong",{className:"tournamentInfo withIcon","data-icon":a.perf.icon},e+" • "+n+" • "+v(a.minutes)))}(e),e.spotlight?(i=e.spotlight,t("div",{className:"tournamentSpotlightInfo"},i.description)):null,function(e,n){return t("div",{className:"tournamentCreatorInfo"},"lichess"===e.createdBy?a("lichessTournaments"):a("by",e.createdBy)," • ",n)}(e,n.startsAt),e.position?(o=e.position,t("div",{className:"tournamentPositionInfo"+(o.wikiPath?" withLink":""),oncreate:l((()=>o&&o.wikiPath&&window.open(`https://en.wikipedia.org/wiki/${o.wikiPath}`,"_blank")))},o.eco+" "+o.name)):null,e.verdicts.list.length>0?function(a){const e=["tournamentConditions",k.isConnected()?"":"anonymous",a.accepted?"accepted":"rejected"].join(" ");return t("div",{className:e},t("span",{className:"withIcon","data-icon":"7"}),t("div",{className:"conditions_list"},a.list.map((a=>t("p",{className:"condition "+("ok"===a.verdict?"accepted":"rejected")},a.condition)))))}(e.verdicts):null,(s=e).isFinished||!s.teamBattle||s.teamBattle.joinWith.length>0?null:t("div",{className:"tournamentNoTeam"},t("span",{className:"withIcon","data-icon":"7"}),t("p",null,"You must join one of these teams to participate!")));var s,o,i}function tt(t){const a=t.target;return a.classList.contains("list_item")?a:y(a,".list_item")}function at(a){const e=a.tournament,s=a.currentPageResults,o=a.page,i=s.length>0?s[0].rank:0,r=s.length>0?s[s.length-1].rank:0,l=o>1,c=o<e.nbPlayers/10,u=k.get(),m=u?u.username:"",d=e.teamBattle;return t("div",{className:"tournamentLeaderboard"},t("ul",{className:"tournamentStandings box"+(a.isLoadingPage?" loading":""),oncreate:n((t=>function(t,a){var e;const n=null===(e=tt(a).dataset.player)||void 0===e?void 0:e.toLowerCase();n&&t.playerInfoCtrl.open(n)}(a,t)),void 0,void 0,tt)},s.map(((e,n)=>function(a,e,n,s,o){const i=n%2==0?"even":"odd",r=e.name===a,l=null!=s?s:0;return t("li",{key:e.name,"data-player":e.name,className:`list_item tournament-list-item ${i}`+(r?" tournament-me":"")},t("div",{className:"tournamentIdentity"},t("span",{className:"flagRank","data-icon":!0===e.withdraw?"b":""}," ",!0===e.withdraw?"":`${e.rank}.`,"   "),t("span",{className:"playerName"},nt(e),`${e.name} (${e.rating})`),t("span",{className:`playerTeam ttc-${l}`}," ",null!=o?o:""," ")),t("div",{className:"tournamentPoints "+(e.sheet.fire?"on-fire":"off-fire"),"data-icon":"Q"},e.score))}(m,e,n,e.team?a.teamColorMap[e.team]:0,e.team&&d?d.teams[e.team]:"")))),t("div",{className:"navigationButtons"+(s.length<1?" invisible":"")},et("W",!a.isLoadingPage&&l,a.first),et("Y",!a.isLoadingPage&&l,a.prev),t("span",{class:"pageInfo"}," ",i+"-"+r+" / "+e.nbPlayers," "),et("X",!a.isLoadingPage&&c,a.next),et("V",!a.isLoadingPage&&c,a.last),e.me?t("button",{className:"navigationButton tournament-me"+(a.focusOnMe?" activated":""),"data-icon":"7",oncreate:n(a.toggleFocusOnMe)},t("span",null,"Me")):null))}function et(a,e,s){return t("button.navigationButton",{"data-icon":a,oncreate:n(s),disabled:!e})}function nt(a){return null==a.title?null:t("span.userTitle",[a.title,t.trust("&nbsp;")])}function st(a){const e=a.tournament,n=e.featured;return n?t("div",{className:"tournamentGames"},t("div",{className:"tournamentMiniBoard"},t(x,{fixed:!1,fen:n.fen,lastMove:n.lastMove,orientation:n.orientation,link:()=>r.set(`/tournament/${e.id}/game/${n.id}?color=${n.orientation}&goingBack=1`),gameObj:n}))):null}function ot(e){if(!e)return null;const s=e.rank;return t("div",{className:"place"+s},t("div",{className:"trophy"}," "),t("div",{className:"username",oncreate:n((()=>r.set("/@/"+e.name)))},nt(e),e.name),t("div",{className:"rating"}," ",e.rating," "),t("table",{className:"stats"},t("tr",null,t("td",{className:"statName"},a("performance")),t("td",{className:"statData"},e.performance)),t("tr",null,t("td",{className:"statName"},a("gamesPlayed")),t("td",{className:"statData"},e.nb.game)),t("tr",null,t("td",{className:"statName"},a("winRate")),t("td",{className:"statData"},(e.nb.win/e.nb.game*100).toFixed(0)+"%")),t("tr",null,t("td",{className:"statName"},a("berserkRate")),t("td",{className:"statData"},(e.nb.berserk/e.nb.game*100).toFixed(0)+"%"))))}function it(a){const e=a.tournament,s=e.teamBattle,o=e.teamStanding;return s&&o?t("div",{className:"tournamentTeamLeaderboard"},t("ul",{className:"tournamentTeamStandings box",oncreate:n((t=>function(t,a){const e=rt(a).dataset.team;e&&t.teamInfoCtrl.open(e)}(a,t)),void 0,void 0,rt)},o.map(((e,n)=>function(a,e,n,s){if(!a)return null;const o=e||0,i=s%2==0?"even":"odd";return t("li",{key:n.id,"data-team":n.id,className:`list_item tournament-list-item ${i}`},t("div",{className:"tournamentIdentity"},t("span",null," ",n.rank+".","   "),t("span",{className:"ttc-"+o}," ",a," ")),t("div",{className:"tournamentPoints"},n.score))}(s.teams[e.id],a.teamColorMap[e.id],e,n))))):null}function rt(t){const a=t.target;return a.classList.contains("list_item")?a:y(a,".list_item")}class lt{constructor(t){var a,e;this.page=1,this.hasJoined=!1,this.focusOnMe=!1,this.isLoadingPage=!1,this.pagesCache={},this.join=P(((t,a)=>{D(this.tournament.id,t,a).then((()=>{this.hasJoined=!0,this.focusOnMe=!0,h()})).catch((t=>{null!=t.body&&"error"in t.body?N.show({text:t.body.error,duration:"short"}):p(t)}))}),1e3),this.withdraw=P((()=>{L(this.tournament.id).then((()=>{this.hasJoined=!1,this.focusOnMe=!1,h()})).catch(p)}),1e3),this.reload=function(t){let a,e;return function(...n){const s=this,o=()=>{e=void 0,a=t.apply(s,n).then((()=>{a=void 0,e&&e()})).catch((()=>{a=void 0,e&&e()}))};a?e=o:o()}}((a=()=>5e3+Math.floor(1e3*Math.random()),e=()=>W(this.id,this.focusOnMe?void 0:this.page).then(this.onReload).catch(p),function(...t){const n=this;return new Promise((s=>{e.apply(n,t).then((()=>setTimeout(s,a()))).catch((()=>setTimeout(s,a())))}))})),this.loadPage=P((t=>{R(this.id,t).then((t=>{this.isLoadingPage=!1,this.page===t.page?this.loadCurrentPage(t):this.setPageCache(t),h()})).catch((t=>{this.isLoadingPage=!1,p(t)}))}),1e3),this.first=()=>{this.page>1&&this.userSetPage(1)},this.prev=()=>{this.page>1&&this.userSetPage(this.page-1)},this.next=()=>{const t=this.tournament.nbPlayers;this.page<t/10&&this.userSetPage(this.page+1)},this.last=()=>{const t=this.tournament.nbPlayers;this.page<t/10&&this.userSetPage(Math.ceil(t/10))},this.toggleFocusOnMe=()=>{this.tournament.me&&(this.focusOnMe=!this.focusOnMe,this.focusOnMe&&this.scrollToMe(),h())},this.myPage=()=>this.tournament.me?Math.floor((this.tournament.me.rank-1)/10)+1:void 0,this.unload=()=>{this.appStateListener.remove()},this.scrollToMe=()=>{const t=this.myPage();void 0!==t&&t!==this.page&&this.setPage(t)},this.onReload=t=>{const a=this.tournament;!t.featured||a&&a.featured&&t.featured.id===a.featured.id||this.socketIface.send("startWatching",t.featured.id),this.tournament=Object.assign(Object.assign(Object.assign({},this.tournament),t),{me:t.me}),this.setPageCache(t.standing),void 0!==this.pagesCache[this.page]&&(this.currentPageResults=this.pagesCache[this.page]),this.hasJoined=!(!t.me||t.me.withdraw),this.focusOnMe&&this.scrollToMe(),t.socketVersion&&M.setVersion(t.socketVersion),this.teamColorMap=t.teamBattle?this.createTeamColorMap(t.teamBattle):{};const e=t.teamBattle;e&&!e.joinWith.includes(b.tournament.join.lastTeam())&&e.joinWith.length>0&&b.tournament.join.lastTeam(e.joinWith[0]),h()},this.id=t.id,this.faqCtrl=H.controller(this),this.playerInfoCtrl=Q.controller(this),this.teamInfoCtrl=U.controller(this),this.tournament=t,this.startsAt=C(new Date(t.startsAt)),this.page=this.tournament.standing.page,this.loadCurrentPage(this.tournament.standing),this.hasJoined=!(!t.me||t.me.withdraw),this.focusOnMe=function(t){return!(!t.me||t.me.withdraw)}(this.tournament),this.scrollToMe();const n=t.featured?t.featured.id:void 0;var s;this.socketIface=M.createTournament(this.id,this.tournament.socketVersion,{reload:(s=this).reload,resync:s.reload,redirect(t){r.set("/tournament/"+s.tournament.id+"/game/"+t,!0)},fen(t){const a=s.tournament.featured;a&&a.id===t.id&&(a.fen=t.fen,a.lastMove=t.lm,h())},message(t){s.chat&&s.chat.append(t)}},n),t.chat&&(this.chat=new J(this.socketIface,t.id,t.chat.lines,void 0,t.chat.writeable,k.isShadowban(),"Tournament")),this.appStateListener=_.addListener("appStateChange",(t=>{t.isActive&&this.reload()})),this.teamColorMap=t.teamBattle?this.createTeamColorMap(t.teamBattle):{},h()}userSetPage(t){this.isLoadingPage||(this.focusOnMe=!1,this.setPage(t))}setPage(t){this.page=t;const a=this.pagesCache[this.page];a?this.currentPageResults=a:this.isLoadingPage=!0,this.loadPage(t),h()}setPageCache(t){this.pagesCache[t.page]=t.players}loadCurrentPage(t){this.setPageCache(t),this.currentPageResults=t.players}createTeamColorMap(t){return Object.keys(t.teams).reduce(((t,a,e)=>Object.assign(Object.assign({},t),{[a]:e})),{})}}var ct={oninit({attrs:t}){$(t.id).then((t=>{this.ctrl=new lt(t)})).catch((t=>{404===t.status?(this.notFound=!0,h()):p(t)}))},oncreate:B,onremove(){M.destroy(),this.ctrl&&this.ctrl.unload()},view(){if(this.notFound)return S.free(I(null,T(a("tournamentNotFound"))),t("div.tournamentNotFound",[t("p",a("tournamentDoesNotExist")),t("p",a("tournamentMayHaveBeenCanceled"))]));if(!this.ctrl)return S.free(j(),null);const e=this.ctrl.tournament,n=I(null,T(t("div.main_header_title.withSub",[t("h1",[t("span.fa.fa-trophy"),this.ctrl.tournament.fullName]),t("h2.header-subTitle.tournament-subtTitle",e.isFinished||e.isStarted?K(e.secondsToFinish,""):K(e.secondsToStart,"Starting in"))]))),s=function(a){const e=a.tournament;return e?t("div.tournamentContainer.native_scroller.page",{className:(e.podium?"finished ":"")+(e.teamBattle?"teamBattle":"")},[Z(e,a),e.podium&&!e.teamBattle?(n=e.podium,t("div",{className:"podium"},ot(n[1]),ot(n[0]),ot(n[2]))):null,e.teamBattle?it(a):null,at(a),e.featured?st(a):null]):null;var n}(this.ctrl),o=z(this.ctrl),i=[...(r=this.ctrl,[H.view(r.faqCtrl),Q.view(r.playerInfoCtrl),U.view(r.teamInfoCtrl),r.chat?V(r.chat):null]),X.view()].filter(O);var r;return S.free(n,s,o,i)}};export default ct;
