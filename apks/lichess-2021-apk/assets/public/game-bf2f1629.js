import{bi as e,w as t,bj as a,bk as i,bl as n,bm as o,s as r,W as s,aw as c,aH as l,ar as d,a5 as h,m as u,q as g,C as p,a2 as m,b,Y as f,D as v,aF as w,bn as y,r as T,a7 as j,bo as C,bp as I,aG as _,a3 as x,bq as k,br as P,aT as A,ay as N,aA as R,bs as L,bt as O}from"./main.js";import{l as U}from"./layout-c7d0a2f4.js";import{e as B}from"./fen-acee80a0.js";import"./CountdownTimer-265e230d.js";import"./tournamentXhr-b8f81bd7.js";import{n as E,l as F,o as G}from"./game-2ffc1d0e.js";import"./perfs-2bc54d35.js";import"./countries-a19495bf.js";import{v as D,b as H}from"./crazyValid-11f86c1c.js";import"./GameTitle-0505073c.js";import"./Board-c82f4179.js";import"./promotion-a7ec34cc.js";import{S as W}from"./index-6048898c.js";import"./CrazyPocket-cee87a95.js";import"./chat-fb252130.js";import"./replay-4865f30a.js";import{v as S}from"./vibrate-6077ecb6.js";import{O as V}from"./OnlineRound-7cebaa35.js";class Y{constructor(s){this.data=s,this.joinChallenge=()=>{const i=this.challenge;return i?e(i.id).then((e=>{clearTimeout(this.pingTimeoutId),t.set("/game"+e.url.round,!0)})).then((()=>a.remove(i.id))):Promise.reject("no challenge")},this.declineChallenge=()=>{const e=this.challenge;return e?i(e.id).then((()=>{clearTimeout(this.pingTimeoutId),a.remove(e.id)})).then(t.backHistory):Promise.reject("no challenge")},this.cancelChallenge=()=>{const e=this.challenge;return e?n(e.id).then((()=>{clearTimeout(this.pingTimeoutId),a.remove(e.id)})).then(t.backHistory):Promise.reject("no challenge")},this.unload=()=>{clearTimeout(this.pingTimeoutId)},this.reloadChallenge=()=>{const e=this.challenge;e&&o(e.id).then((e=>{switch(this.challenge=e.challenge,e.challenge.status){case"accepted":t.set(`/game/${e.challenge.id}`,!0);break;case"declined":t.backHistory()}}))},this.pingNow=()=>{clearTimeout(this.pingTimeoutId),this.pingTimeoutId=setTimeout(this.pingNow,2e3),this.socket&&this.socket.send("ping")},this.onSocketOpen=()=>{this.reloadChallenge(),this.pingNow()},this.challenge=s.challenge,this.socket=r.createChallenge(s.challenge.id,s.socketVersion,this.onSocketOpen,{reload:this.reloadChallenge})}}class q extends s{async write(e){if("undefined"==typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if(void 0!==e.string)await this.writeText(e.string);else if(e.url)await this.writeText(e.url);else{if(!e.image)throw new Error("Nothing to write");if("undefined"==typeof ClipboardItem)throw this.unavailable("Writing images to the clipboard is not supported in this browser");try{const t=await(await fetch(e.image)).blob(),a=new ClipboardItem({[t.type]:t});await navigator.clipboard.write([a])}catch(e){throw new Error("Failed to write image")}}}async read(){if("undefined"==typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if("undefined"==typeof ClipboardItem)return this.readText();try{const e=await navigator.clipboard.read(),t=e[0].types[0],a=await e[0].getType(t);return{value:await this._getBlobData(a,t),type:t}}catch(e){return this.readText()}}async readText(){if("undefined"==typeof navigator||!navigator.clipboard||!navigator.clipboard.readText)throw this.unavailable("Reading from clipboard not supported in this browser");return{value:await navigator.clipboard.readText(),type:"text/plain"}}async writeText(e){if("undefined"==typeof navigator||!navigator.clipboard||!navigator.clipboard.writeText)throw this.unavailable("Writting to clipboard not supported in this browser");await navigator.clipboard.writeText(e)}_getBlobData(e,t){return new Promise(((a,i)=>{const n=new FileReader;t.includes("image")?n.readAsDataURL(e):n.readAsText(e),n.onloadend=()=>{const e=n.result;a(e)},n.onerror=e=>{i(e)}}))}}const $=c("Clipboard",{web:()=>new q});function z(e){let i,n=D(d,"white");const o=e.challenge,r=l("lichess.org");return o&&(n=D(o.initialFen||d,"white"),"in"===o.direction?i=function(e,a){let i;i=a.rated&&!b.isConnected()?u("div.error",[g("thisGameIsRated"),u("br"),u("br"),g("youNeedAnAccountToDoThat"),u("div.go_or_cancel",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p(f.open)},g("signIn")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(t.backHistory)},g("cancel"))])]):b.isConnected()?u("div.go_or_cancel",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p(e.joinChallenge)},g("join")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(e.declineChallenge)},g("decline"))]):u("div",[u("button[data-icon=E].withIcon",{oncreate:p(e.joinChallenge)},g("join"))]);const n=a.challenger?g("playerisInvitingYou",X(a.challenger)):g("playerisInvitingYou","Anonymous");return h("join_url_challenge",void 0,(function(){return u("div.infos",[u("div.challenger",n),u("br"),M(a),u("br"),i])}),!0)}(e,o):"out"===o.direction&&(i=o.destUser?function(e,i){function n(){return u("div.infos",[u("div",g("waitingForOpponent")),u("br"),u("div.user",X(i.destUser)),M(i),u("br"),v.getVdom(),u("br"),u("br"),u("button.withIcon[data-icon=L]",{oncreate:p(e.cancelChallenge)},g("cancel")),a.isPersistent(i)?u("div",[u("br"),u("button",{oncreate:p((()=>t.set("/")))},[u("span.fa.fa-home"),g("Return to home")])]):null])}return h("await_url_challenge",void 0,n,!0)}(e,o):function(e,i){const n=a.isPersistent(i);return h("await_url_challenge",void 0,(function(){return u("div.infos",[M(i),u("br"),u("p.explanation",g("toInviteSomeoneToPlayGiveThisUrl")),u("div.copy_container",[u("div.icon_container",[u("span.fa.fa-clipboard")]),u("input.lichess_game_url",{oncreate:p((function(){$.write({url:J(i)}),m.show({text:"Copied to clipboard",position:"center",duration:"short"})})),value:J(i),readonly:!0})]),u("p.explanation.small",g("theFirstPersonToComeOnThisUrlWillPlayWithYou")),u("div.go_or_cancel.clearfix",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p((function(){W.share({url:J(i)})}))},g("shareGameUrl")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(e.cancelChallenge)},g("cancel"))]),n?u("div",[u("br"),u("button",{oncreate:p((()=>t.set("/")))},[u("span.fa.fa-home"),g("Return to home")])]):null])}),!0)}(e,o))),U.board(r,n,"challenge",i)}function J(e){return"https://lichess.org/"+e.id}function M(e){const t=e.rated?g("rated"):g("casual"),i=a.challengeTime(e);return u("div",{className:"gameInfos"},u("span",{"data-icon":"p"},i)," • ",u("span",null,e.variant.name)," • ",u("span",null,t))}function X(e){const t=e.rating+(e.provisional?"?":"");return`${e.name} (${t})`}var K={oninit(e){w();const a=performance.now();y(e.attrs.id,e.attrs.color).then((i=>{void 0!==i.challenge?(e.state.challenge=new Y(i),T()):function(e){return void 0!==e.url}(i)&&function(e,a,i){if(i.player.spectator||E(i)){if(F(i)&&0===G(i,i.player.color)){N.dong(),S.quick();const e=R(i.game.variant.key),t=function(e){return"game.variant.prompt."+e}(i.game.variant.key);e.alert&&-1===[1,3].indexOf(e.id)&&!L.get(t)&&O.alert({title:"Alert",message:e.alert}).then((()=>{L.set(t,!0)}))}const t=performance.now()-a;setTimeout((()=>{const t=Number(e.attrs.ply),a=isNaN(t)?void 0:t;e.state.round=new V(!!e.attrs.goingBack,e.attrs.id,i,!1,void 0,void 0,a)}),Math.max(400-t,0)),x.resetLastJoined(),void 0===i.player.user&&L.set("lastPlayedGameURLAsAnon",i.url.round)}else m.show({text:g("unsupportedVariant",i.game.variant.name),position:"center",duration:"short"}),t.set("/")}(e,a,i)})).catch((e=>{j(e),t.set("/")}))},oncreate(e){e.attrs.goingBack?C(e.dom):I(e.dom)},onremove(){_(),r.destroy(),this.round&&this.round.unload(),this.challenge&&this.challenge.unload()},view({attrs:e}){if(this.round)return H(this.round);if(this.challenge)return z(this.challenge);const t=x.lastJoined();let a;if(t)a=D(t.fen,t.color,t.lastMove,t.variant.key);else{const t=k.get(e.id);a=t?D(t.fen,t.orientation):D(B,"white")}return U.board(e.goingBack?P():A(),a)}};export default K;
