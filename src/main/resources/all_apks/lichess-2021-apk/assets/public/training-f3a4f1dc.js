import{a5 as t,w as i,b as e,r as a,k as n,m as s,q as o,C as r,Y as d,aT as h,aH as l,z as c,a2 as u,g as v,bp as p,bU as g,bX as m,bY as f,ay as b,h as z,d as w,a7 as y,a as k,c0 as M,bu as P,aY as S,F as _,cM as j,cN as N,s as B,aF as T,G as C,aG as F,aD as x,ab as O}from"./main.js";import{l as $}from"./layout-c7d0a2f4.js";import{s as V,p as R,a as U,n as G,v as J,g as L,b as Y,c as A,r as I,e as D,d as W}from"./offlineService-13905bf9.js";import{e as q}from"./fen-acee80a0.js";import{B as X}from"./Board-c82f4179.js";import{v as E,p as H}from"./promotion-a7ec34cc.js";import{S as K}from"./index-6048898c.js";import{s as Q,m as Z}from"./chess-3e18520f.js";import{c as tt,s as it,t as et,l as at,m as nt,i as st,b as ot,a as rt,f as dt,u as ht,e as lt,g as ct}from"./tree-aeadfd0f.js";var ut={controller(t){let n=!1,s=null;function o(t){"backbutton"!==t&&n&&i.backbutton.stack.pop(),n=!1}return{open:function(){i.backbutton.stack.push(o),n=!0;const r=e.get();r&&t.database.fetch(r.id).then((t=>{t&&(s={username:r.username,data:t.user},a())}))},close:o,isOpen:()=>n,user:()=>s,root:t}},view:i=>t("trainingMenu",void 0,(()=>function(t){const i=t.user();return t.root.data&&t.root.data.user&&n()?vt(t.root.data.user):null!==i&&n()?vt(i.data):null!==i?function(t,i){const e=t.data.rating;return s("div.training-offlineInfos",[s("p",["You are currently offline. Your last recorded rating as ",s("strong",t.username)," is ",s("strong",e),"."]),s("p","You still have ",s("strong",i.root.nbUnsolved)," saved puzzles to solve."),s("p","Puzzles are automatically downloaded by batches so you can solve them seamlessly while having bad network conditions or when you are offline."),s("p","Your puzzle history and rating will be updated as soon as you are back online.")])}(i,t):s("div.trainingMenuContent",[s("p",o("toTrackYourProgress")),s("p.signin",s("button.defaultButton",{oncreate:r(d.open)},[s("span.fa.fa-user"),o("signIn")]))])}(i)),i.isOpen(),i.close)};function vt(t){const i=t.rating;return[s("p.trainingRatingHeader",s.trust(o("xRating",`<strong>${i}</strong>`)))]}function pt(t){return s("section#training_actions.actions_bar",[s("button.action_bar_button.training_action.fa.fa-area-chart",{oncreate:r(t.menu.open)}),s("button.action_bar_button.training_action.fa.fa-share-alt",{oncreate:r(t.share,(()=>u.show({text:"Share this puzzle",duration:"short",position:"bottom"})))}),s("button.action_bar_button.training_action[data-icon=A]",{oncreate:r(t.goToAnalysis,(()=>u.show({text:o("analysis"),duration:"short",position:"bottom"}))),disabled:"view"!==t.vm.mode}),e.isConnected()?s("button.action_bar_button.training_action.fa.fa-refresh",{oncreate:r(t.resync,(()=>u.show({text:"Sync and refresh saved puzzles",duration:"short",position:"bottom"})))}):null,s("button.action_bar_button.training_action.fa.fa-backward",{oncreate:r(t.rewind,void 0,t.rewind),disabled:!t.canGoBackward()}),s("button.action_bar_button.training_action.fa.fa-forward",{oncreate:r(t.fastforward,void 0,t.fastforward),disabled:!t.canGoForward()})])}function gt(t){return[s("button.li-button.training-control.retry",{oncreate:r(t.retry),className:t.vm.loading?"disabled":""},[s("span.fa.fa-refresh"),s("span",o("retry"))]),s("button.li-button.training-control.continue",{oncreate:r(t.newPuzzle),className:t.vm.loading?"disabled":""},[s("span.fa.fa-play"),s("span",o("continueTraining"))])]}function mt(t){switch(t.vm.lastFeedback){case"init":return s("div.training-explanation",[s("div.player",[s("div.piece-no-square",{className:v.general.theme.piece()},s("piece.king."+t.data.puzzle.color)),s("div.training-instruction",[s("strong",o("yourTurn")),s("p",o("white"===t.data.puzzle.color?"findTheBestMoveForWhite":"findTheBestMoveForBlack"))])]),ft(t)]);case"retry":return s("div.training-explanation",[s("div.player",[s("div.training-icon","!"),s("div.training-instruction",[s("strong",o("goodMove")),s("span","But you can do better")])]),ft(t)]);case"good":return s("div.training-explanation",[s("div.player",[s("div.training-icon.win","✓"),s("div.training-instruction",[s("strong",o("bestMove")),s("span",o("keepGoing"))])]),ft(t)]);case"fail":return s("div.training-explanation",[s("div.player",[s("div.training-icon.loss","✗"),s("div.training-instruction",[s("strong",o("notTheMove")),s("span",o("trySomethingElse"))])]),ft(t)])}}function ft(t){return t.vm.canViewSolution?s("button.fatButton",{oncreate:i=>{p(i.dom,1500,"0","0.8"),r(t.viewSolution)(i)}},o("viewTheSolution")):s("div.buttonPlaceholder","")}function bt(t){return[s("div.buttons",[s("span.fa.fa-caret-up",{oncreate:r(t.upvote),className:!0===t.vm.voted?"voted":""}),s("span.fa.fa-caret-down",{oncreate:r(t.downvote),className:!1===t.vm.voted?"voted":""})])]}function zt(t){return"win"===t.vm.lastFeedback?[s("div.training-half",[s("div.training-icon.win","✓"),s("strong",[o("puzzleSuccess")]),e.isConnected()?s("div.training-vote",bt(t)):null]),s("div.training-half",gt(t))]:[s("div.training-half",[s("strong",o("puzzleComplete")),e.isConnected()?s("div.training-vote",bt(t)):null]),s("div.training-half",gt(t))]}function wt(t){return"string"==typeof t}class yt{constructor(t,s){this.promoting=null,this.player=()=>this.data.puzzle.color,this.viewSolution=()=>{if(!this.vm.canViewSolution)return;this.sendResult(!1),this.vm.mode="view",this.mergeSolution(this.data.puzzle.branch,this.data.puzzle.color);const t=this.node.children[0];if(t&&"good"===t.puzzle)this.userJump(this.path+t.id,!0);else{const t=et(this.mainline,(t=>"good"!==t.puzzle));t&&this.userJump(t+this.tree.nodeAtPath(t).children[0].id,!0)}a()},this.setPath=t=>{this.path=t,this.nodeList=this.tree.getNodeList(t),this.node=at(this.nodeList),this.mainline=nt(this.tree.root)},this.jump=(t,i=!1)=>{const e=t!==this.path;this.setPath(t),this.updateBoard(),e&&i&&(this.node.san&&-1!==this.node.san.indexOf("x")?b.throttledCapture():b.throttledMove()),H.cancel(this)},this.userJump=(t,i)=>{this.jump(t,i)},this.canGoForward=()=>!this.vm.initializing&&this.node.children.length>0,this.fastforward=()=>{if(0===this.node.children.length)return!1;const t=this.node.children[0];return this.userJump(this.path+t.id,!0),!0},this.canGoBackward=()=>!this.vm.moveValidationPending&&""!==this.path,this.resync=()=>{const t=e.get();if(n()&&t){if(this.vm.loading)return;this.vm.loading=!0,a();const i=t=>{this.vm.loading=!1,this.init(t),a()};V(this.database,t).then(i).catch((t=>{this.vm.loading=!1,a(),R(t)}))}},this.rewind=()=>!!this.canGoBackward()&&(this.userJump(st(this.path),!1),!0),this.newPuzzle=()=>{if(this.vm.loading)return;this.vm.loading=!0,a();const t=t=>{this.vm.loading=!1,this.init(t),a()},i=e.get();i?U(this.database,i).then(t).catch((t=>{this.vm.loading=!1,a(),R(t)})):G().then(t).catch(this.onXhrError)},this.retry=()=>{this.vm.loading||this.init(this.initialData)},this.upvote=()=>{this.vote(!0)},this.downvote=()=>{this.vote(!1)},this.vote=z((t=>{this.vm.voted=t,J(this.data.puzzle.id,t).then(a)}),1e3),this.share=()=>{K.share({url:`https://lichess.org/training/${this.data.puzzle.id}`})},this.goToAnalysis=()=>{const t=this.data.puzzle;n()?i.set(`/analyse/online/${t.gameId}/${t.color}?ply=${t.initialPly}&curFen=${this.initialNode.fen}&color=${t.color}&fallback=1`):i.set(`/analyse/variant/standard/fen/${encodeURIComponent(this.initialNode.fen)}?color=${t.color}&goBack=1`)},this.getNodeSituation=w((()=>{this.node&&!this.node.dests&&Q({variant:this.data.game.variant.key,fen:this.node.fen,path:this.path}).then((({situation:t,path:i})=>{this.tree.updateAt(i,(i=>{i.dests=t.dests,i.end=t.end,i.player=t.player})),i===this.path&&(this.updateBoard(),a())})).catch((t=>{}))}),50),this.sendMove=(t,i,e)=>{const a={orig:t,dest:i,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path,pgnMoves:this.node.pgnMoves};e&&(a.promotion=e),this.sendMoveRequest(a,!0)},this.sendMoveRequest=(t,i=!1)=>{Z(t).then((({situation:t,path:e})=>{const n={id:t.id,ply:t.ply,fen:t.fen,uci:t.uci,children:[],dests:t.dests,check:t.check,end:t.end,player:t.player,san:t.san,pgnMoves:t.pgnMoves};if(void 0===e)return;const s=this.tree.addNode(n,e);if(!s)return;i&&(this.vm.moveValidationPending=!0),this.jump(s,!i),a();if((this.node.ply%2==1?"white":"black")===this.data.puzzle.color){const t=function(t,i,e,a,n,s){var o;if("view"===t)return null;if(!tt(e,a))return null;const r=n.slice(it(a)+1).map((t=>({uci:t.uci,castle:t.san.startsWith("O-O")}))).reduce(((t,i)=>{if(t)return wt(t)?t:t[i.uci]||i.castle&&t[g[i.uci]]}),s.lines);if(null===(o=i.san)||void 0===o?void 0:o.endsWith("#")){const t="win";return i.puzzle=t,t}if(r){if(wt(r))return i.puzzle=r,r;{const t=Object.keys(r)[0];if("win"===r[t])return i.puzzle="win","win";{i.puzzle="good";const a=m(t),n=a[2]?f[a[2].toUpperCase()]:null,s={variant:"standard",orig:a[0],dest:a[1],fen:i.fen,path:e};return n&&(s.promotion=n),s}}}{const t="fail";return i.puzzle=t,t}}(this.vm.mode,this.node,this.path,this.initialPath,this.nodeList,this.data.puzzle);t&&this.applyProgress(t)}})).catch((t=>{}))},this.userMove=(t,i,e)=>{e?b.capture():b.move(),H.start(this,t,i,this.sendMove)||this.sendMove(t,i)},this.revertUserMove=t=>{setTimeout((()=>{this.vm.moveValidationPending=!1,this.userJump(st(t),!1),this.tree.deleteNodeAt(t),a()}),500)},this.applyProgress=t=>{"fail"===t?(this.vm.lastFeedback="fail",this.revertUserMove(this.path),"play"===this.vm.mode&&(this.vm.canViewSolution=!0,this.vm.mode="try",this.sendResult(!1))):"retry"===t?(this.vm.lastFeedback="retry",this.revertUserMove(this.path)):"win"===t?(this.vm.moveValidationPending=!1,"view"!==this.vm.mode&&("play"===this.vm.mode&&this.sendResult(!0),this.vm.lastFeedback="win",this.vm.mode="view")):void 0!==t.variant&&(this.vm.moveValidationPending=!1,this.vm.lastFeedback="good",setTimeout((()=>{this.sendMoveRequest(t)}),500))},this.sendResult=t=>{if(this.vm.resultSent)return;this.vm.resultSent=!0;const i=e.get(),s={id:this.data.puzzle.id,win:t},o=()=>{I(s).then((t=>{this.vm.voted=t.voted,this.data.user=t.user,a()})).catch((t=>{n()&&y(t),this.vm.resultSent=!1}))};i?L(this.database,i).then((t=>{t.find((t=>t.puzzle.id===this.data.puzzle.id))?Y(this.database,i,s).then((t=>{t&&t.user&&(this.data.user=t.user,a())})):o()})):o()},this.onXhrError=t=>{this.vm.loading=!1,a(),y(t)},this.menu=ut.controller(this),this.database=s,this.init(t),k.afterLogin.add(this.retry)}init(t){this.initialData=t,i.History.replaceState({puzzleId:t.puzzle.id},`/training/${t.puzzle.id}`),this.vm={mode:"play",initializing:!0,lastFeedback:"init",moveValidationPending:!1,loading:!1,canViewSolution:!1,resultSent:!1,voted:null};const n=e.get();n&&A(this.database,n).then((t=>{this.nbUnsolved=t,a()}));const s=JSON.parse(JSON.stringify(t)),o=Object.assign(Object.assign({},s.game),{variant:{key:"standard"}}),r=Object.assign(Object.assign({},s),{game:o});this.data=r,this.tree=ot(rt([{fen:this.data.puzzle.fen,ply:this.data.puzzle.initialPly-1,id:""},this.data.game.treeParts])),this.initialPath=dt(nt(this.tree.root)),this.initialNode=this.tree.nodeAtPath(this.initialPath),this.setPath(st(this.initialPath)),this.updateBoard(),setTimeout((()=>{this.jump(this.initialPath,!0),this.vm.initializing=!1}),1e3),setTimeout((()=>{this.vm.canViewSolution=!0,a()}),5e3),a()}updateBoard(){var t;const i=this.node,e=i.ply%2==0?"white":"black",a=M(i.dests),n={fen:i.fen,turnColor:e,orientation:this.data.puzzle.color,movableColor:this.gameOver()?null:this.data.puzzle.color,dests:a||null,check:!(!i.check&&!(null===(t=i.san)||void 0===t?void 0:t.endsWith("+"))),lastMove:i.uci?P(i.uci):null};this.chessground?this.chessground.set(n):this.chessground=new S(function(t,i){const e=v.game.pieceMove();return{fen:t.data.puzzle.fen,orientation:t.data.puzzle.color,coordinates:v.game.coords(),turnColor:t.node.ply%2==0?"white":"black",highlight:{lastMove:v.game.highlights(),check:v.game.highlights()},movable:{free:!1,color:t.data.puzzle.color,showDests:v.game.pieceDestinations(),rookCastle:1===v.game.rookCastle()},events:{move:i},animation:{enabled:!0,duration:300},premovable:{enabled:!1},draggable:{enabled:"drag"===e||"both"===e,distance:3,magnified:v.game.magnified()},selectable:{enabled:"tap"===e||"both"===e}}}(this,this.userMove)),a||this.getNodeSituation()}gameOver(){return!!this.node&&("view"===this.vm.mode||!!this.node.end)}mergeSolution(t,i){ht(t,(t=>{"white"===i==(t.ply%2==1)&&(t.puzzle="good")}));const e=lt(this.initialNode,t.id);e?ct(e,t):this.initialNode.children.push(t)}}const kt={};var Mt={oninit({attrs:t}){var i;const n=()=>{const t=e.get();t?U(W,t).catch(G).then((t=>{this.ctrl=new yt(t,W),kt.ctrl=this.ctrl})).catch(R):G().then((t=>{this.ctrl=new yt(t,W),kt.ctrl=this.ctrl})).catch(y)},s=null!==(i=_(t.id))&&void 0!==i?i:j(t.id);void 0!==s?kt.ctrl&&window.history.state.puzzleId===s?(this.ctrl=kt.ctrl,a()):D(s).then((t=>{this.ctrl=new yt(t,W),kt.ctrl=this.ctrl})).catch((t=>{404===t.status?(N.LiToast.show({text:"Puzzle not found.",duration:"short"}),n()):y(t)})):n(),B.createDefault(),T()},oncreate:C,onremove(){this.ctrl&&k.afterLogin.remove(this.ctrl.retry),F()},view({attrs:t}){const i=x()?"o-portrait":"o-landscape";return this.ctrl?$.board(function(t){const i=v.training.puzzleBufferLen;return t.vm.loading?h():l(s("div.main_header_title.withSub",[s("h1",o("puzzleId",t.data.puzzle.id)),s("h2.header-subTitle",[o("rating")," "+("view"===t.vm.mode?t.data.puzzle.rating:"?")," • ",c("playedXTimes",t.data.puzzle.attempts)].concat(n()?[]:[" • ",s("span.fa.fa-database"),`${t.nbUnsolved}/${i}`]))]))}(this.ctrl),function(t,i){const e=s(X,{variant:t.data.game.variant.key,chessground:t.chessground});return s.fragment({key:i},[e,s("div.table.training-tableWrapper",[s("div.training-table.native_scroller.box","view"===t.vm.mode?zt(t):mt(t)),pt(t)])])}(this.ctrl,i),void 0,(e=this.ctrl,[E(e),ut.view(e.menu)])):$.board(h(),[s("section.board_wrapper",[s(O,{fen:t.initFen||q,orientation:t.initColor||"white"})]),s("div.table.training-tableWrapper")],void 0);var e}};export default Mt;
