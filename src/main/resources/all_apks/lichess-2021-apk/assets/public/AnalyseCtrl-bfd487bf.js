import{f as e,b6 as t,a5 as n,m as a,C as s,q as i,D as o,w as r,r as l,a7 as c,b as d,g as u,bB as h,bC as p,aB as m,a8 as v,bD as f,bc as g,bE as y,bF as b,bG as w,bH as k,bI as x,bJ as M,bK as C,bL as N,a2 as P,a9 as S,bM as T,S as _,E as O,o as I,ag as E,bN as A,ah as B,z as G,aZ as z,ap as D,aL as j,ba as U,bO as $,aI as F,aQ as W,aC as L,bf as R,bg as q,bu as V,be as H,bP as J,bQ as X,bR as Y,bS as K,br as Q,ab as Z,bT as ee,B as te,I as ne,bb as ae,b3 as se,bU as ie,b7 as oe,d as re,aY as le,aX as ce,bV as de,bW as ue,s as he,k as pe,ay as me,bx as ve,bX as fe,bY as ge,bZ as ye,n as be,b_ as we,b$ as ke,bt as xe,c0 as Me}from"./main.js";import{l as Ce}from"./layout-c7d0a2f4.js";import{e as Ne,c as Pe}from"./fen-acee80a0.js";import{T as Se,a as Te}from"./TabView-c796731e.js";import{y as _e,p as Oe,z as Ie,A as Ee,B as Ae,C as Be,D as Ge,E as ze,F as De,k as je,g as Ue,G as $e,H as Fe,I as We,b as Le,J as Re,K as qe,L as Ve,M as He}from"./game-2ffc1d0e.js";import{B as Je}from"./Board-c82f4179.js";import{v as Xe,p as Ye}from"./promotion-a7ec34cc.js";import{S as Ke}from"./index-6048898c.js";import{g as Qe,C as Ze,n as et,N as tt}from"./CrazyPocket-cee87a95.js";import{c as nt,C as at}from"./chat-fb252130.js";import{p as st,m as it,d as ot,s as rt}from"./chess-3e18520f.js";import{v as lt}from"./vibrate-6077ecb6.js";import{k as ct,q as dt,r as ut,b as ht,a as pt,s as mt,c as vt}from"./variant-f03d7948.js";import{s as ft,a as gt}from"./studyXhr-6378d14d.js";import{l as yt}from"./html-1975aa10.js";import{c as bt,h as wt,i as kt,l as xt,m as Mt,r as Ct,b as Nt,a as Pt,f as St,t as Tt,d as _t,w as Ot}from"./tree-aeadfd0f.js";import{c as It,l as Et,x as At,y as Bt,a as Gt,p as zt,s as Dt,b as jt,d as Ut}from"./axis-5bab4d8c.js";function $t(t,n){return e(`/${t}/${n}/analysis`)}function Ft(e){return void 0!==e.url}var Wt={controller(e){let t=!1;function n(e){"backbutton"!==e&&t&&r.backbutton.stack.pop(),t=!1,a.showShareMenu=!1}const a={showShareMenu:!1,computingPGN:!1,computingPGNAnnotated:!1};return{open:function(){r.backbutton.stack.push(n),t=!0},close:n,isOpen:()=>t,root:e,s:a}},view:e=>n("analyse_menu",void 0,(()=>e.s.showShareMenu?function(e){return a("div.analyseMenu",a.fragment({key:"shareMenu"},[Ft(e.data)?a("button",{oncreate:s((()=>{e.menu.close(),Ke.share({url:_e(e.data)})}))},[i("shareGameUrl")]):null,"offline"===e.source?a("button",{oncreate:s((()=>{!function(e){if(!e.menu.s.computingPGN){e.menu.s.computingPGN=!0;const t=e.tree.lastNode(),n="white"===e.data.player.color?"offline_ai"===e.data.game.id?d.appUser("Anonymous"):"Anonymous":"offline_ai"===e.data.game.id?e.data.opponent.username:"Anonymous",a="black"===e.data.player.color?"offline_ai"===e.data.game.id?d.appUser("Anonymous"):"Anonymous":"offline_ai"===e.data.game.id?e.data.opponent.username:"Anonymous";st({variant:e.data.game.variant.key,initialFen:e.data.game.initialFen,pgnMoves:t.pgnMoves||[],white:n,black:a}).then((t=>{e.menu.s.computingPGN=!1,e.menu.close(),l(),Ke.share({text:t.pgn})})).catch((t=>{e.menu.s.computingPGN=!1,l()}))}}(e)}))},e.menu.s.computingPGN?o.getVdom("monochrome"):[i("sharePgn")]):null,"online"!==e.source||Oe(e.data)?null:a("button",{oncreate:s((()=>{Lt(e,!1)}))},e.menu.s.computingPGNAnnotated?o.getVdom("monochrome"):"Share annotated PGN"),"online"!==e.source||Oe(e.data)?null:a("button",{oncreate:s((()=>{Lt(e,!0)}))},e.menu.s.computingPGN?o.getVdom("monochrome"):"Share raw PGN"),Ft(e.data)?a("button",{oncreate:s((()=>{e.menu.close(),Ke.share({url:Ie(e.data)})}))},["Share game GIF"]):null,e.isOfflineOrNotPlayable()?a("button",{oncreate:s((()=>{e.menu.close(),Ke.share({text:e.node.fen})}))},"Share current FEN"):null]))}(e.root):function(e){return a("div.analyseMenu",a.fragment({key:"analyseMenu"},[a("button",{oncreate:s((()=>{e.menu.s.showShareMenu=!0}))},[a("span.fa.fa-share"),i("shareAndExport")]),e.isOfflineOrNotPlayable()?a("button[data-icon=U]",{oncreate:s((()=>{e.menu.close(),e.continuePopup.open(e.node.fen,e.data.game.variant.key,e.data.player.color)}))},i("continueFromHere")):null,e.isOfflineOrNotPlayable()?a("button",{oncreate:s((()=>r.set(`/editor/${encodeURIComponent(e.node.fen)}`)))},[a("span.fa.fa-pencil"),i("boardEditor")]):null,e.data.analysis?a("button",{oncreate:s((()=>{e.menu.close(),e.toggleRetro()})),disabled:!!e.retro},[a("span.fa.fa-play"),i("learnFromYourMistakes")]):null,e.ceval.allowed?a("button",{oncreate:s((()=>{e.menu.close(),e.togglePractice()}))},[a("span.fa.fa-bullseye"),i("practiceWithComputer")]):null,e.notes?a("button",{oncreate:s((()=>{e.notes&&(e.menu.close(),e.notes.open())}))},[a("span.fa.fa-pencil"),i("notes")]):null]))}(e.root)),e.isOpen(),e.close)};function Lt(e,t){(t&&!e.menu.s.computingPGN||!t&&!e.menu.s.computingPGNAnnotated)&&(t?e.menu.s.computingPGN=!0:e.menu.s.computingPGNAnnotated=!0,Qe(e.data.game.id,t).then((t=>{e.menu.s.computingPGN=!1,e.menu.s.computingPGNAnnotated=!1,e.menu.close(),l(),Ke.share({text:t})})).catch((t=>{e.menu.s.computingPGN=!1,e.menu.s.computingPGNAnnotated=!1,l(),c(t)})))}function Rt(e){(function(){const e="light"===u.general.theme.background()?"shepherd-theme-dark":"shepherd-theme-default";return h(`vendor/shepherd/css/${e}.css`).then((()=>h("vendor/shepherd/css/shepherd.css"))).then((()=>p("vendor/shepherd/js/tether.js"))).then((()=>p("vendor/shepherd/js/shepherd.min.js"))).then((()=>e))})().then((t=>{const n=new window.Shepherd.Tour({defaults:{classes:"shepherd-element "+t,showCancelLink:!0}});n.addStep("welcome",{title:"Welcome to lichess study!",text:"This is a shared analysis board.<br><br>Use it to analyse games,<br>discuss positions with friends,<br>and of course for chess lessons!"}),n.addStep("members",{title:"Study members",text:"<i data-icon='v'></i> Spectators can view the study and talk in the chat.<br><br><i class='fa fa-user'></i> Contributors can make moves and update the study.<br><br>Studies are for now read-only in the application, so you must go to lichess.org to contribute to them. More features will come later in lichess app.",when:{"before-show":()=>{e.sideMenu.open()}}}),n.addStep("chapters",{title:"Study chapters",text:"A study can contain several chapters.<br>Each chapter has a distinct initial position and move tree.",when:{"before-show":()=>{e.sideMenu.open()}},buttons:[{text:"Done",action:n.next}]}),n.start()}))}var qt={controller(e){let t=!1;const n={showShareMenu:!1,loadingStudyPGN:!1,loadingChapterPGN:!1};function a(e){"backbutton"!==e&&t&&r.backbutton.stack.pop(),t=!1,n.showShareMenu=!1}return{open:function(){r.backbutton.stack.push(a),t=!0},close:a,isOpen:()=>t,root:e,s:n}},view:e=>n("analyse_menu",void 0,(()=>e.s.showShareMenu?function(e){function t(t){e.study.actionMenu.s.loadingChapterPGN=!1,e.study.actionMenu.s.loadingStudyPGN=!1,l(),Ke.share({text:t})}function n(t){e.study.actionMenu.s.loadingChapterPGN=!1,e.study.actionMenu.s.loadingStudyPGN=!1,l(),c(t)}return a("div.analyseMenu",{key:"shareMenu"},[a("button",{oncreate:s((()=>{const t=`https://lichess.org/study/${e.study.data.id}`;Ke.share({url:t})}))},[i("studyUrl")]),a("button",{oncreate:s((()=>{const t=`https://lichess.org/study/${e.study.data.id}/${e.study.data.chapter.id}`;Ke.share({url:t})}))},[i("currentChapterUrl")]),a("button",{oncreate:s((()=>{e.study.actionMenu.s.loadingStudyPGN=!0,ft(e.study.data.id).then(t).catch(n)}))},e.study.actionMenu.s.loadingStudyPGN?o.getVdom("monochrome"):[i("studyPgn")]),a("button",{oncreate:s((()=>{e.study.actionMenu.s.loadingChapterPGN=!0,gt(e.study.data.id,e.study.data.chapter.id).then(t).catch(n)}))},e.study.actionMenu.s.loadingChapterPGN?o.getVdom("monochrome"):[i("chapterPgn")])])}(e.root):function(e){return a("div.analyseMenu",{key:"studyMenu"},[a("button",{oncreate:s((()=>{e.study.actionMenu.s.showShareMenu=!0}))},[a("span.fa.fa-share"),i("shareAndExport")]),a("button",{oncreate:s(e.study.toggleLike)},[a.trust("&nbsp;"),a("span.fa",{className:e.study.data.liked?"fa-heart":"fa-heart-o"}),`Like (${e.study.data.likes})`]),e.study&&e.study.chat?a("button[data-icon=B]",{oncreate:s(e.settings.flip)},i("flipBoard")):null,a("button[data-icon=U]",{oncreate:s((()=>{e.menu.close(),e.continuePopup.open(e.node.fen,e.data.game.variant.key,e.data.player.color)}))},i("continueFromHere")),e.ceval.allowed?a("button",{oncreate:s((()=>{e.menu.close(),e.togglePractice()}))},[a("span.fa.fa-bullseye"),i("practiceWithComputer")]):null,a("button",{oncreate:s((()=>r.set(`/editor/${encodeURIComponent(e.node.fen)}`)))},[a("span.fa.fa-pencil"),i("boardEditor")]),a("button",{oncreate:s((()=>{e.study.actionMenu.close(),Rt(e.study)}))},[a("span.fa.fa-question-circle"),"Help"])])}(e.root)),e.isOpen(),e.close)};var Vt={controller(e){let t=!1,n=u.analyse.cevalCores(),a=u.analyse.cevalHashSize(),s=u.analyse.cevalUseNNUE();function i(e){"backbutton"!==e&&t&&r.backbutton.stack.pop(),t=!1,u.analyse.cevalCores()===n&&u.analyse.cevalHashSize()===a&&u.analyse.cevalUseNNUE()===s||r.reload()}const o={smallBoard:u.analyse.smallBoard(),showBestMove:u.analyse.showBestMove(),showComments:u.analyse.showComments(),flip:!1};return{root:e,open:function(){r.backbutton.stack.push(i),n=u.analyse.cevalCores(),a=u.analyse.cevalHashSize(),s=u.analyse.cevalUseNNUE(),t=!0},close:i,isOpen:()=>t,s:o,toggleBoardSize(){const e=!o.smallBoard;u.analyse.smallBoard(e),o.smallBoard=e},toggleBestMove(){const e=!o.showBestMove;o.showBestMove=e},toggleComments(){const e=!o.showComments;o.showComments=e},flip(){o.flip=!o.flip,e.chessground.set({orientation:o.flip?m(e.orientation):e.orientation}),e.retro&&e.toggleRetro(),e.practice&&e.restartPractice()},cevalSetMultiPv(t){u.analyse.cevalMultiPvs(t),e.ceval.setMultiPv(t)},cevalToggleInfinite(){e.ceval.toggleInfinite()}}},view:e=>n("analyse_menu",void 0,(()=>function(e){const t=g(),n=window.deviceInfo.stockfishMaxMemory;return a("div.analyseSettings",[a("div.action",{className:!e.ceval.allowed||e.retro?"disabled":""},[v.renderCheckbox(i("toggleLocalEvaluation"),"allowCeval",u.analyse.enableCeval,(t=>{e.ceval.toggle(),t?e.initCeval():(e.ceval.destroy(),e.resetTabs(),e.retro&&(e.retro.close(),e.retro=null))}),!e.ceval.allowed||!!e.retro),a("small.caution",i("localEvalCaution"))]),e.study||e.ceval.allowed?a("div.action",[v.renderCheckbox(i("bestMoveArrow"),"showBestMove",u.analyse.showBestMove,e.settings.toggleBestMove)]):null,e.study||"online"===e.source&&Ft(e.data)&&Ee(e.data)?a("div.action",[v.renderCheckbox(i("keyShowOrHideComments"),"showComments",u.analyse.showComments,e.settings.toggleComments)]):null,a("div.action",[v.renderCheckbox(i("infiniteAnalysis"),"ceval.infinite",u.analyse.cevalInfinite,e.settings.cevalToggleInfinite,!e.ceval.allowed)]),f()?a("div.action",[v.renderCheckbox(i("Use NNUE"),"ceval.useNNUE",u.analyse.cevalUseNNUE,void 0,!e.ceval.allowed)]):null,a("div.action",[v.renderSlider(i("multipleLines"),"ceval.multipv",1,5,1,u.analyse.cevalMultiPvs,e.settings.cevalSetMultiPv,!e.ceval.allowed)]),t>1?a("div.action",[v.renderSlider(i("cpus"),"ceval.cores",1,t,1,u.analyse.cevalCores,void 0,!e.ceval.allowed)]):null,n>32?a("div.action",[v.renderSlider(i("memory"),"ceval.hashSize",16,n,16,u.analyse.cevalHashSize,void 0,!e.ceval.allowed)]):null])}(e.root)),e.isOpen(),e.close)};function Ht(e,t){let n="";if(y(t))"pawn"!==t.role&&(n=b(t.role).toUpperCase()),n+="@"+w(t.to);else{const a=e.board.getRole(t.from);if(!a)return"--";if("king"!==a||!e.board[e.turn].has(t.to)&&2!==Math.abs(t.to-t.from)){const s=e.board.occupied.has(t.to)||"pawn"===a&&k(t.from)!==k(t.to);if("pawn"!==a){let s;if(n=b(a).toUpperCase(),s="king"===a?ct(t.to).intersect(e.board.king):"queen"===a?dt(t.to,e.board.occupied).intersect(e.board.queen):"rook"===a?ut(t.to,e.board.occupied).intersect(e.board.rook):"bishop"===a?ht(t.to,e.board.occupied).intersect(e.board.bishop):pt(t.to).intersect(e.board.knight),s=s.intersect(e.board[e.turn]).without(t.from),s.nonEmpty()){const a=e.ctx();for(const n of s)e.dests(n,a).has(t.to)||(s=s.without(n));if(s.nonEmpty()){let e=!1,a=s.intersects(x.fromRank(M(t.from)));s.intersects(x.fromFile(k(t.from)))?e=!0:a=!0,a&&(n+=C[k(t.from)]),e&&(n+=N[M(t.from)])}}}else s&&(n=C[k(t.from)]);s&&(n+="x"),n+=w(t.to),t.promotion&&(n+="="+b(t.promotion).toUpperCase())}else n=t.to>t.from?"O-O":"O-O-O"}return n}function Jt(e,t){return function(e,t){var n;const a=Ht(e,t);return e.play(t),(null===(n=e.outcome())||void 0===n?void 0:n.winner)?a+"#":e.isCheck()?a+"+":a}(e.clone(),t)}function Xt(e){switch(e){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return e}}function Yt(e){const t=e.node.ceval,n=u.analyse.cevalInfinite();return t?a("div.analyse-fixedBar.ceval-infos",{className:t.cloud?"cloud":""},[a("div.depth",[a("span",i("depthX",t.depth+(n||void 0===t.maxDepth?"":`/${t.maxDepth}`))),e.ceval.canGoDeeper()?a("button.fa.fa-plus-square",{oncreate:s(e.ceval.goDeeper,(()=>{P.show({text:i("goDeeper"),position:"center",duration:"short"})}))}):null]),void 0!==t.millis?a("div.time",[i("time")," ",Kt(t.millis)]):null,void 0!==t.knps?a("div.knps",["kn/s ",Math.round(t.knps)]):null,t.cloud?a("span.ceval-cloud","Cloud"):null]):null}function Kt(e){const t=Math.round(e/1e3);if(t<60)return t+"s";return`${Math.round(t/60)}min ${t%60}s`}function Qt(e){const t=e.ceval.getMultiPv(),n=e.node;if(n.ceval&&!e.gameOver()){const s=n.ceval.pvs;return a("ul.ceval-pv_box.native_scroller",{oncreate:_((t=>function(e,t){const n=O(t),a=n&&n.dataset.uci;a&&e.playUci(a)}(e,t)),void 0,O)},[...Array(t).keys()].map((t=>{if(!s[t])return a("li.pv");const i=mt(Xt(e.ceval.variant),S(n.fen).unwrap());return a("li.ceval-pv",{"data-uci":s[t].moves[0],className:t%2==0?"even":"odd"},[a("strong.ceval-pv_eval",void 0!==s[t].mate?"#"+s[t].mate:Ae(s[t].cp)),a("div.ceval-pv-line",i.unwrap((e=>function(e,t){var n;e=e.clone();const a=[];for(let s=0;s<t.length;s++){0!==s&&a.push(" "),"white"===e.turn?a.push(e.fullmoves,". "):0===s&&a.push(e.fullmoves,"... ");const i=Ht(e,t[s]);if(e.play(t[s]),a.push(i),"--"===i)return a.join("");s===t.length-1&&(null===(n=e.outcome())||void 0===n?void 0:n.winner)?a.push("#"):e.isCheck()&&a.push("+")}return a.join("")}(e,s[t].moves.slice(0,12).map((e=>T(e))))),(e=>"--")))])})))}return e.gameOver()?a("div.ceval-pv_box.native_scroller.loading.gameOver",[a("i.withIcon[data-icon=]"),i("gameOver")]):a("div.ceval-pv_box.native_scroller.loading",en())}const Zt={onbeforeupdate:({attrs:e})=>!e.ctrl.replaying,view({attrs:e}){const{ctrl:t}=e,n=t.node,{ceval:s}=n,i=n.eval||s;if(!t.ceval.enabled()&&!i)return null;let o;return o=i&&(void 0===i.depth||i.depth>=t.ceval.minDepth)&&void 0!==i.cp?Ae(i.cp):i&&void 0!==i.mate?"#"+i.mate:t.gameOver()?"-":t.replaying?"":en(),a("div",{className:"ceval-curEval"},o)}};function en(){return a("div.spinner.fa.fa-hourglass-half")}var tn={controller(e,t){const n=["lichess"];"standard"!==e.key&&"fromPosition"!==e.key||n.push("masters");const a=E(!1),s={db:{available:n,selected:n.length>1?u.analyse.explorer.db:function(){return n[0]}},rating:{available:u.analyse.explorer.availableRatings,selected:u.analyse.explorer.rating},speed:{available:u.analyse.explorer.availableSpeeds,selected:u.analyse.explorer.speed}};let i;function o(){return JSON.stringify([s.db.selected(),s.rating.selected(),s.speed.selected()])}function l(e){"backbutton"!==e&&a()&&r.backbutton.stack.pop(),a(!1),t(i!==o())}function c(e,t){-1===e().indexOf(t)?e(e().concat([t])):e().length>1&&e(e().filter((e=>e!==t)))}return{open:a,data:s,toggleOpen(){a()?l():(r.backbutton.stack.push(l),i=o(),a(!0))},toggleDb(e){s.db.selected(e)},toggleRating:e=>c(s.rating.selected,e),toggleSpeed:e=>c(s.speed.selected,e),fullHouse:()=>"masters"===s.db.selected()||s.rating.selected().length===s.rating.available.length&&s.speed.selected().length===s.speed.available.length,serialize:o}},view(e){const t=e.data;return[a("section.db",[a("label",i("database")),a("div.form-multipleChoice",t.db.available.map((n=>a("div",{className:t.db.selected()===n?"selected":"",oncreate:I((()=>e.toggleDb(n)))},n))))]),"masters"===t.db.selected()?a("div.masters.message",[a("i[data-icon=C]"),a("p",i("masterDbExplanation","2200","1952","2020"))]):a("div",[a("section.rating",[a("label",i("averageElo")),a("div.form-multipleChoice",t.rating.available.map((n=>a("div",{className:t.rating.selected().indexOf(n)>-1?"selected":"",oncreate:I((()=>e.toggleRating(n)))},n))))]),a("section.speed",[a("label",i("timeControl")),a("div.form-multipleChoice",t.speed.available.map((n=>a("div",{className:t.speed.selected().indexOf(n)>-1?"selected":"",oncreate:I((()=>e.toggleSpeed(n)))},n))))])]),a("section.save",a("button.text[data-icon=E]",{oncreate:I(e.toggleOpen)},i("allSet")))]}};function nn(e,t){return"loss"===t||"maybe-loss"===t||"blessed-loss"===t?e:"win"===t||"maybe-win"===t||"cursed-win"===t?m(e):void 0}let an;const sn={onbeforeupdate:({attrs:e},{attrs:t})=>e.data!==t.data,view({attrs:e}){const{ctrl:t,data:n}=e,s=function(e,t){return t.length?(an=void 0===an?u.game.pieceNotation():an,a("table",{className:"moves",oncreate:_((t=>function(e,t){const n=rn(t),a=n&&n.dataset.uci;a&&e.playUci(a)}(e,t)),void 0,rn)},a("thead",null,a("tr",null,a("th",{className:"explorerMove-move"},i("move")),a("th",{className:"explorerMove-games"},i("games")),a("th",{className:"explorerMove-result"},i("whiteDrawBlack")))),a("tbody",{className:an?"displayPieces":""},t.map((e=>a("tr",{key:e.uci,"data-uci":e.uci},a("td",{className:"explorerMove-move"},"P"===e.san[0]?e.san.slice(1):e.san),a("td",{className:"explorerMove-games"},e.white+e.draws+e.black),a("td",{className:"explorerMove-result"},function(e){const t=e.white+e.draws+e.black;function n(n){const s=e[n],i=100*s/t,o=Math.round(1e3*s/t)/10+"%";return 0===i?null:a("span",{className:"explorerBar "+n,style:{width:o}},i>12?Math.round(i)+(i>20?"%":""):null)}return["white","draws","black"].map(n)}(e)))))))):null}(t,n.moves),o=ln(t,i("recentGames"),n.recentGames||[]),r=ln(t,i("topGames"),n.topGames||[]);return s||o||r?a("div",{className:"explorer-data"},s,r,o):on(t)}};function on(e){return a("div",{className:"explorer-data empty"},a("div",{className:"message"},a("h3",null,a("i",{className:"withIcon","data-icon":""}),i("noGameFound")),e.explorer.config.fullHouse()?null:a("p",null,i("maybeIncludeMoreGamesFromThePreferencesMenu"))))}function rn(e){const t=e.target;return"TR"===t.tagName?t:t.closest("tr")}function ln(e,t,n){return e.explorer.withGames&&n.length?a("table",{className:"games",oncreate:_((t=>function(e,t){const n=e.chessground.state.orientation,a=rn(t),s=a&&a.dataset.id;s&&"lichess"===e.explorer.config.data.db.selected()?r.set(`/analyse/online/${s}/${n}`):s&&A(s,n).then((e=>r.set(`/analyse/online/${e.game.id}/${n}`)))}(e,t)),void 0,rn)},a("thead",null,a("tr",null,a("th",{colspan:"4"},t))),a("tbody",null,n.map((e=>{return a("tr",{key:e.id,"data-id":e.id},a("td",null,[e.white,e.black].map((e=>a("span",null,e.rating)))),a("td",null,[e.white,e.black].map((e=>a("span",null,e.name)))),a("td",null,"white"===(t=e.winner)?a("result",{className:"white"},"1-0"):"black"===t?a("result",{className:"black"},"0-1"):a("result",{className:"draws"},"½-½")),a("td",null,e.year));var t})))):null}function cn(e){return"standard"===e.data.game.variant.key||"fromPosition"===e.data.game.variant.key?i("openingExplorer"):i("xOpeningExplorer",e.data.game.variant.name)}function dn(e,t,n,s){if(!n.length)return null;const o=function(e){return"w"===e.split(" ")[1]?"white":"black"}(s);return[a("div",{className:"title"},t),a("table",{className:"explorerTablebase",oncreate:_((t=>function(e,t){const n=rn(t),a=n&&n.dataset.uci;a&&e.playUci(a)}(e,t)),void 0,rn)},a("tbody",null,n.map((e=>a("tr",{"data-uci":e.uci,key:e.uci},a("td",null,e.san),a("td",null,function(e,t){if(t.checkmate)return a("result."+nn(e,t.category),i("checkmate"));if(t.stalemate)return a("result.draws",i("stalemate"));if(t.variant_win)return a("result."+nn(e,t.category),i("variantWin"));if(t.variant_loss)return a("result."+nn(e,t.category),i("variantLoss"));if(t.insufficient_material)return a("result.draws",i("insufficientMaterial"));if(null===t.dtz)return null;if(0===t.dtz)return a("result.draws",i("draw"));if(t.zeroing){const n=-1!==t.san.indexOf("x");return a("result."+nn(e,t.category),i(n?"capture":"pawnMove"))}return a("result."+nn(e,t.category),{title:i("dtzWithRounding")+" (Distance To Zeroing)"},"DTZ "+Math.abs(t.dtz))}(o,e),function(e,t){return t.dtm?a("result."+nn(e,t.category),{title:G("mateInXHalfMoves",Math.abs(t.dtm))},"DTM "+Math.abs(t.dtm)):null}(o,e)))))))]}function un(e){return a("div.explorer-data.empty",[a("div.message",[a("h3",[a("i.withIcon[data-icon=]"),e])])])}function hn(e){return e.node.crazyhouse?a("div.analyse-crazyPockets",[pn(e),mn(e)]):null}function pn(e){const t=e.node.crazyhouse;return t?a(Ze,{ctrl:e,crazyData:t,color:e.orientation}):null}function mn(e){const t=e.node.crazyhouse;return t?a(Ze,{ctrl:e,crazyData:t,color:m(e.orientation)}):null}function vn(e){if(!e.contextMenu)return null;const t=e.contextMenu,a=e.tree.nodeAtPath(t),s=e.tree.pathIsMainline(t);return n("analyse-cm",(()=>Be(a)),(()=>[s?null:fn("S",i("promoteVariation"),(()=>e.promote(t,!1))),s?null:fn("E",i("makeMainLine"),(()=>e.promote(t,!0))),fn("q",i("deleteFromHere"),(()=>e.deleteNode(t)))]),!0,(()=>{e.contextMenu=null,l()}))}function fn(e,t,n){return a("button.withIcon",{"data-icon":e,oncreate:_(n)},t)}function gn(e,t,n){return!e.ctrl.settings.s.showComments||Ge(t.comments)?[]:t.comments.map((t=>{if("lichess"===t.by&&!e.showComputer)return null;const s=t.by?a("span.by",(i=t.by)?"string"==typeof i?i:i.name:"Unknown"):null;var i;return a("comment",n?a.trust(yt(t.text)):[s,yn(t.text,300,e)])})).filter((e=>!!e))}function yn(e,t,n){return n.truncateComments&&e.length>t?e.slice(0,t-10)+" [...]":e}function bn(e,t,n){const s=t.children,i=s[0];return i?n.isMainline?s[1]?wn(e,s,n)||[Nn(e,i,{parentPath:n.parentPath,isMainline:!0,withIndex:n.withIndex}),gn(e,i,!0),a("interrupt",kn(e,s.slice(1),{parentPath:n.parentPath,isMainline:!0})),bn(e,i,{parentPath:n.parentPath+i.id,isMainline:!0,withIndex:!0})||[]]:xn(e,i,{parentPath:n.parentPath,isMainline:!0,withIndex:n.withIndex}):s[1]?wn(e,s,n)||[kn(e,s,n)]:xn(e,i,n):null}function wn(e,t,n){return!t[1]||t[2]||wt(t[1],6)?null:xn(e,t[0],{parentPath:n.parentPath,isMainline:n.isMainline,inline:t[1]})}function kn(e,t,n){return a("lines",t.map((t=>a("line",xn(e,t,{parentPath:n.parentPath,isMainline:!1,withIndex:!0,truncate:t.comp&&!bt(e.ctrl.path,n.parentPath+t.id)?6:void 0})))))}function xn(e,t,n){const s=n.parentPath+t.id,i=gn(e,t,!0);return 0===n.truncate?[a("move",{"data-path":s},"[...]")]:[Nn(e,t,n)].concat(i).concat(n.inline?function(e,t,n){return a("inline",xn(e,t,{withIndex:!0,parentPath:n.parentPath,isMainline:!1}))}(e,n.inline,n):null).concat(bn(e,t,{parentPath:s,isMainline:n.isMainline,truncate:n.truncate?n.truncate-1:void 0,withIndex:!!i[0]})||[])}function Mn(e,t,n){const a=e.ctrl,s=!a.study&&n===a.initialPath&&Oe(a.data),i=e.showGlyphs&&t.glyphs?t.glyphs.map((e=>e.id)):[];return{current:n===a.path,currentPlayable:s,nongame:!s&&!!a.gamePath&&bt(n,a.gamePath)&&n!==a.gamePath,inaccuracy:i.includes(6),mistake:i.includes(2),blunder:i.includes(4)}}function Cn(e,t){return a("index",function(e,t){return ze(e)+(t?e%2==1?".":"...":"")}(e,t))}function Nn(e,t,n){const s=n.parentPath+t.id,i=[n.withIndex||1&t.ply?Cn(t.ply,!0):null,z(t.san)];var o;return t.glyphs&&(o=t.glyphs,o.map((e=>a("glyph",e.symbol)))).forEach((e=>i.push(e))),a("move",{"data-path":s,className:B(Mn(e,t,s))},i)}let Pn;var Sn={onbeforeupdate:({attrs:e})=>!e.ctrl.replaying,view({attrs:e}){const{ctrl:t,rightTabActive:n}=e;Pn=Pn||u.game.pieceNotation();const s=[Pn?"displayPieces":"",n?"rta":""].join(" ");return a("div#replay.analyse-replay.native_scroller",{className:s,oncreate:_((e=>function(e,t){const n=Tn(t);n&&n.dataset.path&&e.jump(n.dataset.path)}(t,e)),(e=>{const n=Tn(e),a=n.dataset;n&&a.path&&(t.contextMenu=a.path,l())}),Tn,!1)},function(e){const t=e.tree.root,n={ctrl:e,truncateComments:!1,showComputer:e.settings.s.showComments,showGlyphs:!0,showEval:!0},s=gn(n,t,!0);return a("div.analyse-moveList",{className:"ios"===window.deviceInfo.platform?"ios":""},[s,bn(n,t,{parentPath:"",isMainline:!0})||[]])}(t))}};function Tn(e){const t=e.target;return"MOVE"===t.tagName?t:D(t,"move")}function _n(e){return a("eval",e)}function On(e,t){return function(e){return Math.floor((e-1)/2)+1}(e)+(t?e%2==1?".":"...":"")}function In(e,t){const n=De({client:t.ceval,server:t.eval})||{};return[a("san",z(t.san))].concat(t.glyphs&&e.showGlyphs?(s=t.glyphs,s.map((e=>a("glyph",{title:e.name},e.symbol)))):[]).concat(e.showEval?void 0!==n.cp?[_n(Ae(n.cp))]:void 0!==n.mate?[_n("#"+n.mate)]:[]:[]);var s}function En(e,t){return t.uci?[(n=t.ply,s=e.withDots,a("index",On(n,s)))].concat(In(e,t)):[a("span.init","Initial position")];var n,s}function An(e){const t=e.retro;if(!t)return;const n=t.vm.feedback;return a("div.analyse-training_box.analyse-retro_box.box",{className:t.vm.minimized?"minimized":""},[jn(t),a("div.analyse-training_feedback.native_scroller."+n,Dn(e,n))])}function Bn(e){return a("div.choices",[a("button",{oncreate:s(e.viewSolution)},i("viewTheSolution")),a("button",{oncreate:s(e.nextMistake)},i("skipThisMove"))])}function Gn(e){return a("div.li-button.retro-half.retro-continue",{oncreate:s(e.nextMistake)},[a("i[data-icon=G]"),i("next")])}const zn={find:e=>[a("div.analyse-training_player",[a("div.piece-no-square",{className:e.pieceTheme},a("piece.king."+e.vm.color)),a("div.retro-instruction",[a("strong",[j("xWasPlayed",a("span",En({withDots:!0,showGlyphs:!0,showEval:!1},e.vm.current.fault.node)))]),a("em",i("white"===e.vm.color?"findBetterMoveForWhite":"findBetterMoveForBlack")),Bn(e)])])],offTrack:e=>[a("div.analyse-training_player",[a("div.retro-icon.off","!"),a("div.retro-instruction",[a("strong","You browsed away"),a("div.choices.off",[a("button",{oncreate:s(e.jumpToCurrent)},"Resume learning")])])])],fail:e=>[a("div.analyse-training_player",[a("div.retro-icon","✗"),a("div.retro-instruction",[a("strong",i("youCanDoBetter")),a("em",i("white"===e.vm.color?"tryAnotherMoveForWhite":"tryAnotherMoveForBlack")),Bn(e)])])],win:e=>[a("div.retro-half.top",a("div.analyse-training_player",[a("div.retro-icon","✓"),a("div.retro-instruction",a("strong",i("goodMove")))])),Gn(e)],view:e=>[a("div.retro-half.top",a("div.analyse-training_player",[a("div.retro-icon","✓"),a("div.retro-instruction",[a("strong",i("solution")),a("em",[a("strong",En({withDots:!0,showEval:!1},e.vm.current.solution.node))])])])),Gn(e)],eval(e){return[a("div.retro-half.top",a("div.analyse-training_player.center",[a("div.retro-instruction",[a("strong",i("evaluatingYourMove")),(t=e.node(),a("div.analyse-training_progress",a("div",{style:{width:`${t.ceval?100*Math.max(0,t.ceval.depth-8)/10+"%":0}`}})))])]))];var t},end(e,t){if(!t())return[a("div.retro-half.top",a("div.analyse-training_player",[a("div.retro-icon",o.getVdom()),a("div.retro-instruction",i("waitingForAnalysis"))]))];const n=!e.completion()[1];return[a("div.analyse-training_player",[a("div.piece-no-square",{className:e.pieceTheme},a("piece.king."+e.vm.color)),a("div.retro-instruction",[a("em",i(n?"white"===e.vm.color?"noMistakesFoundForWhite":"noMistakesFoundForBlack":"white"===e.vm.color?"doneReviewingWhiteMistakes":"doneReviewingBlackMistakes")),a("div.choices.end",[n?null:a("button",{oncreate:s(e.reset)},i("doItAgain")),a("button",{oncreate:s(e.flip)},i("white"===e.vm.color?"reviewBlackMistakes":"reviewWhiteMistakes"))])])])]}};function Dn(e,t){const n=e.retro,a=n.vm.current;return n.isSolving()&&a&&e.path!==a.prev.path?zn.offTrack(n):"find"===t?a?zn.find(n):zn.end(n,e.hasFullComputerAnalysis):zn[t](n)}function jn(e){const t=e.completion();return a("div.titleWrapper",[a("div.title",i("learnFromYourMistakes")),a("div.mistakeNb",Math.min(t[0]+1,t[1])+" / "+t[1]),a("div.actions",[a("button.window-button",{oncreate:s(e.toggleWindow)},a("span.fa",{className:e.vm.minimized?"fa-window-maximize":"fa-window-minimize"})),a("button.window-button",{oncreate:s(e.close)},a("span.fa.fa-window-close"))])])}function Un(e,t){return e.best?j("goodMove"===e.verdict?"anotherWasX":"bestWasX",a("move",{oncreate:s(t.playCommentBest)},e.best.san)):[]}function $n(e){return a("div.analyse-training_player.off",[a("div.icon.off","!"),a("div.analyse-training_box_instruction",[a("strong",i("youBrowsedAway")),a("div.choices",[a("button",{oncreate:s(e.resume)},i("resumePractice"))])])])}function Fn(e,t,n){const s="checkmate"===n,o=s?m(e.turnColor()):e.turnColor();return a("div.analyse-training_player",[o?a("div.piece-no-square",{className:t.pieceTheme},a("piece.king."+o)):a("div.icon.off","!"),a("div.analyse-training_box_instruction",[a("strong",i(n)),a("em",s?a("color",i("white"===o?"whiteWinsGame":"blackWinsGame")):i("theGameIsADraw"))])])}function Wn(e,t){const n=e.ceval?100*Math.max(0,e.ceval.depth-8)/(t-8)+"%":0;return a("div.analyse-training_progress",a("div",{style:`width: ${n}`}))}function Ln(e,t){const n=t.hinting();return a("div.analyse-training_player.running",[a("div.piece-no-square",{className:t.pieceTheme},a("piece.king."+e.turnColor())),a("div.analyse-training_box_instruction",(t.isMyTurn()?[a("strong",i("yourTurn"))]:[a("strong",i("computerThinking")),Wn(t.currentNode(),t.playableDepth())]).concat(a("div.choices",[t.isMyTurn()?a("button",{oncreate:s(t.hint)},i(n?"piece"===n.mode?"seeBestMove":"hideBestMove":"getAHint")):""])))])}function Rn(e,t){return a("div.titleWrapper",[a("div.title",i("practiceWithComputer")),a("div.actions",[a("button.window-button",{oncreate:s(t.toggleWindow)},a("span.fa",{className:t.minimized()?"fa-window-maximize":"fa-window-minimize"})),a("button.window-button",{oncreate:s(e.togglePractice)},a("span.fa.fa-window-close"))])])}function qn(e){const t=e.practice;if(!t)return;const n=t.comment(),s=t.running(),o=t.currentNode().threefold?"threefoldRepetition":e.gameOver();return a("div.analyse-practice_box.analyse-training_box.box."+(n?n.verdict:"no-verdict"),{className:t.minimized()?"minimized":""},[Rn(e,t),a("div.analyse-training_feedback.native_scroller",s?o?Fn(e,t,o):Ln(e,t):$n(t)),s?a("div.comment",n?[a("span.verdict",i(n.verdict))," "].concat(Un(n,t)):[t.isMyTurn()||o?"":a("span.wait",i("evaluatingYourMove"))]):s?a("div.comment"):null])}function Vn(e,t){const n=e.chapter.tags.find((e=>e[0].toLowerCase()===t));return n&&n[1]}function Hn(){var e=At,t=null,n=It(0),a=Bt,s=It(!0),i=null,o=Gt,r=null;function l(l){var c,d,u,h,p,m=l.length,v=!1,f=new Array(m),g=new Array(m);for(null==i&&(r=o(p=zt())),c=0;c<=m;++c){if(!(c<m&&s(h=l[c],c,l))===v)if(v=!v)d=c,r.areaStart(),r.lineStart();else{for(r.lineEnd(),r.lineStart(),u=c-1;u>=d;--u)r.point(f[u],g[u]);r.lineEnd(),r.areaEnd()}v&&(f[c]=+e(h,c,l),g[c]=+n(h,c,l),r.point(t?+t(h,c,l):f[c],a?+a(h,c,l):g[c]))}if(p)return r=null,p+""||null}function c(){return Et().defined(s).curve(o).context(i)}return l.x=function(n){return arguments.length?(e="function"==typeof n?n:It(+n),t=null,l):e},l.x0=function(t){return arguments.length?(e="function"==typeof t?t:It(+t),l):e},l.x1=function(e){return arguments.length?(t=null==e?null:"function"==typeof e?e:It(+e),l):t},l.y=function(e){return arguments.length?(n="function"==typeof e?e:It(+e),a=null,l):n},l.y0=function(e){return arguments.length?(n="function"==typeof e?e:It(+e),l):n},l.y1=function(e){return arguments.length?(a=null==e?null:"function"==typeof e?e:It(+e),l):a},l.lineX0=l.lineY0=function(){return c().x(e).y(n)},l.lineY1=function(){return c().x(e).y(a)},l.lineX1=function(){return c().x(t).y(n)},l.defined=function(e){return arguments.length?(s="function"==typeof e?e:It(!!e),l):s},l.curve=function(e){return arguments.length?(o=e,null!=i&&(r=o(i)),l):o},l.context=function(e){return arguments.length?(null==e?i=r=null:r=o(i=e),l):i},l}function Jn(e,t,n){const a=t.game.division,s=e.getBoundingClientRect(),o=Dt(e).append("svg").attr("viewBox",`0 0 ${s.width} ${s.height}`),r=(l=t).treeParts.slice(1).reduce(((e,t)=>{const n=1&t.ply;let a;if(t.eval&&t.eval.mate)a=t.eval.mate>0?1/0:-1/0;else if(t.san&&t.san.indexOf("#")>0)a=1===n?1/0:-1/0,"antichess"===l.game.variant.key&&(a=-a);else{if(!t.eval||void 0===t.eval.cp)return e;a=t.eval.cp}const s={acpl:2/(1+Math.exp(-.004*a))-1};return e.concat([s])}),[]);var l;const c=10,d=10,u=10,h=10,p=s.width-h-d,m=s.height-c-u,v=o.append("g").attr("transform","translate("+h+","+c+")");function f(e,t){v.append("line").attr("class","division "+t).attr("x1",e).attr("x2",e).attr("y1",w(-1)).attr("y2",w(1)),v.append("text").attr("class","chart-legend").attr("transform","rotate(90)").attr("y",-e).attr("dy","-0.4em").text(i(t))}const g=t.treeParts[0].ply||0;function y(e){if(v.selectAll(".dot").remove(),null!==e){const t=e-1-g,n=r[t];n&&v.append("circle").attr("class","dot").attr("cx",b(t)).attr("cy",w(n.acpl)).attr("r",3)}}const b=jt().domain([0,r.length]).rangeRound([0,p]),w=jt().domain([-1,1]).rangeRound([m,0]),k=Hn().x(((e,t)=>b(t))).y((e=>w(e.acpl))),x=Hn().x(((e,t)=>b(t))).y1((e=>e.acpl>=0?w(e.acpl):w(0)));return v.datum(r),v.append("line").attr("class","zeroline").attr("x1",0).attr("x2",p).attr("y1",w(0)).attr("y2",w(0)),v.append("clipPath").attr("id","clip-below").append("path").attr("d",x.y0((e=>w(e.acpl)))),v.append("clipPath").attr("id","clip-above").append("path").attr("d",x.y0(w(0))),v.append("path").attr("class","area above").attr("clip-path","url(#clip-above)").attr("d",x),v.append("path").attr("class","area below").attr("clip-path","url(#clip-below)").attr("d",x.y0((e=>e.acpl<=0?w(e.acpl):w(0)))),v.append("path").attr("class","line").attr("d",k),a&&(a.middle||a.end)&&(f(b(0),"opening"),a.middle&&f(b(a.middle),"middlegame"),a.end&&f(b(a.end),"endgame")),y(n),y}function Xn(e,t,n,a){const s=t.game.division,o=e.getBoundingClientRect(),r=Dt(e).append("svg").attr("viewBox",`0 0 ${o.width} ${o.height}`),l=10,c=10,d=10,u=25,h=o.width-u-c,p=o.height-l-d,m=r.append("g").attr("transform","translate("+u+","+l+")"),{max:v,series:f}=function(e,t){const n={white:[],black:[]},a=e.treeParts,s=Math.pow(Math.log(3),2);let i=0,o=0;return t.forEach(((e,t)=>{const r=a[t+1];i=r?r.ply:i+1;const l=!!(1&i),c=Math.pow(Math.log(.005*Math.min(e,12e4)+3),2)-s;o=Math.max(c,o);const d={ply:i,y:l?c:-c};l?n.white.push(d):n.black.push(d)})),{max:o,series:n}}(t,n);function g(e,t){m.append("line").attr("class","division "+t).attr("x1",e).attr("x2",e).attr("y1",w(-v)).attr("y2",w(v)),m.append("text").attr("class","chart-legend").attr("transform","rotate(90)").attr("y",-e).attr("dy","-0.4em").text(i(t))}function y(e){if(m.selectAll(".dot").remove(),null!==e){const t=!!(1&e)?f.white.find((t=>t.ply===e)):f.black.find((t=>t.ply===e));t&&m.append("circle").attr("class","dot").attr("cx",b(e)).attr("cy",w(t.y)).attr("r",3)}}const b=jt().domain([0,f.white.length+f.black.length]).rangeRound([0,h]),w=jt().domain([-v,v]).rangeRound([p,0]),k=Hn().x((e=>b(e.ply))).y((e=>w(e.y))),x=Hn().x((e=>b(e.ply))).y0(w(0)).y1((e=>w(e.y))),M=Math.max(...n)/100,C=jt().domain([-M,M]).rangeRound([p,0]),N=Ut(C).tickFormat((e=>String(Math.abs(e))));return m.append("g").call(N).append("text").attr("class","legend").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("text-anchor","end").text("Seconds"),m.append("path").datum(f.white).attr("class","area above").attr("d",x),m.append("path").datum(f.black).attr("class","area below").attr("d",x),m.append("path").attr("class","line").datum(f.white).attr("d",k),m.append("path").attr("class","line").datum(f.black).attr("d",k),s&&(s.middle||s.end)&&(s.middle&&g(b(s.middle),"middlegame"),s.end&&g(b(s.end),"endgame")),y(a),y}function Yn(e){return a("div.analyse-computerAnalysis",[a("strong.title",i("computerAnalysis")),e.analysisProgress?a("div.analyse-gameAnalysis_chartPlaceholder",o.getVdom("monochrome")):a("div.analyse-chart",{oncreate({dom:t}){U((()=>{this.updateCurPly=Jn(t,e.data,e.node.ply)}))},onupdate({dom:t}){this.updateCurPly?U((()=>{this.updateCurPly(e.onMainline?e.node.ply:null)})):U((()=>{const n=t;for(;n.lastElementChild;)n.removeChild(n.lastElementChild);this.updateCurPly=Jn(n,e.data,e.node.ply)}))}}),a(Kn,{d:e.data,analysis:e.data.analysis,study:e.study&&e.study.data})])}const Kn={onbeforeupdate:({attrs:e},{attrs:t})=>!$(e.analysis,t.analysis),view({attrs:e}){const{d:t,analysis:n,study:s}=e;return a("div.analyse-evalSummary",["white","black"].map((e=>{const o=je(t,e),r=s?Vn(s,e)||"Anonymous":F(o);return a("div.analyse-evalSummary__side",[a("div.analyse-evalSummary__player",[a("span.color-icon."+e),a("span",[r,o?W(o):null])]),a("div",[ta.map((t=>{const s=n&&n[e][t[0]];return a("div.analyse-evalSummary__summary",[a.trust(G(t[1],s,`<strong>${s}</strong>`))])})),a("div.analyse-evalSummary__summary",[a("strong",n&&n[e].acpl),a("span",i("averageCentipawnLoss"))])])])})))}};function Qn(e){return a("div.analyse-computerAnalysis.request",[e.analysisProgress?a("div.analyse-requestProgress",[a("span",i("waitingForAnalysis")),o.getVdom("monochrome")]):a("button.fatButton",{oncreate:_((()=>{return(n=e.data.game.id,t(`/${n}/request-analysis`,{method:"POST"},!0)).then((()=>{e.analysisProgress=!0,l()})).catch(c);var n}))},[i("requestAComputerAnalysis")])])}function Zn(e){return a("div.analyse-computerAnalysis.request",e.mainline.length<5?a("p","The study is too short to be analysed."):e.study.canContribute()?[a("p",["Get a full server-side computer analysis of the main line.",a("br"),"Make sure the chapter is complete, for you can only request analysis once."]),e.analysisProgress?a("div.analyse-requestProgress",[a("span",i("waitingForAnalysis")),o.getVdom("monochrome")]):a("button.fatButton",{oncreate:_((()=>{e.socket.send("requestAnalysis",e.study.data.chapter.id),e.analysisProgress=!0,l()}))},[i("requestAComputerAnalysis")])]:a("p","Only the study contributors can request a computer analysis"))}function ea(e,t){return a("div.analyse-moveTimes",[a("strong.title",i("moveTimes")),a("div.analyse-chart",{oncreate({dom:n}){setTimeout((()=>{this.updateCurPly=Xn(n,e.data,t,e.node.ply)}),200)},onupdate(){this.updateCurPly&&U((()=>{e.onMainline?this.updateCurPly(e.node.ply):this.updateCurPly(null)}))}})])}const ta=[["inaccuracy","nbInaccuracies"],["mistake","nbMistakes"],["blunder","nbBlunders"]];var na={onbeforeupdate:({attrs:e},{attrs:t})=>e.color!==t.color||!e.ctrl.replaying,view({attrs:e}){const{ctrl:t,color:n}=e,s=t.node,i=s.clock;if(void 0===i)return;const o=t.tree.getParentClock(s,t.path);let r,l;const c=s.ply%2==0;c?(r=o,l=i):(r=i,l=o);return a("span.analyse-clock",{className:("white"===n?c:!c)?"current":""},function(e){if(void 0===e)return a("span.time",["-"]);const t=new Date(10*e),n=t.getUTCMilliseconds(),s=":",i=aa(t.getUTCMinutes())+s+aa(t.getUTCSeconds());if(e>=36e4)return a("span.time",[Math.floor(e/36e4)+s+i]);const o=Math.floor(n/100).toString();return a("span.time",[i,a("tenths","."+o)])}("white"===n?r:l))}};function aa(e){return(e<10?"0":"")+e}function sa(e,t){return function(e,t){return"white"===e?t:-t}(e,function(e){return void 0!==e.mate?function(e){const t=100*(21-Math.min(10,Math.abs(e)));return oa(t*(e>0?1:-1))}(e.mate):(t=e.cp,oa(Math.min(Math.max(-1e3,t),1e3)));var t}(t))}function ia(e,t,n){return(sa(e,t)-sa(e,n))/2}function oa(e){return 2/(1+Math.exp(-.004*e))-1}function ra(e){return a("div.analyse-boardWrapper",[la(e,e.topColor()),a(Je,{variant:e.data.game.variant.key,chessground:e.chessground,shapes:ca(e),clearableShapes:e.node.shapes,wrapperClasses:e.settings.s.smallBoard?"halfsize":"",canClearShapes:!0}),la(e,e.bottomColor())])}function la(e,t){const n=e.playerName(t),s="Anonymous"===n;if(e.study&&s||!e.study&&e.synthetic)return null;const i=e.study&&e.study.data;let o,r,l;if(i)o=Vn(i,`${t}title`),r=Vn(i,`${t}elo`),l=function(e,t){switch(Vn(e,"result")){case"1-0":return t?"1":"0";case"0-1":return t?"0":"1";case"1/2-1/2":return"1/2";default:return}}(i,"white"===t);else if(Ue.finished(e.data)){const n=e.data.game.winner;l=void 0===n?"½":n===t?"1":"0"}const c=e.node.checkCount,d=e.node.clock||c;return a("div.analyse-player_bar",{className:e.settings.s.smallBoard?"halfsize":""},[a("div.info",s?a.trust("&nbsp"):[l?a("span.result",l):null,a("span.name",(o?o+" ":"")+n+(r?` (${r})`:""))]),d?a("div.player_bar_clock",[a(na,{ctrl:e,color:t}),c?da("white"===e.bottomColor(),c):null]):null])}function ca(e){const t=e.data.game.player,n=e.node&&e.node.ceval,a=e.node&&e.node.eval;let s=[],i=[],o=[];if(e.practice){const n=e.practice.hinting();n&&(s="move"===n.mode?ua(n.uci,"paleBlue",t):[{orig:L(n.uci)[0],brush:"paleBlue"}])}if(!e.retro&&!e.practice&&e.settings.s.showBestMove){const o=e.nextNodeBest()||n&&n.best;o&&(s=ua(o,"paleBlue",t)),n&&n.pvs.length>1&&n.pvs.slice(1).forEach((e=>{const a=ia(t,n.pvs[0],e);if(a>=0&&a<.2){const n=Math.round(12-50*a);s=s.concat(ua(e.moves[0],"paleBlue"+n,t))}})),a&&a.best&&(i=ua(a.best,"paleGreen",J(t)))}const{uci:r,glyphs:l}=e.node;if(r&&l&&l.length>0){const e=l[0];o=[{orig:L(r)[1],glyph:e}]}const c=e.retro&&e.retro.showBadNode(),d=c&&c.uci?ua(c.uci,"paleRed",t):[];return[...i,...s,...d,...o]}function da(e,t){const n=a("span.color-icon.white","+"+t.black),s=a("span.color-icon.black","+"+t.white);return a("div.analyse-checkCount",e?[n,s]:[s,n])}function ua(e,t,n){if(e.includes("@")){const a=R(e);return[{brush:t,orig:a},{orig:a,piece:{role:q(e),color:n},brush:t}]}{const a=V(e),s=H(e),i=[{brush:t,orig:a[0],dest:a[1]}];return s&&i.push({brush:t,orig:a[1],piece:{role:s,color:n}}),i}}const ha=[{name:"fast",delay:1e3},{name:"slow",delay:5e3}],pa={name:"realtimeReplay",delay:"realtime"},ma={name:"byCPL",delay:"cpl"};function va(e,t){return a("section",{className:"actions_bar analyse_actions_bar"},a("button",{className:"action_bar_button fa "+(e.retroGlowing?"fa-play glow":"fa-list"),oncreate:s(e.study?e.study.actionMenu.open:e.menu.open)}),a("button",{className:"action_bar_button fa fa-gear",oncreate:s(e.settings.open)}),e.study&&e.study.chat?null:a("button",{className:"action_bar_button","data-icon":"B",oncreate:s(e.settings.flip)}),e.study&&e.study.chat?a("button",{className:"action_bar_button fa fa-comments withChip",oncreate:s(e.study.chat.open)},e.study.chat.nbUnread>0?a("span",{className:"chip"},e.study.chat.nbUnread<=99?e.study.chat.nbUnread:99):null):null,t?a("button",{className:"action_bar_button fa fa-"+(e.settings.s.smallBoard?"expand":"compress"),oncreate:s(e.settings.toggleBoardSize,(()=>P.show({text:"Expand/compress board",duration:"short",position:"bottom"})))}):null,a("button",{className:"action_bar_button fa fa-backward",oncreate:s(e.stoprewind,void 0,e.rewind)}),a("button",{className:"action_bar_button fa fa-forward",disabled:!!e.retro,oncreate:s(e.stopff,void 0,e.fastforward)}),e.study?a("button",{className:"action_bar_button fa fa-bars",oncreate:s(e.study.sideMenu.open)}):null)}function fa(e){return e.reduce(((e,t)=>e.set(ga(t),t)),new Map)}function ga(e){return e.map((e=>e.ply+":"+e.uci)).join(",")}class ya{constructor(e){var t;this.focusKey=null,this.loading=!1,this._minimized=!1;const n=e.forecast;this._lines=fa((null==n?void 0:n.steps)||[]);const a=null==n?void 0:n.onMyTurn;this.isMyTurn=!!a,this._gameId=e.game.id,this._playerId=(null===(t=e.player)||void 0===t?void 0:t.id)||null}truncate(e){const t=this.isMyTurn?1:0;return(e.length%2!==t?e.slice(0,-1):e).slice(0,30)}isCandidate(e){const t=this.truncate(e);if(!this.isLongEnough(t))return!1;for(const e of this._lines.values())if(this.isPrefix(e,t))return!1;return!0}removeForecast(e){this._lines.delete(e),this.focusKey=null,this.save()}add(e){const t=this.truncate(e);this.isCandidate(t)&&(this._lines.set(ga(t),t),this.fixAll(),this.save())}save(){const t=this._playerId,n=this._gameId;!this.isMyTurn&&t&&(this.loading=!0,l(),function(t,n,a){return e(`/${t}${n}/forecasts`,{method:"POST",body:JSON.stringify(a)})}(n,t,this.lines).then((e=>{e.reload?this.reloadToLastPly():(this.loading=!1,this._lines=fa(e.steps||[]),l())})))}playAndSave(t){const n=this._playerId,a=this._gameId;if(!this.isMyTurn||!n)return;const s=this.findStartingWithNode(t).filter((e=>e.length>0)).map((e=>e.slice(1)));this.loading=!0,l(),function(t,n,a,s){return e(`/${t}${n}/forecasts/${a.uci}`,{method:"POST",body:JSON.stringify(s)})}(a,n,t,s).then((e=>{e.reload?this.reloadToLastPly():(this.loading=!1,this._lines=fa(e.steps||[]),l())}))}findStartingWithNode(e){return this.lines.filter((t=>this.isPrefix(t,[e])))}reloadToLastPly(){r.deleteQueryParam("ply",!0)}get lines(){return Array.from(this._lines.values())}isPrefix(e,t){return e.length>=t.length&&ga(e).startsWith(ga(t))}collides(e,t){for(let n=0,a=Math.min(e.length,t.length);n<a;n++)if(e[n].uci!==t[n].uci)return this.isMyTurn?0!==n&&n%2==0:n%2==1;return!1}toggleMinimized(){this._minimized=!this._minimized}get minimized(){return this._minimized}isLongEnough(e){return e.length>=(this.isMyTurn?1:2)}fixAll(){for(const[e,t]of this._lines.entries())for(const[n,a]of this._lines.entries())if(e!==n&&this.isPrefix(a,t)||this.collides(t,a)){this._lines.delete(e);break}}}function ba(e){var t=function(e){return e?1/0===(e=X(e))||-1/0===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),n=t%1;return t==t?n?t-n:t:0}var wa=/^(?:0|[1-9]\d*)$/;function ka(e,t,n){if(!K(n))return!1;var a=typeof t;return!!("number"==a?function(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}(e.length)&&!Y(e)}(n)&&function(e,t){var n=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==n||"symbol"!=n&&wa.test(e))&&e>-1&&e%1==0&&e<t}(t,n.length):"string"==a&&t in n)&&function(e,t){return e===t||e!=e&&t!=t}(n[t],e)}function xa(e,t,n){var a=-1,s=e.length;t<0&&(t=-t>s?0:s+t),(n=n>s?s:n)<0&&(n+=s),s=t>n?0:n-t>>>0,t>>>=0;for(var i=Array(s);++a<s;)i[a]=e[a+t];return i}var Ma=Math.ceil,Ca=Math.max;function Na(e){const t=[];return e[0].ply%2==0&&(t.push({index:Math.floor((e[0].ply+1)/2),black:e[0].san,white:null}),e=e.slice(1)),function(e,t,n){t=(n?ka(e,t,n):void 0===t)?1:Ca(ba(t),0);var a=null==e?0:e.length;if(!a||t<1)return[];for(var s=0,i=0,o=Array(Ma(a/t));s<a;)o[i++]=xa(e,s,s+=t);return o}(e,2).forEach((([e,n])=>{t.push({index:(e.ply+1)/2,white:e.san,black:null==n?void 0:n.san})})),t}function Pa(e){const t=e.forecast;if(!t||e.synthetic||!Oe(e.data))return null;const n=Sa(e,t),o=t.isCandidate(n);return a("div.analyse-training_box.analyse-forecast_box.box",{className:t.minimized?"minimized":"",oncreate:s((()=>{t.focusKey=null}))},[Oa(t),a("div.forecasts-wrapper.native_scroller",[a("div.forecasts-list",{className:u.game.pieceNotation()?"displayPieces":""},[...t.lines.map((e=>{const n=ga(e);return a("div.forecast[data-icon=G]",{key:n,oncreate:s((e=>{e.stopPropagation(),t.focusKey=n}))},[a("sans",Ta(e)),t.focusKey===n?a("span.fa.fa-times-circle.delete",{oncreate:s((e=>{e.stopPropagation(),t.removeForecast(n)}))}):null])}))]),a("div.add",{className:o?"enabled":"","data-icon":o?"O":"",oncreate:s((()=>{const n=Sa(e,t);t.add(n)}))},[o?a("div",[a("span",i("addCurrentVariation")),a("sans",Ta(n))]):a("span",i("playVariationToCreateConditionalPremoves"))]),_a(e,n),t.loading?a("div.spinner_overlay",a("div.spinner.fa.fa-hourglass-half")):null])])}function Sa(e,t){const n=e.tree.getCurrentNodesAfterPly(e.nodeList,e.mainline,e.data.game.turns);return t.truncate(n.map((e=>({ply:e.ply,fen:e.fen,uci:e.uci,san:e.san}))))}function Ta(e){return e[0]?(e[0].san||(e=e.slice(1)),e[0]?Na(e).map((({black:e,white:t,index:n})=>a("move",[a("index",n+(t?".":"...")),t?a("san",t):null,e?a("san",e):null]))):[]):[]}function _a(e,t){var n;if(!(null===(n=e.forecast)||void 0===n?void 0:n.isMyTurn))return;const o=t[0];if(!o)return;const r=e.forecast.findStartingWithNode(o);if(!r.length)return;const l=r.filter((e=>e.length>1)).length;return a("div.on-my-turn",a("button.defaultButton",{oncreate:s((()=>e.forecast.playAndSave(o)))},[a("span.fa.fa-check"),a("span",[a("strong",i("playX",t[0].san))," ",l?a("span",G("andSaveNbPremoveLines",l)):null])]))}function Oa(e){return a("div.titleWrapper",[a("div.title",[i("conditionalPremoves"),e.lines.length>0?` (${e.lines.length})`:null]),a("div.actions",[a("button.window-button",{oncreate:s((()=>e.toggleMinimized()))},a("span.fa",{className:e.minimized?"fa-window-maximize":"fa-window-minimize"}))])])}function Ia(e,t,n){const s=u.analyse.smallBoard();return Ce.board(Q(),[Ga(t||"white",s,n||Ne),a("div.analyse-tableWrapper",o.getVdom("monochrome")),e?a("section.analyse_actions_bar"):null])}function Ea(e,t){const n=e.availableTabs(),s=ee();return a.fragment({key:"size"+e.settings.s.smallBoard},[ra(e),a("div.analyse-tableWrapper",["crazyhouse"!==e.data.game.variant.key||!t&&s?null:hn(e),!t&&s?pn(e):null,Ua(e,n),t?null:va(e,t),!t&&s?mn(e):null]),t?va(e,t):null])}function Aa(e){return[Xe(e),e.study?qt.view(e.study.actionMenu):Wt.view(e.menu),e.study&&e.study.chat?nt(e.study.chat):null,Vt.view(e.settings),e.notes?et(e.notes):null,vt.view(e.continuePopup),vn(e)]}function Ba(e){const t=e.data.game.variant.key,n=te(t);let s=u.analyse.availableVariants;return"fromPosition"===t&&(s=s.concat([["From position","fromPosition"]])),a("div.select_input.main_header-selector.header-subTitle",[a("label",{for:"variant_selector"},a(`i[data-icon=${n}]`)),a("select",{id:"variant_selector",value:t,onchange:e=>{const t=e.target.value;u.analyse.syntheticVariant(t),r.set(`/analyse/variant/${t}`)}},s.map((e=>a("option",{key:e[1],value:e[1]},e[0]))))])}function Ga(e,t,n){return a("section.board_wrapper.analyse-boardWrapper",{className:t?"halfsize ":""},a(Z,{orientation:e,fen:n}))}function za(e,t){const n=e.currentTab(t),s=t.map((t=>{var n;return"comments"===t.id&&e.node.comments&&e.node.comments.length>0?Object.assign(Object.assign({},t),{chip:e.node.comments.length}):"forecasts"===t.id&&(null===(n=e.forecast)||void 0===n?void 0:n.lines)&&e.forecast.lines.length>0?Object.assign(Object.assign({},t),{chip:e.forecast.lines.length}):t}));return a("div.analyse-header",["ceval"!==n.id?a(Zt,{ctrl:e}):null,a("div.analyse-tabs",[a("div.tab-title",Da(e,n)),a(Se,{buttons:s,selectedIndex:e.currentTabIndex(t),onTabChange:e.onTabChange,wrapperClass:"analyse"})])])}function Da(e,t){const n=i(t.title);let s;if("moves"===t.id){s=[function(e){const t=e.tree.getOpening(e.nodeList)||e.data.game.opening;if(t)return a("div",[a("strong",t.eco)," "+t.name])}(e)||n]}else s="ceval"===t.id?[a("span",e.ceval.getEngineName()+(e.ceval.getEngineEvaluation()?` (${e.ceval.getEngineEvaluation()})`:"")),e.ceval.isSearching()?a("div.ceval-spinner",a("span.fa.fa-spinner.fa-pulse")):null]:"explorer"===t.id?[cn(e)]:[n];return a.fragment({},s)}const ja={infos:function(e){const t=e.data.player,n=e.data.opponent;return t&&n?a("div",{className:"analyse-gameInfos native_scroller"},a("div",{className:"analyseOpponent li-button",oncreate:_((()=>t.user&&r.set(`/@/${t.user.id}/`)))},a("div",{className:"analysePlayerName"},a("span",{className:"color-icon "+t.color}),F(t,!0),W(t),t.berserk?a("span",{"data-icon":"`"}):null)),a("div",{className:"analyseOpponent li-button",oncreate:_((()=>n.user&&r.set(`/@/${n.user.id}/`)))},a("div",{className:"analysePlayerName"},a("span",{className:"color-icon "+n.color}),F(n,!0),W(n),n.berserk?a("span",{"data-icon":"`"}):null)),a("div",{className:"gameInfos"},e.formattedDate?e.formattedDate:null,"import"===e.data.game.source&&e.data.game.importedBy?a("div",null,"Imported by ",e.data.game.importedBy):null),Ue.finished(e.data)?function(e){const t=je(e.data,e.data.game.winner);return a("div",{className:"status"},Ue.toLabel(e.data.game.status.name,e.data.game.turns,e.data.game.winner,e.data.game.variant.key),t?". "+i("white"===t.color?"whiteIsVictorious":"blackIsVictorious")+".":null)}(e):null,e.data.tournament?a("div",{className:"analyse-tournamentInfo li-button",oncreate:_((()=>e.data.tournament&&r.set(`/tournament/${e.data.tournament.id}`)))},a("span",{className:"fa fa-trophy"}),e.data.tournament.name+" Arena"):null,a("h2",{className:"analyse-tabContentTitle"},i("replayMode")),function(e){const t=e.data,n="correspondence"!==t.game.speed&&t.game.moveCentis&&0!==t.game.moveCentis.length,o=[...ha,...n?[pa]:[],...t.analysis?[ma]:[]];return a("div.analyse-autoplay",o.map((t=>a("button.buttonMetal",{oncreate:s((()=>e.autoplay.toggle(t.delay)))},i(t.name)))))}(e)):null},moves:function(e){return a("div.analyse-replayWrapper",[a(Sn,{ctrl:e,rightTabActive:!1})])},explorer:function(e){const t=e.explorer.current(),n=e.explorer.config,o=n.open(),r=!o&&e.explorer.loading(),l=B({explorerTable:!0,loading:r}),c=e.tree.getOpening(e.nodeList)||e.data.game.opening;return a("div",{id:"explorerTable",className:l},t&&t.isOpening?a("div",{className:"explorer-fixedTitle"},a("span",null,c?c.eco+" "+c.name:""),o||t&&t.isOpening?a("div",{className:"toconf","data-icon":o?"L":"%",oncreate:s(n.toggleOpen)}):null):null,r?a("div",{className:"spinner_overlay"},a("div",{className:"spinner fa fa-hourglass-half"})):null,o?function(e){return a("div.explorerConfig",{},tn.view(e.explorer.config))}(e):null,!o&&e.explorer.failing()?a("div.explorer-data.empty",{},a("div.failing.message",[a("h3",[a("i.withIcon[data-icon=,]"),"Oops, sorry!"]),a("p","The explorer is temporarily"),a("p","out of service. Try again soon!")])):null,o||e.explorer.failing()?null:function(e){const t=e.explorer.current();if(t&&function(e){return!!e.isOpening}(t))return a(sn,{data:t,ctrl:e});if(t&&function(e){return!!e.tablebase}(t)){const n=t.moves;return n.length?a("div",{className:"explorer-data"},dn(e,i("winning"),n.filter((e=>"loss"===e.category)),t.fen),dn(e,i("unknown"),n.filter((e=>"unknown"===e.category)),t.fen),dn(e,i("winOr50MovesByPriorMistake"),n.filter((e=>"maybe-loss"===e.category)),t.fen),dn(e,i("winPreventedBy50MoveRule"),n.filter((e=>"blessed-loss"===e.category)),t.fen),dn(e,i("drawn"),n.filter((e=>"draw"===e.category)),t.fen),dn(e,i("lossSavedBy50MoveRule"),n.filter((e=>"cursed-win"===e.category)),t.fen),dn(e,i("lossOr50MovesByPriorMistake"),n.filter((e=>"maybe-win"===e.category)),t.fen),dn(e,i("losing"),n.filter((e=>"win"===e.category)),t.fen)):t.checkmate?un(i("checkmate")):t.stalemate?un(i("stalemate")):t.variant_win||t.variant_loss?un(i("variantEnding")):on(e)}return a("div",null)}(e))},analysis:function(e){const t=e.data;return a("div.analyse-gameAnalysis.native_scroller",[t.analysis?Yn(e):e.study?Zn(e):Qn(e),t.game.moveCentis?ea(e,t.game.moveCentis):null])},ceval:function(e){return e.ceval.enabled()?a("div.ceval-Wrapper",[Yt(e),Qt(e)]):a("div.ceval-notEnabled","Computer eval is disabled")},pgnTags:function(e){const t=e.study;return t?a("div.native_scroller",[a("table.study-tags",[a("tbody",t.data.chapter.tags.map((([e,t])=>a("tr.study-tag",[a("th",e),a("td",a.trust(yt(t)))]))))])]):a("div","oops! nothing to see here")},comments:function(e){const t=e.node.comments||[];return a("div.native_scroller.study-comments",t.map((e=>a("div.study-comment",[a("div.by",("string"==typeof e.by?e.by:e.by.name)+":"),a("div",a.trust(yt(e.text)))]))))}};function Ua(e,t){const n=e.retro||e.practice||e.forecast;return a("div.analyse-table.box",[za(e,t),a(Te,{className:"analyse-tabsContent"+(n?" withTrainingBox":""),selectedIndex:e.currentTabIndex(t),tabs:t.map((t=>({id:t.id,f:()=>ja[t.id](e)}))),onTabChange:e.onTabChange,boardView:!0}),e.retro?An(e):null,e.practice?qn(e):null,e.forecast?Pa(e):null])}class $a{constructor(e){this.ctrl=e}move(){return this.ctrl.canGoForward()?(this.ctrl.next(),l(),!0):(this.stop(),l(),!1)}evalToCp(e){return e.eval?e.eval.mate?e.eval.mate>0?990:-990:e.eval.cp:e.ply%2?990:-990}nextDelay(){if("string"!=typeof this.delay||this.ctrl.onMainline){if("realtime"===this.delay){if(this.ctrl.node.ply<2)return 1e3;const e=this.ctrl.data.game.moveCentis;if(!e)return 1500;return 10*e[this.ctrl.node.ply-this.ctrl.tree.root.ply]+130||2e3}if("cpl"===this.delay){const e=30;if(this.ctrl.node.ply>=this.ctrl.mainline.length-1)return 0;const t=this.evalToCp(this.ctrl.node),n=this.evalToCp(this.ctrl.node.children[0]);return Math.max(500,Math.min(1e4,Math.abs(t-n)*e))}return this.delay}return 1500}schedule(){this.timeoutId=setTimeout((()=>{this.move()&&this.schedule()}),this.nextDelay())}start(e){this.delay=e,this.stop(),this.schedule()}stop(){clearTimeout(this.timeoutId),this.timeoutId=void 0}toggle(e){this.active(e)?this.stop():(this.active()||this.move()||this.ctrl.jump(""),this.start(e))}active(e){return!(e&&e!==this.delay||!this.timeoutId)}}function Fa(){const e={state:"pending"};return e.promise=new Promise(((t,n)=>{e.resolve=n=>{e.state="fulfilled",t(n)},e.reject=()=>{e.state="rejected",n()}})),e}const Wa=new RegExp(""+/^info depth (\d+) seldepth \d+ multipv (\d+) /.source+/score (cp|mate) ([-\d]+) /.source+/(?:(upper|lower)bound )?nodes (\d+) nps \S+ /.source+/(?:hashfull \d+ )?(?:tbhits \d+ )?time (\S+) /.source+/pv (.+)/.source);class La{constructor(e,t,n){this.threads=t,this.hash=n,this.startQueue=[],this.stopped=!1,this.engineName="Stockfish",this.init=async()=>{try{window.addEventListener("stockfish",this.listener,{passive:!0});const e=await this.stockfish.start();this.engineName=e.engineName,await this.stockfish.setVariant(),await this.stockfish.setOption("UCI_AnalyseMode","true"),await this.stockfish.setOption("Threads",this.threads),"web"!==ne.getPlatform()&&await this.stockfish.setOption("Hash",this.hash)}catch(e){}},this.start=e=>{this.stop(),this.startQueue.push(e),clearTimeout(this.stopTimeoutId);const t=new Promise(((e,t)=>{this.stopTimeoutId=setTimeout(t,1e4)}));return Promise.race([this.ready.promise,t]).then(this.search).catch((()=>{this.reset().then(this.search)}))},this.stop=()=>{this.stopped||(this.stopped=!0,this.stockfish.send("stop"))},this.exit=()=>(window.removeEventListener("stockfish",this.listener,!1),this.stockfish.exit()),this.reset=()=>this.exit().then(this.init),this.search=async()=>{const e=this.startQueue.pop();e&&(this.work=e,this.curEval=void 0,this.stopped=!1,this.startQueue=[],this.ready=Fa(),await this.stockfish.setOption("MultiPV",e.multiPv),await this.stockfish.send(["position","fen",e.initialFen,"moves"].concat(e.moves).join(" ")),e.maxDepth>=99?await this.stockfish.send("go depth 99"):await this.stockfish.send("go movetime 90000 depth "+e.maxDepth))},this.listener=e=>{this.processOutput(e.output)},this.stockfish=new ae(e),this.ready=Fa(),this.ready.resolve()}isSearching(){return"pending"===this.ready.state}processOutput(e){var t;const n=e.match(/^info string (classical|NNUE) evaluation/);if(n&&(this.evaluation=n[1]),0===e.indexOf("bestmove")&&(this.ready.resolve(),null===(t=this.work)||void 0===t||t.emit()),this.stopped||void 0===this.work)return;const a=e.match(Wa);if(!a)return;const s=parseInt(a[1]),i=parseInt(a[2]),o="mate"===a[3],r=parseInt(a[4]),l=a[5],c=parseInt(a[6]),d=parseInt(a[7]),u=a[8].split(" ");if(o&&!r)return;const h=this.work.threatMode?0:1,p=this.work.ply%2===h?-r:r;if(l&&1===i)return;const m={moves:u,cp:o?void 0:p,mate:o?p:void 0,depth:s},v=c/d;if(void 0===this.curEval)this.curEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:s,knps:v,nodes:c,cp:m.cp,mate:m.mate,pvs:[m],millis:d};else{this.curEval.depth=s,this.curEval.knps=v,this.curEval.nodes=c,this.curEval.cp=m.cp,this.curEval.mate=m.mate,this.curEval.millis=d;const e=i-1;this.curEval.pvs.length>e?this.curEval.pvs[e]=m:this.curEval.pvs.push(m)}this.work.emit(this.curEval)}}class Ra{constructor(e,t){this.opts=e,this.emit=t,this.minDepth=6,this.initialized=!1,this.started=!1,this.isDeeper=!1,this.lastStarted=void 0,this.init=()=>this.engine.init().then((()=>{this.initialized=!0})),this.destroy=()=>{this.initialized&&this.engine.exit().then((()=>{this.initialized=!1,this.started=!1})).catch((()=>{this.initialized=!1,this.started=!1}))},this.stop=()=>{this.enabled()&&this.started&&(this.engine.stop(),this.started=!1)},this.toggle=()=>{this.isEnabled=!this.isEnabled},this.disable=()=>{this.isEnabled=!1},this.toggleInfinite=()=>{this.opts.infinite=!this.opts.infinite,this.restart()},this.goDeeper=()=>{this.lastStarted&&this.start(this.lastStarted.path,this.lastStarted.nodes,!1,!0)},this.onEmit=(e,t)=>{var n,a;t&&(n=t.pvs,a=e.ply%2==0?"white":"black",n.sort(((e,t)=>sa(a,t)-sa(a,e)))),t&&qa(t),this.emit(e.path,t)},this.allowed=e.allowed,this.variant=e.variant,this.isEnabled=u.analyse.enableCeval(),this.engine=new La(e.variant,e.cores,e.hashSize)}enabled(){return this.opts.allowed&&this.isEnabled}async start(e,t,n,a){if(!this.enabled())return;this.isDeeper=a;const s=t[t.length-1],i=this.effectiveMaxDepth(a);if(s.ceval&&s.ceval.depth>=i)return;const o={initialFen:t[0].fen,currentFen:s.fen,moves:t.slice(1).map((e=>function(e,t){if(0!==t.indexOf("O-O"))return e;switch(e){case"e1h1":return"e1g1";case"e1a1":return"e1c1";case"e8h8":return"e8g8";case"e8a8":return"e8c8"}return e}(e.uci,e.san))),maxDepth:n?u.analyse.cevalMaxDepth():this.effectiveMaxDepth(a),path:e,ply:s.ply,multiPv:n?1:this.opts.multiPv,threatMode:!1,emit:e=>{this.enabled()&&this.onEmit(o,e)}};this.engine.start(o),this.started=!0,this.lastStarted={path:e,nodes:t}}restart(){this.lastStarted&&this.start(this.lastStarted.path,this.lastStarted.nodes,!1,!1)}isInit(){return this.initialized}isSearching(){return this.engine.isSearching()}setMultiPv(e){this.opts.multiPv=e,this.restart()}getMultiPv(){return this.opts.multiPv}canGoDeeper(){return!this.isDeeper&&!this.opts.infinite&&!this.engine.isSearching()}getEngineName(){return this.engine.engineName}getEngineEvaluation(){return this.engine.evaluation}effectiveMaxDepth(e=!1){return e||this.opts.infinite?99:u.analyse.cevalMaxDepth()}}const qa=(()=>{const e=[];return t=>{if((e=>e.knps&&e.depth>=16&&void 0!==e.cp&&Math.abs(e.cp)<500&&e.fen.split(/\s/)[0].split(/[nbrqkp]/i).length-1>=10)(t)&&(e.push(t.knps),e.length>9)){const t=function(e){e.sort(((e,t)=>e-t));const t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}(e)||0;let n=18;t>100&&(n=19),t>150&&(n=20),t>250&&(n=21),t>500&&(n=22),t>1e3&&(n=23),t>2e3&&(n=24),t>3500&&(n=25),t>5e3&&(n=26),t>7e3&&(n=27),u.analyse.cevalMaxDepth()!==n&&u.analyse.cevalMaxDepth(n),e.length>40&&e.shift()}}})();function Va(e){return!!e.children.find((function(e){return!!e.comp}))}function Ha(e){return e.split(" ").slice(0,4).join(" ")}function Ja(e){const t=e.data.game;let n=[];const a=[];let s=[];const i={current:null,feedback:"find",minimized:!1,color:e.bottomColor()};function o(e){return s.includes(e)}function r(){const t="white"===e.bottomColor()?1:0;return n=function(e,t){const n=[];for(let a=1;a<e.length;a++){const s=e[a],i=e[a-1];t(s)&&s.eval&&i.eval&&Math.abs(ia("white",i.eval,s.eval))>.075&&Va(i)&&n.push(s)}return n}(e.mainline,(e=>e.ply%2===t&&!a.includes(e.ply))),n.find((e=>!o(e.ply)))}function c(){i.feedback="find";const n=r();if(!n)return i.current=null,l();const s={node:n,path:e.mainlinePathToPly(n.ply)},o=kt(s.path),d={node:e.tree.nodeAtPath(o),path:o},u=d.node.children.find((e=>!!e.comp));i.current={fault:s,prev:d,solution:{node:u,path:o+u.id},openingUcis:[]},"standard"===t.variant.key&&t.division&&(!t.division.middle||s.node.ply<t.division.middle)&&e.explorer.fetchMasterOpening(d.node.fen).then((e=>{const t=i.current,n=[];e.moves.forEach((e=>{e.white+e.draws+e.black>1&&n.push(e.uci)})),n.find((e=>s.node.uci===e))?(a.push(s.node.ply),setTimeout(c,100)):(t.openingUcis=n,i.current=t)})),e.userJump(d.path),l()}function d(){const t=e.node,n=i.current;if(n&&"eval"===i.feedback&&n.fault.node.ply===t.ply&&function(e){return!!e.ceval&&(e.ceval.depth>=18||e.ceval.depth>=14&&void 0!==e.ceval.millis&&e.ceval.millis>7e3)}(t)){e.stopCevalImmediately();ia(i.color,t.ceval,n.prev.node.eval)>-.035?h():p()}}function h(){i.feedback="win",l()}function p(){i.feedback="fail";const t={node:e.node,path:e.path};e.userJump(i.current.prev.path),!e.tree.pathIsMainline(t.path)&&Ge(t.node.children)&&e.tree.deleteNodeAt(t.path),l()}function m(){const e=i.feedback;return"find"===e||"fail"===e}function v(){s=[],c()}return{vm:i,isPlySolved:o,onJump:function(){const t=e.node,n=i.feedback,a=i.current;a&&("eval"!==n||a.fault.node.ply===t.ply?m()&&a.fault.node.ply===t.ply&&(a.openingUcis.some((e=>t.uci===e))||t.comp?h():t.eval?p():(i.feedback="eval",e.ceval.enabled()||(e.ceval.toggle(),e.initCeval()),d())):i.feedback="find")},jumpToCurrent:c,nextMistake:function(){s.push(i.current.fault.node.ply),c()},viewSolution:function(){i.feedback="view",e.userJump(i.current.solution.path)},hideComputerLine:function(e){return e.ply%2==0!=("white"===i.color)&&!o(e.ply)},showBadNode:function(){const t=i.current;if(t&&m()&&t.prev.path===e.path)return t.fault.node},onCeval:d,onMergeAnalysisData:function(){m()&&!i.current&&c()},isSolving:m,completion:()=>[s.length,n.length],flip(){e.settings.flip(),i.color=e.bottomColor(),v()},reset:v,pieceTheme:u.general.theme.piece(),close:e.toggleRetro,toggleWindow(){i.minimized=!i.minimized},node:()=>e.node}}function Xa(e,t){const n=e.data.game.variant.key,a=E(!1),s=E(!0),i=E(null),o=E(null),r=E(!1);function c(){e.ceval.enabled()||(e.ceval.toggle(),e.initCeval())}function d(t,n=0){if(e.gameOver(t)||t.tbhit)return!0;const a=t.ceval;return!!a&&(a.depth+n>=15||a.depth>=13&&Number(a.millis)>3e3)}function h(e){return e&&(e.winner?{mate:"white"===e.winner?10:-10}:{cp:0})}function p(e){return e.tbhit&&e.tbhit.best||e.ceval&&e.ceval.pvs[0].moves[0]}function m(t,n,a){let s,i;const o=e.gameOver(n);if("checkmate"===o)s="goodMove";else{const a=h(n.tbhit)||(n.threefold||"draw"===o?{cp:0}:n.ceval),r=h(t.tbhit)||t.ceval,l=-ia(e.bottomColor(),a,r);i=p(t),(i===n.uci||n.san.startsWith("O-O")&&i===ie[n.uci])&&(i=null),s=i?l<.025?"goodMove":l<.06?"inaccuracy":l<.14?"mistake":"blunder":"goodMove"}return{prev:t,node:n,path:a,verdict:s,best:i?{uci:i,san:v(t).unwrap((e=>Jt(e,T(i))),(e=>"--"))}:void 0}}function v(t){const n=S(t.fen).unwrap();return mt(Xt(e.data.game.variant.key),n)}function f(){return e.turnColor()===e.bottomColor()}function g(){const a=e.node;if(!s())return i(null),l();if(!$e(n,a.fen)||Fe(a.tbhit))if(c(),f()){const e=o();e&&(e.uci=p(a)||e.uci)}else{if(i(null),a.san&&d(a)){const t=e.tree.parentNode(e.path);if(d(t,1))i(m(t,a,e.path));else{const t=e.tree.parentNode(kt(e.path));d(t,1)&&i(m(t,a,e.path))}}!r()&&function(e){const n=e.ceval;return!!n&&(n.depth>=Math.min(n.maxDepth||99,t())||n.depth>=15&&(n.cloud||Number(n.millis)>5e3))}(a)?(e.playUci(p(a)),r(!0)):l()}}function y(){c(),$e(n,e.node.fen)?e.explorer.fetchTablebaseHit(e.node.fen).then((t=>{t&&e.node.fen===t.fen&&(e.node.tbhit=t),g()})).catch((()=>{Fe(e.node.tbhit)||(e.node.tbhit=null),g()})):g()}function b(){s(!0),y(),l()}return se(y),{onCeval:g,onJump(){r(!1),o(null),function(e,t){if(void 0!==t.threefold)return;const n=Ha(t.fen);let a=0;for(const t in e)Ha(e[t].fen)===n&&a++;t.threefold=a>2}(e.nodeList,e.node),y()},isMyTurn:f,comment:i,running:s,hinting:o,resume:b,playableDepth:t,reset(){i(null),o(null)},preUserJump(e,t){e!==t&&(s(!1),i(null))},postUserJump(e,t){e!==t&&f()&&b()},onUserMove(){s(!0)},playCommentBest(){const t=i();t&&(e.jump(kt(t.path)),t.best&&e.playUci(t.best.uci))},hint(){const t=e.node.ceval?e.node.ceval.pvs[0].moves[0]:null,n=o();!t||n&&"move"===n.mode?o(null):o({mode:n?"move":"piece",uci:t}),l()},currentNode:()=>e.node,bottomColor:e.bottomColor,pieceTheme:u.general.theme.piece(),minimized:a,toggleWindow(){a(!a())}}}var Ya={drop(e,t,n){if("pawn"===e&&("1"===t[1]||"8"===t[1]))return!1;if(null==n)return!0;return-1!==(Array.isArray(n)?n:n.match(/.{2}/g)||[]).indexOf(t)}};function Ka(t,n,a,s){const i={fen:n,variant:t};return s||(i.topGames=0,i.recentGames=0),"lichess"===a.db&&(a.speeds&&(i.speeds=a.speeds.join(",")),a.ratings&&(i.ratings=a.ratings.join(","))),e("https://explorer.lichess.ovh/"+a.db,{headers:{Accept:"application/json","X-Requested-With":"__delete",[oe]:"__delete"},credentials:"omit",query:i})}function Qa(t,n,a){return e("https://tablebase.lichess.ovh/"+t,{headers:{Accept:"application/json, text/*","X-Requested-With":"__delete",[oe]:"__delete"},credentials:"omit",query:{fen:n},timeout:a})}function Za(e,t){const n=E(!0),a=E(!1),s=E({moves:[]});let i={};function o(e,t){i[e]=t,s(t)}const r=!!(We(e.data)||Le(e.data)||e.data.game.offline),c="fromPosition"===e.data.game.variant.key?"standard":e.data.game.variant.key,d=tn.controller(e.data.game.variant,(function(e){e&&(i={},g())})),u=re((()=>{const e=document.getElementById("explorerTable");e&&(e.scrollTop=0)}),200);function h(){n(!1),a(!0),l()}const p=re((e=>{const t={db:d.data.db.selected(),speeds:d.data.speed.selected(),ratings:d.data.rating.selected()};return Ka(c,e,t,r).then((t=>{t.isOpening=!0,t.fen=e,o(e,t),n(!1),a(!1),l()})).catch(h)}),1e3,{leading:!0,trailing:!0}),v=re((e=>Qa(c,e).then((t=>{t.tablebase=!0,t.fen=e,o(e,t),n(!1),a(!1),l()})).catch(h)),500,{leading:!0,trailing:!0});const f={isOpening:!0,moves:[]};function g(){if("explorer"!==e.currentTab(e.availableTabs()).id)return;const t=e.node;t.ply>50&&!es(c,t.fen)&&o(t.fen,f);const d=i[t.fen];var h;d?(s(d),n(!1),a(!1)):(n(!0),h=t.fen,r&&es(c,h)?v(h):p(h)),l(),u()}return{allowed:t,setStep:g,loading:n,failing:a,config:d,withGames:r,current:s,fetchMasterOpening:function(){const e={};return function(t){return e[t]?Promise.resolve(e[t]):Ka("standard",t,{db:"masters"},!1).then((n=>(e[t]=n,n)))}}(),fetchTablebaseHit:e=>Qa(c,e,2e3).then((t=>{var n;if("unknown"===t.category)throw"unknown tablebase position";const a=Pe(e);return{fen:e,best:null===(n=t.moves[0])||void 0===n?void 0:n.uci,winner:nn(m(a),t.category)}}))}}function es(e,t){const n=t.split(/\s/)[0].split(/[nbrqkp]/i).length-1;return"standard"===e||"chess960"===e?n<=8:("atomic"===e||"antichess"===e)&&n<=7}var ts={make:(e,t,n,a)=>new le(function(e,t,n,a){const s=u.game.pieceMove();return{fen:e.fen,check:e.check,lastMove:e.lastMove,turnColor:e.turnColor,orientation:t,coordinates:u.game.coords(),movable:{free:!1,color:e.movableColor,dests:e.dests,showDests:u.game.pieceDestinations(),rookCastle:1===u.game.rookCastle()},draggable:{enabled:"drag"===s||"both"===s,magnified:u.game.magnified()},selectable:{enabled:"tap"===s||"both"===s},events:{move:n,dropNewPiece:a},premovable:{enabled:!1},highlight:{lastMove:u.game.highlights(),check:u.game.highlights()},animation:{enabled:!!u.game.animations(),duration:ce(u.game.animations())}}}(e,t,n,a))};function ns(e){return{analysisProgress(t){e.mergeAnalysisData(t)},evalHit(t){e.evalCache.onCloudEval(t)},fen(t){e.forecast&&t.id===e.data.game.id&&0!==xt(e.mainline).fen.indexOf(t.fen)&&e.forecast.reloadToLastPly()}}}const as={id:"infos",title:i("gameInformation"),className:"fa fa-info-circle"},ss={id:"moves",title:i("movesPlayed"),className:"fa fa-list-alt"},is={id:"ceval",title:"Stockfish",className:"fa fa-cogs"},os={id:"explorer",title:i("openingExplorer"),className:"fa fa-book"},rs={id:"analysis",title:i("gameAnalysis"),className:"fa fa-area-chart"},ls={id:"pgnTags",title:i("pgnTags"),className:"fa fa-tags"},cs={id:"comments",title:i("comments"),className:"fa fa-comment-o"};class ds{constructor(e,t){this.data=e,this.rootCtrl=t,this.toggleLike=()=>{this.rootCtrl.socket.send("like",{liked:!this.data.liked})},this.toggleShowComments=()=>{this.vm.showComments=!this.vm.showComments},this.actionMenu=qt.controller(this.rootCtrl),this.sideMenu=new ue("right","studyMenu","studyMenu-backdrop"),this.analyseCtrl=t,e.features.chat&&e.chat&&(this.chat=new at(t.socket,e.id,e.chat.lines,void 0,e.chat.writeable,d.isShadowban(),"Study")),this.vm={showComments:!1},null===u.study.tour()&&(Rt(this),u.study.tour(window.deviceInfo.appVersion))}canContribute(){const e=d.getUserId(),t=e&&this.data.members[e];return!!t&&"w"===t.role}createSocket(){return he.createStudy(this.data.id,(e=this,Object.assign(Object.assign({},ns(e.rootCtrl)),{liking(t){e.data.likes=t.l.likes,t.w&&t.w.s===de()&&(e.data.liked=t.l.me),l()},message(t){e.chat&&e.chat.append(t)}})));var e}}class us{constructor(e,t,n,a,s,i,o){this.data=e,this.source=n,this.orientation=a,this.shouldGoBack=s,this.promoting=null,this.onMainline=!0,this.contextMenu=null,this.replaying=!1,this.analysisProgress=!1,this.retroGlowing=!1,this._currentTabIndex=0,this.canDrop=()=>!0,this.player=()=>this.data.game.player,this.availableTabs=()=>{let e=[ss];return this.study&&this.study.data.chapter.tags.length>0&&(e=[ls,...e]),this.synthetic||(e=[as,...e]),this.study&&(e=[...e,cs]),this.retro||this.practice||!this.ceval.enabled()||(e=[...e,is]),(this.study||Ft(this.data)&&Ee(this.data))&&(e=[...e,rs]),pe()&&this.explorer.allowed&&(e=[...e,os]),e},this.currentTabIndex=e=>this._currentTabIndex>e.length-1?e.length-1:this._currentTabIndex,this.currentTab=e=>e[this.currentTabIndex(e)],this.onTabChange=e=>{this._currentTabIndex=e;const t=this.currentTab(this.availableTabs());this.updateHref(),"moves"===t.id?this.debouncedScroll():"explorer"===t.id&&this.explorer.setStep(),l()},this.resetTabs=()=>this.onTabChange(this.currentTabIndex(this.availableTabs())),this.setPath=e=>{this.path=e,this.nodeList=this.tree.getNodeList(e),this.node=xt(this.nodeList),this.mainline=Mt(this.tree.root),this.onMainline=this.tree.pathIsMainline(e)},this.initCeval=()=>{this.ceval.enabled()&&(this.ceval.isInit()?this.debouncedStartCeval():this.ceval.init().then(this.debouncedStartCeval))},this.startCeval=()=>{if(this.ceval.enabled()&&this.canUseCeval()){const e=!!this.retro||!!this.practice;this.ceval.start(this.path,this.nodeList,e,!1),this.evalCache.fetch(this.path,e?1:this.ceval.getMultiPv())}},this.stopCevalImmediately=()=>{this.ceval.stop(),this.debouncedStartCeval.cancel()},this.toggleRetro=e=>{this.retro?("backbutton"!==e&&r.backbutton.stack.pop(),this.retro=null,u.analyse.enableCeval()?this.startCeval():this.ceval.disable()):(this.stopCevalImmediately(),this.practice&&(this.practice=null),this.retro=Ja(this),r.backbutton.stack.push(this.toggleRetro),this.retro.jumpToCurrent())},this.togglePractice=()=>{this.practice||!this.ceval.allowed?this.practice=null:(this.retro&&(this.retro=null),this.practice=Xa(this,(()=>18)))},this.debouncedScroll=re((()=>Re(document.getElementById("replay"))),200),this.jump=(e,t)=>{const n=e!==this.path;this.setPath(e),this.updateBoard(),this.fetchOpening(),this.node&&this.node.san&&"forward"===t&&(-1!==this.node.san.indexOf("x")?me.throttledCapture():me.throttledMove()),this.ceval.stop(),this.debouncedExplorerSetStep(),this.updateHref(),n&&(this.retro&&this.retro.onJump(),this.practice&&this.practice.onJump(),this.debouncedStartCeval())},this.userJump=(e,t)=>{if(this.autoplay.stop(),this.practice){const n=this.path;this.practice.preUserJump(n,e),this.jump(e,t),this.practice.postUserJump(n,this.path)}else this.jump(e,t)},this.jumpToMain=e=>{this.userJump(this.mainlinePathToPly(e))},this.jumpToIndex=e=>{this.jumpToMain(e+1+(this.data.game.startedAtTurn||0))},this.canGoForward=()=>this.node.children.length>0,this.next=()=>{if(!this.canGoForward())return!1;const e=this.node.children[0];return e&&this.userJump(this.path+e.id,"forward"),!0},this.fastforward=()=>{this.replaying=!0;const e=this.next();return e||(this.replaying=!1,this.debouncedScroll()),e},this.stopff=()=>{this.replaying=!1,this.next(),this.debouncedScroll()},this.rewind=()=>{this.replaying=!0;const e=this.prev();return e||(this.replaying=!1,this.debouncedScroll()),e},this.stoprewind=()=>{this.replaying=!1,this.prev(),this.debouncedScroll()},this.toggleBookmark=()=>ve(this.data.game.id).then((()=>{this.data.bookmarked=!this.data.bookmarked,l()})).catch(c),this.playUci=e=>{const t=fe(e);"@"===e[1]?this.chessground.apiNewPiece({color:this.chessground.state.movable.color,role:ge[e[0]]},t[1]):t[2]?this.sendMove(t[0],t[1],ge[t[2].toUpperCase()]):this.sendMove(t[0],t[1]),this.explorer.loading(!0)},this.canUseCeval=()=>!this.gameOver(),this.hasAnyComputerAnalysis=()=>this.data.analysis||this.ceval.enabled(),this.hasFullComputerAnalysis=()=>Object.keys(this.mainline[0].eval||{}).length>0,this.isOfflineOrNotPlayable=()=>"offline"===this.source||!(!this.study||!this.study.data)||!Oe(this.data),this.unload=()=>{this.autoplay.stop(),this.ceval&&this.ceval.destroy()},this._deleteNode=e=>{this.tree.deleteNodeAt(e),this.contextMenu=null,bt(this.path,e)?this.userJump(kt(e)):this.jump(this.path)},this.updateHref=re((()=>{r.setQueryParams({tabId:this.currentTab(this.availableTabs()).id,ply:String(this.node.ply),curFen:this.node.fen})}),200),this.canEvalGet=e=>e.ply<15,this.sendMove=(e,t,n)=>{const a={orig:e,dest:t,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};n&&(a.promotion=n),this.practice&&this.practice.onUserMove(),it(a).then(this.addNode).catch((e=>{}))},this.userMove=(e,t,n)=>{n?me.capture():me.move(),Ye.start(this,e,t,this.sendMove)||this.sendMove(e,t)},this.userNewPiece=(e,t)=>{if(Ya.drop(e.role,t,this.node.drops)){me.move();const n={role:e.role,pos:t,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};ot(n).then(this.addNode).catch((e=>{this.jump(this.path)}))}else this.jump(this.path)},this.addNode=({situation:e,path:t})=>{const n=this.node,a={id:e.id,ply:e.ply,fen:e.fen,children:[],dests:e.dests,drops:e.drops,check:e.check,end:e.end,player:e.player,checkCount:e.checkCount,uci:e.uci,san:e.san,crazyhouse:e.crazyhouse,pgnMoves:n&&n.pgnMoves?n.pgnMoves.concat(e.pgnMoves):e.pgnMoves};if(void 0===t)return;const s=this.tree.addNode(a,t);s&&(this.jump(s),this.debouncedScroll(),l())},this.onCevalMsg=(e,t)=>{t?this.tree.updateAt(e,(n=>{n.ceval&&n.ceval.depth>=t.depth||(void 0===n.ceval?n.ceval=Object.assign({},t):(n.ceval=Object.assign(Object.assign({},n.ceval),t),t.cloud?(n.ceval.maxDepth=void 0,n.ceval.knps=void 0,n.ceval.millis=void 0):n.ceval.cloud=!1),n.ceval.pvs.length>0&&(n.ceval.best=n.ceval.pvs[0].moves[0]),e===this.path&&(this.retro&&this.retro.onCeval(),this.practice&&this.practice.onCeval(),t.cloud&&t.depth>=this.ceval.effectiveMaxDepth()&&this.ceval.stop(),l()))})):"ceval"===this.currentTab(this.availableTabs()).id&&l()},this.debouncedStartCeval=re(this.startCeval,500,{trailing:!0}),this.getNodeSituation=re((()=>{this.node&&!this.node.dests&&rt({variant:this.data.game.variant.key,fen:this.node.fen,path:this.path}).then((({situation:e,path:t})=>{this.tree.updateAt(t,(t=>{t.dests=e.dests,t.end=e.end,t.player=e.player})),t===this.path&&(this.updateBoard(),l(),this.gameOver()&&this.stopCevalImmediately())})).catch((e=>{}))}),50),this.fetchOpening=re((()=>{if(pe()&&this.node&&void 0===this.node.opening&&this.node.ply<=20&&this.node.ply>0&&ye.has(this.data.game.variant.key)){const e={fen:this.node.fen,path:this.path},t=this.data.game.variant.key;"standard"!==t&&(e.variant=t),this.tree.updateAt(this.path,(t=>{t.opening=null,this.socket.ask("opening","opening",e).then((e=>{e.opening&&e.path&&(t.opening=e.opening,e.path===this.path&&l())})).catch(be)}))}}),50),this.synthetic=We(e),this.ongoing=!this.synthetic&&Oe(e),this.initialPath=Ct,this.study=void 0!==t?new ds(t,this):void 0,this.forecast=e.forecast?new ya(e):void 0,this._currentTabIndex=this.study&&0!==this.study.data.chapter.tags.length||!this.synthetic?1:0,-1===u.analyse.supportedVariants.indexOf(this.data.game.variant.key)&&(P.show({text:`Analysis board does not support ${this.data.game.variant.name} variant.`,position:"center",duration:"short"}),r.set("/")),this.tree=Nt(Pt(this.data.treeParts)),this.settings=Vt.controller(this),this.menu=Wt.controller(this),this.continuePopup=vt.controller(),this.autoplay=new $a(this),this.notes=d.isConnected()&&"correspondence"===this.data.game.speed?new tt(this.data):null,this.retro=null,this.practice=null;const h=(()=>{const e=this.study&&this.study.data;if(!qe.includes(this.data.game.variant.key))return!1;if(e&&!e.chapter.features.computer&&!e.chapter.practice)return!1;return!!S(this.data.game.fen).unwrap((e=>mt(we(this.data.game.variant.key),e).unwrap((()=>!0),(()=>!1))),(()=>!1))&&this.isOfflineOrNotPlayable()})();this.ceval=new Ra({allowed:h,variant:this.data.game.variant.key,multiPv:u.analyse.cevalMultiPvs(),cores:u.analyse.cevalCores(),hashSize:u.analyse.cevalHashSize(),infinite:u.analyse.cevalInfinite()},this.onCevalMsg);const p=!this.study||this.study.data.chapter.features.explorer;this.explorer=Za(this,p),this.debouncedExplorerSetStep=re(this.explorer.setStep,ce(u.game.animations())+50);const m=void 0!==i?i:this.tree.lastPly();this.gamePath=this.synthetic||this.ongoing?void 0:St(Mt(this.tree.root));const v=Mt(this.tree.root);if(this.initialPath=Tt(v,(e=>e.ply<=m)),this.setPath(this.initialPath),this.data.game.createdAt&&(this.formattedDate=ke(new Date(this.data.game.createdAt))),this.study?this.socket=this.study.createSocket():!this.data.analysis&&d.isConnected()&&Ft(this.data)&&Ee(this.data)&&void 0!==this.data.url&&void 0!==this.data.player.version?this.socket=he.createGame(this.data.url.socket,this.data.player.version,ns(this),this.data.url.round):this.socket=he.createAnalysis(ns(this)),this.synthetic||setTimeout((()=>{this.socket.send("startWatching",this.data.game.id)}),1e3),this.evalCache=function({variant:e,canGet:t,getNode:n,receive:a,socketIface:s}){const i=new Set;return{fetch(a,o){const r=n();if(r.ceval&&r.ceval.cloud||!t(r))return;if(i.has(r.fen))return;i.add(r.fen);const l={fen:r.fen,path:a};"standard"!==e&&(l.variant=e),o>1&&(l.mpv=o),s.send("evalGet",l)},onCloudEval(e){a(e.path,function(e){const t={fen:e.fen,nodes:1e3*e.knodes,depth:e.depth,pvs:e.pvs.map((e=>{const t={moves:e.moves.split(" ")};return void 0!==e.cp?t.cp=e.cp:t.mate=e.mate,t})),cloud:!0};return void 0!==t.pvs[0].cp?t.cp=t.pvs[0].cp:t.mate=t.pvs[0].mate,t.cloud=!0,t}(e))}}}({variant:this.data.game.variant.key,canGet:this.canEvalGet,getNode:()=>this.node,receive:this.onCevalMsg,socketIface:this.socket}),this.updateBoard(),o){const e=this.currentTabIndex(this.availableTabs()),t=this.availableTabs().findIndex((e=>e.id===o));t>=0&&e!==t&&this.onTabChange(t)}"explorer"===this.currentTab(this.availableTabs()).id&&this.debouncedExplorerSetStep(),setTimeout(this.debouncedScroll,250),setTimeout(this.initCeval,1e3)}playerName(e){const t=je(this.data,e);return this.study?Vn(this.study.data,e)||"Anonymous":F(t)}topColor(){return m(this.bottomColor())}bottomColor(){return this.settings.s.flip?m(this.data.orientation):this.data.orientation}turnColor(){return Ve(this.node.ply)}promote(e,t){this.tree.promoteAt(e,t),this.contextMenu=null,this.jump(e)}deleteNode(e){const t=this.tree.nodeAtPath(e);if(!t)return;const n=_t(t);n.nodes>=10||n.comments>0?xe.confirm({title:"Confirm",message:`Delete ${n.nodes} move(s)`+(n.comments?` and ${n.comments} comment(s)`:"")+"?"}).then((()=>this._deleteNode(e))):this._deleteNode(e)}restartPractice(){this.practice=null,this.togglePractice()}mergeAnalysisData(e){this.analysisProgress||(this.analysisProgress=!0,l()),this.tree.merge(e.tree),this.data.analysis=e.analysis;const t=Mt(e.tree);t.every((e=>void 0!==e.eval||!(!e.san||!e.san.includes("#"))))&&(this.data.treeParts=t,this.analysisProgress=!1,this.retroGlowing=!0,setTimeout((()=>{this.retroGlowing=!1,l()}),8e3),me.dong(),lt.quick(),l()),this.retro&&this.retro.onMergeAnalysisData(),l()}gameOver(e){const t=e||this.node;if(!t)return!1;if(void 0===t.end){if(t.check){const e=t.san;return!!!(!e||"#"!==e[e.length-1])&&"checkmate"}return!1}return!!t.end&&(t.check?"checkmate":"draw")}nextNodeBest(){return Ot(this.node,(e=>e.eval?e.eval.best:void 0))}mainlinePathToPly(e){return Tt(this.mainline,(t=>t.ply<=e))}prev(){return this.userJump(kt(this.path),"backward"),!0}updateBoard(){const e=this.node;"threeCheck"!==this.data.game.variant.key||e.checkCount||(e.checkCount=He(e.fen));const t=Ve(e.ply),n=Me(e.dests),a={fen:e.fen,turnColor:t,orientation:this.settings.s.flip?m(this.orientation):this.orientation,movableColor:this.gameOver()?null:t,dests:n||null,check:!!e.check,lastMove:e.uci?L(e.uci):null};this.cgConfig=a,this.data.game.player=t,this.chessground?this.chessground.set(a):this.chessground=ts.make(a,this.orientation,this.userMove,this.userNewPiece),n||this.getNodeSituation()}}export{us as A,Ea as a,$t as g,Ia as l,Aa as o,Ba as r};
