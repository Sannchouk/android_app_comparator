import{f as e,bb as t,a5 as a,m as n,C as s,q as i,D as o,w as r,ah as l,r as c,a7 as d,b as u,g as h,bG as p,bH as m,aH as v,a8 as f,bI as g,bh as y,bJ as b,bK as w,bL as k,bM as x,bN as M,bO as C,bP as P,bQ as N,a2 as T,a9 as S,bR as _,S as I,E as O,o as A,ag as E,bS as B,z as G,aS as z,ar as D,an as j,aR as U,bT as $,aO as F,aX as W,aI as L,bk as R,bl as q,bz as H,bj as V,bU as J,bV as X,bW as K,bw as Y,ab as Q,bX as Z,B as ee,I as te,bg as ae,b8 as ne,bY as se,bc as ie,d as oe,b3 as re,b2 as le,bZ as ce,b_ as de,s as ue,k as he,aE as pe,bC as me,b$ as ve,c0 as fe,c1 as ge,n as ye,c2 as be,c3 as we,by as ke,c4 as xe}from"./main.js";import{l as Me}from"./layout-e08f9316.js";import{l as Ce}from"./html-1975aa10.js";import{e as Pe,c as Ne,r as Te}from"./fen-f2d95e2d.js";import{T as Se,a as _e}from"./TabView-de024605.js";import{y as Ie,p as Oe,z as Ae,A as Ee,B as Be,C as Ge,D as ze,E as De,F as je,k as Ue,g as $e,G as Fe,H as We,I as Le,b as Re,J as qe,K as He,L as Ve,M as Je}from"./game-0dbfee7c.js";import{B as Xe}from"./Board-0a9e6a9d.js";import{v as Ke,p as Ye}from"./promotion-0e7cb1ce.js";import{S as Qe}from"./index-c282ab51.js";import{g as Ze,C as et,t as tt,n as at,N as nt}from"./toInteger-d296e300.js";import{c as st,C as it}from"./chat-e47e82a7.js";import{p as ot,m as rt,d as lt,s as ct}from"./chess-ef477519.js";import{v as dt}from"./vibrate-5137c134.js";import{k as ut,q as ht,r as pt,b as mt,a as vt,s as ft,c as gt}from"./variant-1fcc5716.js";import{s as yt,a as bt}from"./studyXhr-30328b6a.js";import{c as wt,h as kt,i as xt,l as Mt,m as Ct,r as Pt,b as Nt,a as Tt,f as St,t as _t,d as It,w as Ot}from"./tree-aeadfd0f.js";import{c as At,l as Et,x as Bt,y as Gt,a as zt,p as Dt,s as jt,b as Ut,d as $t}from"./axis-5bab4d8c.js";function Ft(t,a){return e(`/${t}/${a}/analysis`)}function Wt(e){return void 0!==e.url}var Lt={controller(e){let t=!1;function a(e){"backbutton"!==e&&t&&r.backbutton.stack.pop(),t=!1,n.showShareMenu=!1}const n={showShareMenu:!1,computingPGN:!1,computingPGNAnnotated:!1};return{open:function(){r.backbutton.stack.push(a),t=!0},close:a,isOpen:()=>t,root:e,s:n}},view:e=>a("analyse_menu",void 0,(()=>e.s.showShareMenu?function(e){return n("div.analyseMenu",n.fragment({key:"shareMenu"},[Wt(e.data)?n("button",{oncreate:s((()=>{e.menu.close(),Qe.share({url:Ie(e.data)})}))},[i("shareGameUrl")]):null,"offline"===e.source?n("button",{oncreate:s((()=>{!function(e){if(!e.menu.s.computingPGN){e.menu.s.computingPGN=!0;const t=e.tree.lastNode(),a="white"===e.data.player.color?"offline_ai"===e.data.game.id?u.appUser("Anonymous"):"Anonymous":"offline_ai"===e.data.game.id?e.data.opponent.username:"Anonymous",n="black"===e.data.player.color?"offline_ai"===e.data.game.id?u.appUser("Anonymous"):"Anonymous":"offline_ai"===e.data.game.id?e.data.opponent.username:"Anonymous";ot({variant:e.data.game.variant.key,initialFen:e.data.game.initialFen,pgnMoves:t.pgnMoves||[],white:a,black:n}).then((t=>{e.menu.s.computingPGN=!1,e.menu.close(),c(),Qe.share({text:t.pgn})})).catch((t=>{e.menu.s.computingPGN=!1,c()}))}}(e)}))},e.menu.s.computingPGN?o.getVdom("monochrome"):[i("sharePgn")]):null,"online"!==e.source||Oe(e.data)?null:n("button",{oncreate:s((()=>{Rt(e,!1)}))},e.menu.s.computingPGNAnnotated?o.getVdom("monochrome"):"Share annotated PGN"),"online"!==e.source||Oe(e.data)?null:n("button",{oncreate:s((()=>{Rt(e,!0)}))},e.menu.s.computingPGN?o.getVdom("monochrome"):"Share raw PGN"),Wt(e.data)?n("button",{oncreate:s((()=>{e.menu.close(),Qe.share({url:Ae(e.data)})}))},["Share game GIF"]):null,e.isOfflineOrNotPlayable()?n("button",{oncreate:s((()=>{e.menu.close(),Qe.share({text:e.node.fen})}))},"Share current FEN"):null]))}(e.root):function(e){return n("div.analyseMenu",n.fragment({key:"analyseMenu"},[n("button",{oncreate:s((()=>{e.menu.s.showShareMenu=!0}))},[n("span.fa.fa-share"),i("shareAndExport")]),e.isOfflineOrNotPlayable()?n("button[data-icon=U]",{oncreate:s((()=>{e.menu.close(),e.continuePopup.open(e.node.fen,e.data.game.variant.key,e.data.player.color)}))},i("continueFromHere")):null,e.isOfflineOrNotPlayable()?n("button",{oncreate:s((()=>r.set(`/editor/${encodeURIComponent(e.node.fen)}`)))},[n("span.fa.fa-pencil"),i("boardEditor")]):null,e.data.analysis?n("button",{oncreate:s((()=>{e.menu.close(),e.toggleRetro()})),disabled:!!e.retro},[n("span.fa.fa-play"),i("learnFromYourMistakes")]):null,e.ceval.allowed?n("button",{oncreate:s((()=>{e.menu.close(),e.togglePractice()}))},[n("span.fa.fa-bullseye"),i("practiceWithComputer")]):null,e.ceval.allowed?n("button",{className:l({on:e.showThreat}),oncreate:s((()=>{e.menu.close(),e.toggleShowThreat()}))},[n("span.fa.fa-crosshairs"),i("showThreat")]):null,e.notes?n("button",{oncreate:s((()=>{e.notes&&(e.menu.close(),e.notes.open())}))},[n("span.fa.fa-pencil"),i("notes")]):null]))}(e.root)),e.isOpen(),e.close)};function Rt(e,t){(t&&!e.menu.s.computingPGN||!t&&!e.menu.s.computingPGNAnnotated)&&(t?e.menu.s.computingPGN=!0:e.menu.s.computingPGNAnnotated=!0,Ze(e.data.game.id,t).then((t=>{e.menu.s.computingPGN=!1,e.menu.s.computingPGNAnnotated=!1,e.menu.close(),c(),Qe.share({text:t})})).catch((t=>{e.menu.s.computingPGN=!1,e.menu.s.computingPGNAnnotated=!1,c(),d(t)})))}function qt(e){(function(){const e="light"===h.general.theme.background()?"shepherd-theme-dark":"shepherd-theme-default";return p(`vendor/shepherd/css/${e}.css`).then((()=>p("vendor/shepherd/css/shepherd.css"))).then((()=>m("vendor/shepherd/js/tether.js"))).then((()=>m("vendor/shepherd/js/shepherd.min.js"))).then((()=>e))})().then((t=>{const a=new window.Shepherd.Tour({defaults:{classes:"shepherd-element "+t,showCancelLink:!0}});a.addStep("welcome",{title:"Welcome to lichess study!",text:"This is a shared analysis board.<br><br>Use it to analyse games,<br>discuss positions with friends,<br>and of course for chess lessons!"}),a.addStep("members",{title:"Study members",text:"<i data-icon='v'></i> Spectators can view the study and talk in the chat.<br><br><i class='fa fa-user'></i> Contributors can make moves and update the study.<br><br>Studies are for now read-only in the application, so you must go to lichess.org to contribute to them. More features will come later in lichess app.",when:{"before-show":()=>{e.sideMenu.open()}}}),a.addStep("chapters",{title:"Study chapters",text:"A study can contain several chapters.<br>Each chapter has a distinct initial position and move tree.",when:{"before-show":()=>{e.sideMenu.open()}},buttons:[{text:"Done",action:a.next}]}),a.start()}))}var Ht={controller(e){let t=!1;const a={showShareMenu:!1,loadingStudyPGN:!1,loadingChapterPGN:!1};function n(e){"backbutton"!==e&&t&&r.backbutton.stack.pop(),t=!1,a.showShareMenu=!1}return{open:function(){r.backbutton.stack.push(n),t=!0},close:n,isOpen:()=>t,root:e,s:a}},view:e=>a("analyse_menu",void 0,(()=>e.s.showShareMenu?function(e){function t(t){e.study.actionMenu.s.loadingChapterPGN=!1,e.study.actionMenu.s.loadingStudyPGN=!1,c(),Qe.share({text:t})}function a(t){e.study.actionMenu.s.loadingChapterPGN=!1,e.study.actionMenu.s.loadingStudyPGN=!1,c(),d(t)}return n("div.analyseMenu",{key:"shareMenu"},[n("button",{oncreate:s((()=>{const t=`https://lichess.org/study/${e.study.data.id}`;Qe.share({url:t})}))},[i("studyUrl")]),n("button",{oncreate:s((()=>{const t=`https://lichess.org/study/${e.study.data.id}/${e.study.data.chapter.id}`;Qe.share({url:t})}))},[i("currentChapterUrl")]),n("button",{oncreate:s((()=>{e.study.actionMenu.s.loadingStudyPGN=!0,yt(e.study.data.id).then(t).catch(a)}))},e.study.actionMenu.s.loadingStudyPGN?o.getVdom("monochrome"):[i("studyPgn")]),n("button",{oncreate:s((()=>{e.study.actionMenu.s.loadingChapterPGN=!0,bt(e.study.data.id,e.study.data.chapter.id).then(t).catch(a)}))},e.study.actionMenu.s.loadingChapterPGN?o.getVdom("monochrome"):[i("chapterPgn")])])}(e.root):function(e){return n("div.analyseMenu",{key:"studyMenu"},[n("button",{oncreate:s((()=>{e.study.actionMenu.s.showShareMenu=!0}))},[n("span.fa.fa-share"),i("shareAndExport")]),n("button",{oncreate:s(e.study.toggleLike)},[n.trust("&nbsp;"),n("span.fa",{className:e.study.data.liked?"fa-heart":"fa-heart-o"}),`Like (${e.study.data.likes})`]),e.study&&e.study.chat?n("button[data-icon=B]",{oncreate:s(e.settings.flip)},i("flipBoard")):null,n("button[data-icon=U]",{oncreate:s((()=>{e.menu.close(),e.continuePopup.open(e.node.fen,e.data.game.variant.key,e.data.player.color)}))},i("continueFromHere")),e.ceval.allowed?n("button",{oncreate:s((()=>{e.menu.close(),e.togglePractice()}))},[n("span.fa.fa-bullseye"),i("practiceWithComputer")]):null,n("button",{oncreate:s((()=>r.set(`/editor/${encodeURIComponent(e.node.fen)}`)))},[n("span.fa.fa-pencil"),i("boardEditor")]),n("button",{oncreate:s((()=>{e.study.actionMenu.close(),qt(e.study)}))},[n("span.fa.fa-question-circle"),"Help"])])}(e.root)),e.isOpen(),e.close)};const Vt={view:({attrs:{text:e}})=>e.split("\n").map((e=>n.fragment({},[n.trust(Ce(e)),n("br")])))};var Jt={controller(e){let t=!1,a=h.analyse.cevalCores(),n=h.analyse.cevalHashSize(),s=h.analyse.cevalUseNNUE();function i(e){"backbutton"!==e&&t&&r.backbutton.stack.pop(),t=!1,h.analyse.cevalCores()===a&&h.analyse.cevalHashSize()===n&&h.analyse.cevalUseNNUE()===s||r.reload()}const o={smallBoard:h.analyse.smallBoard(),showBestMove:h.analyse.showBestMove(),showComments:h.analyse.showComments(),flip:!1};return{root:e,open:function(){r.backbutton.stack.push(i),a=h.analyse.cevalCores(),n=h.analyse.cevalHashSize(),s=h.analyse.cevalUseNNUE(),t=!0},close:i,isOpen:()=>t,s:o,toggleBoardSize(){const e=!o.smallBoard;h.analyse.smallBoard(e),o.smallBoard=e},toggleBestMove(){const e=!o.showBestMove;o.showBestMove=e},toggleComments(){const e=!o.showComments;o.showComments=e},flip(){o.flip=!o.flip,e.chessground.set({orientation:o.flip?v(e.orientation):e.orientation}),e.retro&&e.toggleRetro(),e.practice&&e.restartPractice()},cevalSetMultiPv(t){h.analyse.cevalMultiPvs(t),e.ceval.setMultiPv(t)},cevalToggleInfinite(){e.ceval.toggleInfinite()}}},view:e=>a("analyse_menu",void 0,(()=>function(e){const t=y(),a=window.deviceInfo.stockfishMaxMemory;return n("div.analyseSettings",[n("div.action",{className:!e.ceval.allowed||e.retro?"disabled":""},[f.renderCheckbox(i("toggleLocalEvaluation"),"allowCeval",h.analyse.enableCeval,(t=>{e.ceval.toggle(),t?e.initCeval():(e.ceval.destroy(),e.resetTabs(),e.retro&&(e.retro.close(),e.retro=null))}),!e.ceval.allowed||!!e.retro),n("small.caution",i("localEvalCaution"))]),e.study||e.ceval.allowed?n("div.action",[f.renderCheckbox(i("bestMoveArrow"),"showBestMove",h.analyse.showBestMove,e.settings.toggleBestMove)]):null,e.study||"online"===e.source&&Wt(e.data)&&Ee(e.data)?n("div.action",[f.renderCheckbox(i("keyShowOrHideComments"),"showComments",h.analyse.showComments,e.settings.toggleComments)]):null,n("div.action",[f.renderCheckbox(i("infiniteAnalysis"),"ceval.infinite",h.analyse.cevalInfinite,e.settings.cevalToggleInfinite,!e.ceval.allowed)]),g()?n("div.action",[f.renderCheckbox(i("Use NNUE"),"ceval.useNNUE",h.analyse.cevalUseNNUE,void 0,!e.ceval.allowed)]):null,n("div.action",[f.renderSlider(i("multipleLines"),"ceval.multipv",1,5,1,h.analyse.cevalMultiPvs,e.settings.cevalSetMultiPv,!e.ceval.allowed)]),t>1?n("div.action",[f.renderSlider(i("cpus"),"ceval.cores",1,t,1,h.analyse.cevalCores,void 0,!e.ceval.allowed)]):null,a>32?n("div.action",[f.renderSlider(i("memory"),"ceval.hashSize",16,a,16,h.analyse.cevalHashSize,void 0,!e.ceval.allowed)]):null])}(e.root)),e.isOpen(),e.close)};function Xt(e,t){let a="";if(b(t))"pawn"!==t.role&&(a=w(t.role).toUpperCase()),a+="@"+k(t.to);else{const n=e.board.getRole(t.from);if(!n)return"--";if("king"!==n||!e.board[e.turn].has(t.to)&&2!==Math.abs(t.to-t.from)){const s=e.board.occupied.has(t.to)||"pawn"===n&&x(t.from)!==x(t.to);if("pawn"!==n){let s;if(a=w(n).toUpperCase(),s="king"===n?ut(t.to).intersect(e.board.king):"queen"===n?ht(t.to,e.board.occupied).intersect(e.board.queen):"rook"===n?pt(t.to,e.board.occupied).intersect(e.board.rook):"bishop"===n?mt(t.to,e.board.occupied).intersect(e.board.bishop):vt(t.to).intersect(e.board.knight),s=s.intersect(e.board[e.turn]).without(t.from),s.nonEmpty()){const n=e.ctx();for(const a of s)e.dests(a,n).has(t.to)||(s=s.without(a));if(s.nonEmpty()){let e=!1,n=s.intersects(M.fromRank(C(t.from)));s.intersects(M.fromFile(x(t.from)))?e=!0:n=!0,n&&(a+=P[x(t.from)]),e&&(a+=N[C(t.from)])}}}else s&&(a=P[x(t.from)]);s&&(a+="x"),a+=k(t.to),t.promotion&&(a+="="+w(t.promotion).toUpperCase())}else a=t.to>t.from?"O-O":"O-O-O"}return a}function Kt(e,t){return function(e,t){var a;const n=Xt(e,t);return e.play(t),(null===(a=e.outcome())||void 0===a?void 0:a.winner)?n+"#":e.isCheck()?n+"+":n}(e.clone(),t)}function Yt(e){switch(e){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return e}}function Qt(e){const t=e.node,a=t.threat||t.ceval,o=h.analyse.cevalInfinite();return a?n("div.analyse-fixedBar.ceval-infos",{className:a.cloud?"cloud":""},[n("div.depth",[n("span",i("depthX",a.depth+(o||void 0===a.maxDepth?"":`/${a.maxDepth}`))),e.ceval.canGoDeeper()?n("button.fa.fa-plus-square",{oncreate:s(e.ceval.goDeeper,(()=>{T.show({text:i("goDeeper"),position:"center",duration:"short"})}))}):null]),void 0!==a.millis?n("div.time",[i("time")," ",Zt(a.millis)]):null,void 0!==a.knps?n("div.knps",["kn/s ",Math.round(a.knps)]):null,a.cloud?n("span.ceval-cloud","Cloud"):null]):null}function Zt(e){const t=Math.round(e/1e3);if(t<60)return t+"s";return`${Math.round(t/60)}min ${t%60}s`}function ea(e){const t=e.ceval.getMultiPv(),a=e.node,s=a.threat||a.ceval;if(s&&!e.gameOver()){const i=s.pvs;return n("ul.ceval-pv_box.native_scroller",{oncreate:I((t=>function(e,t){const a=O(t),n=a&&a.dataset.uci;!e.showThreat&&n&&e.playUci(n)}(e,t)),void 0,O)},[...Array(t).keys()].map((t=>{if(!i[t])return n("li.pv");const s=ft(Yt(e.ceval.variant),S(a.fen).unwrap());return n("li.ceval-pv",{"data-uci":i[t].moves[0],className:t%2==0?"even":"odd"},[n("strong.ceval-pv_eval",void 0!==i[t].mate?"#"+i[t].mate:Ge(i[t].cp)),n("div.ceval-pv-line",s.unwrap((e=>function(e,t){var a;e=e.clone();const n=[];for(let s=0;s<t.length;s++){0!==s&&n.push(" "),"white"===e.turn?n.push(e.fullmoves,". "):0===s&&n.push(e.fullmoves,"... ");const i=Xt(e,t[s]);if(e.play(t[s]),n.push(i),"--"===i)return n.join("");s===t.length-1&&(null===(a=e.outcome())||void 0===a?void 0:a.winner)?n.push("#"):e.isCheck()&&n.push("+")}return n.join("")}(e,i[t].moves.slice(0,12).map((e=>_(e))))),(e=>"--")))])})))}return e.gameOver()?n("div.ceval-pv_box.native_scroller.loading.gameOver",[n("i.withIcon[data-icon=]"),i("gameOver")]):n("div.ceval-pv_box.native_scroller.loading",aa())}const ta={onbeforeupdate:({attrs:e})=>!e.ctrl.replaying,view({attrs:e}){const{ctrl:t}=e,a=t.node,s=t.showThreat&&t.node.threat||Be({client:a.ceval,server:a.eval});if(!t.ceval.enabled()&&!s)return null;let i;return i=s&&void 0!==s.cp?Ge(s.cp):s&&void 0!==s.mate?"#"+s.mate:t.gameOver()?"-":t.replaying?"":aa(),n("div",{className:"ceval-curEval"},i)}};function aa(){return n("div.spinner.fa.fa-hourglass-half")}var na={controller(e,t){const a=["lichess"];"standard"!==e.key&&"fromPosition"!==e.key||a.push("masters");const n=E(!1),s={db:{available:a,selected:a.length>1?h.analyse.explorer.db:function(){return a[0]}},rating:{available:h.analyse.explorer.availableRatings,selected:h.analyse.explorer.rating},speed:{available:h.analyse.explorer.availableSpeeds,selected:h.analyse.explorer.speed}};let i;function o(){return JSON.stringify([s.db.selected(),s.rating.selected(),s.speed.selected()])}function l(e){"backbutton"!==e&&n()&&r.backbutton.stack.pop(),n(!1),t(i!==o())}function c(e,t){-1===e().indexOf(t)?e(e().concat([t])):e().length>1&&e(e().filter((e=>e!==t)))}return{open:n,data:s,toggleOpen(){n()?l():(r.backbutton.stack.push(l),i=o(),n(!0))},toggleDb(e){s.db.selected(e)},toggleRating:e=>c(s.rating.selected,e),toggleSpeed:e=>c(s.speed.selected,e),fullHouse:()=>"masters"===s.db.selected()||s.rating.selected().length===s.rating.available.length&&s.speed.selected().length===s.speed.available.length,serialize:o}},view(e){const t=e.data;return[n("section.db",[n("label",i("database")),n("div.form-multipleChoice",t.db.available.map((a=>n("div",{className:t.db.selected()===a?"selected":"",oncreate:A((()=>e.toggleDb(a)))},a))))]),"masters"===t.db.selected()?n("div.masters.message",[n("i[data-icon=C]"),n("p",i("masterDbExplanation","2200","1952","2020"))]):n("div",[n("section.rating",[n("label",i("averageElo")),n("div.form-multipleChoice",t.rating.available.map((a=>n("div",{className:t.rating.selected().indexOf(a)>-1?"selected":"",oncreate:A((()=>e.toggleRating(a)))},a))))]),n("section.speed",[n("label",i("timeControl")),n("div.form-multipleChoice",t.speed.available.map((a=>n("div",{className:t.speed.selected().indexOf(a)>-1?"selected":"",oncreate:A((()=>e.toggleSpeed(a)))},a))))])]),n("section.save",n("button.text[data-icon=E]",{oncreate:A(e.toggleOpen)},i("allSet")))]}};function sa(e,t){return"loss"===t||"maybe-loss"===t||"blessed-loss"===t?e:"win"===t||"maybe-win"===t||"cursed-win"===t?v(e):void 0}const ia={onbeforeupdate:({attrs:e},{attrs:t})=>e.data!==t.data,view({attrs:e}){const{ctrl:t,data:a}=e,s=function(e,t){if(!t.length)return null;const a=h.game.pieceNotation();return n("table",{className:"moves",oncreate:I((t=>function(e,t){const a=ra(t),n=a&&a.dataset.uci;n&&e.playUci(n)}(e,t)),void 0,ra)},n("thead",null,n("tr",null,n("th",{className:"explorerMove-move"},i("move")),n("th",{className:"explorerMove-games"},i("games")),n("th",{className:"explorerMove-result"},i("whiteDrawBlack")))),n("tbody",{className:a?"displayPieces":""},t.map((e=>n("tr",{key:e.uci,"data-uci":e.uci},n("td",{className:"explorerMove-move"},"P"===e.san[0]?e.san.slice(1):e.san),n("td",{className:"explorerMove-games"},e.white+e.draws+e.black),n("td",{className:"explorerMove-result"},function(e){const t=e.white+e.draws+e.black;function a(a){const s=e[a],i=100*s/t,o=Math.round(1e3*s/t)/10+"%";return 0===i?null:n("span",{className:"explorerBar "+a,style:{width:o}},i>12?Math.round(i)+(i>20?"%":""):null)}return["white","draws","black"].map(a)}(e)))))))}(t,a.moves),o=la(t,i("recentGames"),a.recentGames||[]),r=la(t,i("topGames"),a.topGames||[]);return s||o||r?n("div",{className:"explorer-data"},s,r,o):oa(t)}};function oa(e){return n("div",{className:"explorer-data empty"},n("div",{className:"message"},n("h3",null,n("i",{className:"withIcon","data-icon":""}),i("noGameFound")),e.explorer.config.fullHouse()?null:n("p",null,i("maybeIncludeMoreGamesFromThePreferencesMenu"))))}function ra(e){const t=e.target;return"TR"===t.tagName?t:t.closest("tr")}function la(e,t,a){return e.explorer.withGames&&a.length?n("table",{className:"games",oncreate:I((t=>function(e,t){const a=e.chessground.state.orientation,n=ra(t),s=n&&n.dataset.id;s&&"lichess"===e.explorer.config.data.db.selected()?r.set(`/analyse/online/${s}/${a}`):s&&B(s,a).then((e=>r.set(`/analyse/online/${e.game.id}/${a}`)))}(e,t)),void 0,ra)},n("thead",null,n("tr",null,n("th",{colspan:"4"},t))),n("tbody",null,a.map((e=>{return n("tr",{key:e.id,"data-id":e.id},n("td",null,[e.white,e.black].map((e=>n("span",null,e.rating)))),n("td",null,[e.white,e.black].map((e=>n("span",null,e.name)))),n("td",null,"white"===(t=e.winner)?n("result",{className:"white"},"1-0"):"black"===t?n("result",{className:"black"},"0-1"):n("result",{className:"draws"},"½-½")),n("td",null,e.year));var t})))):null}function ca(e){return"standard"===e.data.game.variant.key||"fromPosition"===e.data.game.variant.key?i("openingExplorer"):i("xOpeningExplorer",e.data.game.variant.name)}function da(e,t,a,s){if(!a.length)return null;const o=function(e){return"w"===e.split(" ")[1]?"white":"black"}(s);return[n("div",{className:"title"},t),n("table",{className:"explorerTablebase",oncreate:I((t=>function(e,t){const a=ra(t),n=a&&a.dataset.uci;n&&e.playUci(n)}(e,t)),void 0,ra)},n("tbody",null,a.map((e=>n("tr",{"data-uci":e.uci,key:e.uci},n("td",null,e.san),n("td",null,function(e,t){if(t.checkmate)return n("result."+sa(e,t.category),i("checkmate"));if(t.stalemate)return n("result.draws",i("stalemate"));if(t.variant_win)return n("result."+sa(e,t.category),i("variantWin"));if(t.variant_loss)return n("result."+sa(e,t.category),i("variantLoss"));if(t.insufficient_material)return n("result.draws",i("insufficientMaterial"));if(null===t.dtz)return null;if(0===t.dtz)return n("result.draws",i("draw"));if(t.zeroing){const a=-1!==t.san.indexOf("x");return n("result."+sa(e,t.category),i(a?"capture":"pawnMove"))}return n("result."+sa(e,t.category),{title:i("dtzWithRounding")+" (Distance To Zeroing)"},"DTZ "+Math.abs(t.dtz))}(o,e),function(e,t){return t.dtm?n("result."+sa(e,t.category),{title:G("mateInXHalfMoves",Math.abs(t.dtm))},"DTM "+Math.abs(t.dtm)):null}(o,e)))))))]}function ua(e){return n("div.explorer-data.empty",[n("div.message",[n("h3",[n("i.withIcon[data-icon=]"),e])])])}function ha(e){return e.node.crazyhouse?n("div.analyse-crazyPockets",[pa(e),ma(e)]):null}function pa(e){const t=e.node.crazyhouse;return t?n(et,{ctrl:e,crazyData:t,color:e.orientation}):null}function ma(e){const t=e.node.crazyhouse;return t?n(et,{ctrl:e,crazyData:t,color:v(e.orientation)}):null}function va(e){if(!e.contextMenu)return null;const t=e.contextMenu,n=e.tree.nodeAtPath(t),s=e.tree.pathIsMainline(t);return a("analyse-cm",(()=>ze(n)),(()=>[s?null:fa("S",i("promoteVariation"),(()=>e.promote(t,!1))),s?null:fa("E",i("makeMainLine"),(()=>e.promote(t,!0))),fa("q",i("deleteFromHere"),(()=>e.deleteNode(t)))]),!0,(()=>{e.contextMenu=null,c()}))}function fa(e,t,a){return n("button.withIcon",{"data-icon":e,oncreate:I(a)},t)}function ga(e,t){return!e.ctrl.settings.s.showComments||De(t.comments)?[]:t.comments.map((t=>"lichess"!==t.by||e.showComputer?n("comment",n(Vt,{text:t.text})):null)).filter((e=>!!e))}function ya(e,t,a){const s=t.children,i=s[0];return i?a.isMainline?s[1]?ba(e,s,a)||[Ca(e,i,{parentPath:a.parentPath,isMainline:!0,withIndex:a.withIndex}),ga(e,i),n("interrupt",wa(e,s.slice(1),{parentPath:a.parentPath,isMainline:!0})),ya(e,i,{parentPath:a.parentPath+i.id,isMainline:!0,withIndex:!0})||[]]:ka(e,i,{parentPath:a.parentPath,isMainline:!0,withIndex:a.withIndex}):s[1]?ba(e,s,a)||[wa(e,s,a)]:ka(e,i,a):null}function ba(e,t,a){return!t[1]||t[2]||kt(t[1],6)?null:ka(e,t[0],{parentPath:a.parentPath,isMainline:a.isMainline,inline:t[1]})}function wa(e,t,a){return n("lines",t.map((t=>n("line",ka(e,t,{parentPath:a.parentPath,isMainline:!1,withIndex:!0,truncate:t.comp&&!wt(e.ctrl.path,a.parentPath+t.id)?6:void 0})))))}function ka(e,t,a){const s=a.parentPath+t.id,i=ga(e,t);return 0===a.truncate?[n("move",{"data-path":s},"[...]")]:[Ca(e,t,a)].concat(i).concat(a.inline?function(e,t,a){return n("inline",ka(e,t,{withIndex:!0,parentPath:a.parentPath,isMainline:!1}))}(e,a.inline,a):null).concat(ya(e,t,{parentPath:s,isMainline:a.isMainline,truncate:a.truncate?a.truncate-1:void 0,withIndex:!!i[0]})||[])}function xa(e,t,a){const n=e.ctrl,s=!n.study&&a===n.initialPath&&Oe(n.data),i=e.showGlyphs&&t.glyphs?t.glyphs.map((e=>e.id)):[];return{current:a===n.path,currentPlayable:s,nongame:!s&&!!n.gamePath&&wt(a,n.gamePath)&&a!==n.gamePath,inaccuracy:i.includes(6),mistake:i.includes(2),blunder:i.includes(4)}}function Ma(e,t){return n("index",function(e,t){return je(e)+(t?e%2==1?".":"...":"")}(e,t))}function Ca(e,t,a){const s=a.parentPath+t.id,i=[a.withIndex||1&t.ply?Ma(t.ply,!0):null,z(t.san)];var o;return t.glyphs&&(o=t.glyphs,o.map((e=>n("glyph",e.symbol)))).forEach((e=>i.push(e))),n("move",{"data-path":s,className:l(xa(e,t,s))},i)}var Pa={onbeforeupdate:({attrs:e})=>!e.ctrl.replaying,view({attrs:e}){const{ctrl:t,rightTabActive:a}=e,s=[h.game.pieceNotation()?"displayPieces":"",a?"rta":""].join(" ");return n("div#replay.analyse-replay.native_scroller",{className:s,oncreate:I((e=>function(e,t){const a=Na(t);a&&a.dataset.path&&e.jump(a.dataset.path)}(t,e)),(e=>{const a=Na(e),n=a.dataset;a&&n.path&&(t.contextMenu=n.path,c())}),Na,!1)},function(e){const t=e.tree.root,a={ctrl:e,truncateComments:!1,showComputer:e.settings.s.showComments,showGlyphs:!0,showEval:!0},s=ga(a,t);return n("div.analyse-moveList",{className:"ios"===window.deviceInfo.platform?"ios":""},[s,ya(a,t,{parentPath:"",isMainline:!0})||[]])}(t))}};function Na(e){const t=e.target;return"MOVE"===t.tagName?t:D(t,"move")}function Ta(e){return n("eval",e)}function Sa(e,t){return function(e){return Math.floor((e-1)/2)+1}(e)+(t?e%2==1?".":"...":"")}function _a(e,t){const a=Be({client:t.ceval,server:t.eval})||{};return[n("san",z(t.san))].concat(t.glyphs&&e.showGlyphs?(s=t.glyphs,s.map((e=>n("glyph",{title:e.name},e.symbol)))):[]).concat(e.showEval?void 0!==a.cp?[Ta(Ge(a.cp))]:void 0!==a.mate?[Ta("#"+a.mate)]:[]:[]);var s}function Ia(e,t){return t.uci?[(a=t.ply,s=e.withDots,n("index",Sa(a,s)))].concat(_a(e,t)):[n("span.init","Initial position")];var a,s}function Oa(e){const t=e.retro;if(!t)return;const a=t.vm.feedback;return n("div.analyse-training_box.analyse-retro_box.box",{className:t.vm.minimized?"minimized":""},[za(t),n("div.analyse-training_feedback.native_scroller."+a,Ga(e,a))])}function Aa(e){return n("div.choices",[n("button",{oncreate:s(e.viewSolution)},i("viewTheSolution")),n("button",{oncreate:s(e.nextMistake)},i("skipThisMove"))])}function Ea(e){return n("div.li-button.retro-half.retro-continue",{oncreate:s(e.nextMistake)},[n("i[data-icon=G]"),i("next")])}const Ba={find:e=>[n("div.analyse-training_player",[n("div.piece-no-square",{className:e.pieceTheme},n("piece.king."+e.vm.color)),n("div.retro-instruction",[n("strong",[j("xWasPlayed",n("span",Ia({withDots:!0,showGlyphs:!0,showEval:!1},e.vm.current.fault.node)))]),n("em",i("white"===e.vm.color?"findBetterMoveForWhite":"findBetterMoveForBlack")),Aa(e)])])],offTrack:e=>[n("div.analyse-training_player",[n("div.retro-icon.off","!"),n("div.retro-instruction",[n("strong","You browsed away"),n("div.choices.off",[n("button",{oncreate:s(e.jumpToCurrent)},"Resume learning")])])])],fail:e=>[n("div.analyse-training_player",[n("div.retro-icon","✗"),n("div.retro-instruction",[n("strong",i("youCanDoBetter")),n("em",i("white"===e.vm.color?"tryAnotherMoveForWhite":"tryAnotherMoveForBlack")),Aa(e)])])],win:e=>[n("div.retro-half.top",n("div.analyse-training_player",[n("div.retro-icon","✓"),n("div.retro-instruction",n("strong",i("goodMove")))])),Ea(e)],view:e=>[n("div.retro-half.top",n("div.analyse-training_player",[n("div.retro-icon","✓"),n("div.retro-instruction",[n("strong",i("solution")),n("em",[n("strong",Ia({withDots:!0,showEval:!1},e.vm.current.solution.node))])])])),Ea(e)],eval(e){return[n("div.retro-half.top",n("div.analyse-training_player.center",[n("div.retro-instruction",[n("strong",i("evaluatingYourMove")),(t=e.node(),n("div.analyse-training_progress",n("div",{style:{width:`${t.ceval?100*Math.max(0,t.ceval.depth-8)/10+"%":0}`}})))])]))];var t},end(e,t){if(!t())return[n("div.retro-half.top",n("div.analyse-training_player",[n("div.retro-icon",o.getVdom()),n("div.retro-instruction",i("waitingForAnalysis"))]))];const a=!e.completion()[1];return[n("div.analyse-training_player",[n("div.piece-no-square",{className:e.pieceTheme},n("piece.king."+e.vm.color)),n("div.retro-instruction",[n("em",i(a?"white"===e.vm.color?"noMistakesFoundForWhite":"noMistakesFoundForBlack":"white"===e.vm.color?"doneReviewingWhiteMistakes":"doneReviewingBlackMistakes")),n("div.choices.end",[a?null:n("button",{oncreate:s(e.reset)},i("doItAgain")),n("button",{oncreate:s(e.flip)},i("white"===e.vm.color?"reviewBlackMistakes":"reviewWhiteMistakes"))])])])]}};function Ga(e,t){const a=e.retro,n=a.vm.current;return a.isSolving()&&n&&e.path!==n.prev.path?Ba.offTrack(a):"find"===t?n?Ba.find(a):Ba.end(a,e.hasFullComputerAnalysis):Ba[t](a)}function za(e){const t=e.completion();return n("div.titleWrapper",[n("div.title",i("learnFromYourMistakes")),n("div.mistakeNb",Math.min(t[0]+1,t[1])+" / "+t[1]),n("div.actions",[n("button.window-button",{oncreate:s(e.toggleWindow)},n("span.fa",{className:e.vm.minimized?"fa-window-maximize":"fa-window-minimize"})),n("button.window-button",{oncreate:s(e.close)},n("span.fa.fa-window-close"))])])}function Da(e,t){return e.best?j("goodMove"===e.verdict?"anotherWasX":"bestWasX",n("move",{oncreate:s(t.playCommentBest)},e.best.san)):[]}function ja(e){return n("div.analyse-training_player.off",[n("div.icon.off","!"),n("div.analyse-training_box_instruction",[n("strong",i("youBrowsedAway")),n("div.choices",[n("button",{oncreate:s(e.resume)},i("resumePractice"))])])])}function Ua(e,t,a){const s="checkmate"===a,o=s?v(e.turnColor()):e.turnColor();return n("div.analyse-training_player",[o?n("div.piece-no-square",{className:t.pieceTheme},n("piece.king."+o)):n("div.icon.off","!"),n("div.analyse-training_box_instruction",[n("strong",i(a)),n("em",s?n("color",i("white"===o?"whiteWinsGame":"blackWinsGame")):i("theGameIsADraw"))])])}function $a(e,t){const a=e.ceval?100*Math.max(0,e.ceval.depth-8)/(t-8)+"%":0;return n("div.analyse-training_progress",n("div",{style:`width: ${a}`}))}function Fa(e,t){const a=t.hinting();return n("div.analyse-training_player.running",[n("div.piece-no-square",{className:t.pieceTheme},n("piece.king."+e.turnColor())),n("div.analyse-training_box_instruction",(t.isMyTurn()?[n("strong",i("yourTurn"))]:[n("strong",i("computerThinking")),$a(t.currentNode(),t.playableDepth())]).concat(n("div.choices",[t.isMyTurn()?n("button",{oncreate:s(t.hint)},i(a?"piece"===a.mode?"seeBestMove":"hideBestMove":"getAHint")):""])))])}function Wa(e,t){return n("div.titleWrapper",[n("div.title",i("practiceWithComputer")),n("div.actions",[n("button.window-button",{oncreate:s(t.toggleWindow)},n("span.fa",{className:t.minimized()?"fa-window-maximize":"fa-window-minimize"})),n("button.window-button",{oncreate:s(e.togglePractice)},n("span.fa.fa-window-close"))])])}function La(e){const t=e.practice;if(!t)return;const a=t.comment(),s=t.running(),o=t.currentNode().threefold?"threefoldRepetition":e.gameOver();return n("div.analyse-practice_box.analyse-training_box.box."+(a?a.verdict:"no-verdict"),{className:t.minimized()?"minimized":""},[Wa(e,t),n("div.analyse-training_feedback.native_scroller",s?o?Ua(e,t,o):Fa(e,t):ja(t)),s?n("div.comment",a?[n("span.verdict",i(a.verdict))," "].concat(Da(a,t)):[t.isMyTurn()||o?"":n("span.wait",i("evaluatingYourMove"))]):s?n("div.comment"):null])}function Ra(e,t){const a=e.chapter.tags.find((e=>e[0].toLowerCase()===t));return a&&a[1]}function qa(){var e=Bt,t=null,a=At(0),n=Gt,s=At(!0),i=null,o=zt,r=null;function l(l){var c,d,u,h,p,m=l.length,v=!1,f=new Array(m),g=new Array(m);for(null==i&&(r=o(p=Dt())),c=0;c<=m;++c){if(!(c<m&&s(h=l[c],c,l))===v)if(v=!v)d=c,r.areaStart(),r.lineStart();else{for(r.lineEnd(),r.lineStart(),u=c-1;u>=d;--u)r.point(f[u],g[u]);r.lineEnd(),r.areaEnd()}v&&(f[c]=+e(h,c,l),g[c]=+a(h,c,l),r.point(t?+t(h,c,l):f[c],n?+n(h,c,l):g[c]))}if(p)return r=null,p+""||null}function c(){return Et().defined(s).curve(o).context(i)}return l.x=function(a){return arguments.length?(e="function"==typeof a?a:At(+a),t=null,l):e},l.x0=function(t){return arguments.length?(e="function"==typeof t?t:At(+t),l):e},l.x1=function(e){return arguments.length?(t=null==e?null:"function"==typeof e?e:At(+e),l):t},l.y=function(e){return arguments.length?(a="function"==typeof e?e:At(+e),n=null,l):a},l.y0=function(e){return arguments.length?(a="function"==typeof e?e:At(+e),l):a},l.y1=function(e){return arguments.length?(n=null==e?null:"function"==typeof e?e:At(+e),l):n},l.lineX0=l.lineY0=function(){return c().x(e).y(a)},l.lineY1=function(){return c().x(e).y(n)},l.lineX1=function(){return c().x(t).y(a)},l.defined=function(e){return arguments.length?(s="function"==typeof e?e:At(!!e),l):s},l.curve=function(e){return arguments.length?(o=e,null!=i&&(r=o(i)),l):o},l.context=function(e){return arguments.length?(null==e?i=r=null:r=o(i=e),l):i},l}function Ha(e,t,a){const n=t.game.division,s=e.getBoundingClientRect(),o=jt(e).append("svg").attr("viewBox",`0 0 ${s.width} ${s.height}`),r=(l=t).treeParts.slice(1).reduce(((e,t)=>{const a=1&t.ply;let n;if(t.eval&&t.eval.mate)n=t.eval.mate>0?1/0:-1/0;else if(t.san&&t.san.indexOf("#")>0)n=1===a?1/0:-1/0,"antichess"===l.game.variant.key&&(n=-n);else{if(!t.eval||void 0===t.eval.cp)return e;n=t.eval.cp}const s={acpl:2/(1+Math.exp(-.004*n))-1};return e.concat([s])}),[]);var l;const c=10,d=10,u=10,h=10,p=s.width-h-d,m=s.height-c-u,v=o.append("g").attr("transform","translate("+h+","+c+")");function f(e,t){v.append("line").attr("class","division "+t).attr("x1",e).attr("x2",e).attr("y1",w(-1)).attr("y2",w(1)),v.append("text").attr("class","chart-legend").attr("transform","rotate(90)").attr("y",-e).attr("dy","-0.4em").text(i(t))}const g=t.treeParts[0].ply||0;function y(e){if(v.selectAll(".dot").remove(),null!==e){const t=e-1-g,a=r[t];a&&v.append("circle").attr("class","dot").attr("cx",b(t)).attr("cy",w(a.acpl)).attr("r",3)}}const b=Ut().domain([0,r.length]).rangeRound([0,p]),w=Ut().domain([-1,1]).rangeRound([m,0]),k=qa().x(((e,t)=>b(t))).y((e=>w(e.acpl))),x=qa().x(((e,t)=>b(t))).y1((e=>e.acpl>=0?w(e.acpl):w(0)));return v.datum(r),v.append("line").attr("class","zeroline").attr("x1",0).attr("x2",p).attr("y1",w(0)).attr("y2",w(0)),v.append("clipPath").attr("id","clip-below").append("path").attr("d",x.y0((e=>w(e.acpl)))),v.append("clipPath").attr("id","clip-above").append("path").attr("d",x.y0(w(0))),v.append("path").attr("class","area above").attr("clip-path","url(#clip-above)").attr("d",x),v.append("path").attr("class","area below").attr("clip-path","url(#clip-below)").attr("d",x.y0((e=>e.acpl<=0?w(e.acpl):w(0)))),v.append("path").attr("class","line").attr("d",k),n&&(n.middle||n.end)&&(f(b(0),"opening"),n.middle&&f(b(n.middle),"middlegame"),n.end&&f(b(n.end),"endgame")),y(a),y}function Va(e,t,a,n){const s=t.game.division,o=e.getBoundingClientRect(),r=jt(e).append("svg").attr("viewBox",`0 0 ${o.width} ${o.height}`),l=10,c=10,d=10,u=25,h=o.width-u-c,p=o.height-l-d,m=r.append("g").attr("transform","translate("+u+","+l+")"),{max:v,series:f}=function(e,t){const a={white:[],black:[]},n=e.treeParts,s=Math.pow(Math.log(3),2);let i=0,o=0;return t.forEach(((e,t)=>{const r=n[t+1];i=r?r.ply:i+1;const l=!!(1&i),c=Math.pow(Math.log(.005*Math.min(e,12e4)+3),2)-s;o=Math.max(c,o);const d={ply:i,y:l?c:-c};l?a.white.push(d):a.black.push(d)})),{max:o,series:a}}(t,a);function g(e,t){m.append("line").attr("class","division "+t).attr("x1",e).attr("x2",e).attr("y1",w(-v)).attr("y2",w(v)),m.append("text").attr("class","chart-legend").attr("transform","rotate(90)").attr("y",-e).attr("dy","-0.4em").text(i(t))}function y(e){if(m.selectAll(".dot").remove(),null!==e){const t=!!(1&e)?f.white.find((t=>t.ply===e)):f.black.find((t=>t.ply===e));t&&m.append("circle").attr("class","dot").attr("cx",b(e)).attr("cy",w(t.y)).attr("r",3)}}const b=Ut().domain([0,f.white.length+f.black.length]).rangeRound([0,h]),w=Ut().domain([-v,v]).rangeRound([p,0]),k=qa().x((e=>b(e.ply))).y((e=>w(e.y))),x=qa().x((e=>b(e.ply))).y0(w(0)).y1((e=>w(e.y))),M=Math.max(...a)/100,C=Ut().domain([-M,M]).rangeRound([p,0]),P=$t(C).tickFormat((e=>String(Math.abs(e))));return m.append("g").call(P).append("text").attr("class","legend").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("text-anchor","end").text("Seconds"),m.append("path").datum(f.white).attr("class","area above").attr("d",x),m.append("path").datum(f.black).attr("class","area below").attr("d",x),m.append("path").attr("class","line").datum(f.white).attr("d",k),m.append("path").attr("class","line").datum(f.black).attr("d",k),s&&(s.middle||s.end)&&(s.middle&&g(b(s.middle),"middlegame"),s.end&&g(b(s.end),"endgame")),y(n),y}function Ja(e){return n("div.analyse-computerAnalysis",[n("strong.title",i("computerAnalysis")),e.analysisProgress?n("div.analyse-gameAnalysis_chartPlaceholder",o.getVdom("monochrome")):n("div.analyse-chart",{oncreate({dom:t}){U((()=>{this.updateCurPly=Ha(t,e.data,e.node.ply)}))},onupdate({dom:t}){this.updateCurPly?U((()=>{this.updateCurPly(e.onMainline?e.node.ply:null)})):U((()=>{const a=t;for(;a.lastElementChild;)a.removeChild(a.lastElementChild);this.updateCurPly=Ha(a,e.data,e.node.ply)}))}}),n(Xa,{d:e.data,analysis:e.data.analysis,study:e.study&&e.study.data})])}const Xa={onbeforeupdate:({attrs:e},{attrs:t})=>!$(e.analysis,t.analysis),view({attrs:e}){const{d:t,analysis:a,study:s}=e;return n("div.analyse-evalSummary",["white","black"].map((e=>{const o=Ue(t,e),r=s?Ra(s,e)||"Anonymous":F(o);return n("div.analyse-evalSummary__side",[n("div.analyse-evalSummary__player",[n("span.color-icon."+e),n("span",[r,o?W(o):null])]),n("div",[Za.map((t=>{const s=a&&a[e][t[0]];return n("div.analyse-evalSummary__summary",[n.trust(G(t[1],s,`<strong>${s}</strong>`))])})),n("div.analyse-evalSummary__summary",[n("strong",a&&a[e].acpl),n("span",i("averageCentipawnLoss"))])])])})))}};function Ka(e){return n("div.analyse-computerAnalysis.request",[e.analysisProgress?n("div.analyse-requestProgress",[n("span",i("waitingForAnalysis")),o.getVdom("monochrome")]):n("button.fatButton",{oncreate:I((()=>{return(a=e.data.game.id,t(`/${a}/request-analysis`,{method:"POST"},!0)).then((()=>{e.analysisProgress=!0,c()})).catch(d);var a}))},[i("requestAComputerAnalysis")])])}function Ya(e){return n("div.analyse-computerAnalysis.request",e.mainline.length<5?n("p","The study is too short to be analysed."):e.study.canContribute()?[n("p",["Get a full server-side computer analysis of the main line.",n("br"),"Make sure the chapter is complete, for you can only request analysis once."]),e.analysisProgress?n("div.analyse-requestProgress",[n("span",i("waitingForAnalysis")),o.getVdom("monochrome")]):n("button.fatButton",{oncreate:I((()=>{e.socket.send("requestAnalysis",e.study.data.chapter.id),e.analysisProgress=!0,c()}))},[i("requestAComputerAnalysis")])]:n("p","Only the study contributors can request a computer analysis"))}function Qa(e,t){return n("div.analyse-moveTimes",[n("strong.title",i("moveTimes")),n("div.analyse-chart",{oncreate({dom:a}){setTimeout((()=>{this.updateCurPly=Va(a,e.data,t,e.node.ply)}),200)},onupdate(){this.updateCurPly&&U((()=>{e.onMainline?this.updateCurPly(e.node.ply):this.updateCurPly(null)}))}})])}const Za=[["inaccuracy","nbInaccuracies"],["mistake","nbMistakes"],["blunder","nbBlunders"]];var en={onbeforeupdate:({attrs:e},{attrs:t})=>e.color!==t.color||!e.ctrl.replaying,view({attrs:e}){const{ctrl:t,color:a}=e,s=t.node,i=s.clock;if(void 0===i)return;const o=t.tree.getParentClock(s,t.path);let r,l;const c=s.ply%2==0;c?(r=o,l=i):(r=i,l=o);return n("span.analyse-clock",{className:("white"===a?c:!c)?"current":""},function(e){if(void 0===e)return n("span.time",["-"]);const t=new Date(10*e),a=t.getUTCMilliseconds(),s=":",i=tn(t.getUTCMinutes())+s+tn(t.getUTCSeconds());if(e>=36e4)return n("span.time",[Math.floor(e/36e4)+s+i]);const o=Math.floor(a/100).toString();return n("span.time",[i,n("tenths","."+o)])}("white"===a?r:l))}};function tn(e){return(e<10?"0":"")+e}function an(e,t){return function(e,t){return"white"===e?t:-t}(e,function(e){return void 0!==e.mate?function(e){const t=100*(21-Math.min(10,Math.abs(e)));return sn(t*(e>0?1:-1))}(e.mate):(t=e.cp,sn(Math.min(Math.max(-1e3,t),1e3)));var t}(t))}function nn(e,t,a){return(an(e,t)-an(e,a))/2}function sn(e){return 2/(1+Math.exp(-.004*e))-1}function on(e){return n("div.analyse-boardWrapper",[rn(e,e.topColor()),n(Xe,{variant:e.data.game.variant.key,chessground:e.chessground,shapes:ln(e),clearableShapes:e.node.shapes,wrapperClasses:e.settings.s.smallBoard?"halfsize":"",canClearShapes:!0}),rn(e,e.bottomColor())])}function rn(e,t){const a=e.playerName(t),s="Anonymous"===a;if(e.study&&s||!e.study&&e.synthetic)return null;const i=e.study&&e.study.data;let o,r,l;if(i)o=Ra(i,`${t}title`),r=Ra(i,`${t}elo`),l=function(e,t){switch(Ra(e,"result")){case"1-0":return t?"1":"0";case"0-1":return t?"0":"1";case"1/2-1/2":return"1/2";default:return}}(i,"white"===t);else if($e.finished(e.data)){const a=e.data.game.winner;l=void 0===a?"½":a===t?"1":"0"}const c=e.node.checkCount,d=e.node.clock||c;return n("div.analyse-player_bar",{className:e.settings.s.smallBoard?"halfsize":""},[n("div.info",s?n.trust("&nbsp"):[l?n("span.result",l):null,n("span.name",(o?o+" ":"")+a+(r?` (${r})`:""))]),d?n("div.player_bar_clock",[n(en,{ctrl:e,color:t}),c?cn("white"===e.bottomColor(),c):null]):null])}function ln(e){const t=e.data.game.player,a=e.node&&e.node.ceval,n=e.node&&e.node.eval,s=e.node&&e.node.threat;let i=[],o=[],r=[],l=[];if(e.practice){const a=e.practice.hinting();a&&(i="move"===a.mode?dn(a.uci,"paleBlue",t):[{orig:L(a.uci)[0],brush:"paleBlue"}])}if(!e.retro&&!e.practice&&e.settings.s.showBestMove){const s=e.nextNodeBest()||a&&a.best;s&&(i=dn(s,"paleBlue",t)),a&&a.pvs.length>1&&a.pvs.slice(1).forEach((e=>{const n=nn(t,a.pvs[0],e);if(n>=0&&n<.2){const a=Math.round(12-50*n);i=i.concat(dn(e.moves[0],"paleBlue"+a,t))}})),n&&n.best&&(o=dn(n.best,"paleGreen",J(t)))}!e.retro&&!e.practice&&e.showThreat&&s&&(l=dn(s.pvs[0].moves[0],"paleRed",J(t)));const{uci:c,glyphs:d}=e.node;if(c&&d&&d.length>0){const e=d[0];r=[{orig:L(c)[1],glyph:e}]}const u=e.retro&&e.retro.showBadNode(),h=u&&u.uci?dn(u.uci,"paleRed2",t):[];return[...o,...i,...l,...h,...r]}function cn(e,t){const a=n("span.color-icon.white","+"+t.black),s=n("span.color-icon.black","+"+t.white);return n("div.analyse-checkCount",e?[a,s]:[s,a])}function dn(e,t,a){if(e.includes("@")){const n=R(e);return[{brush:t,orig:n},{orig:n,piece:{role:q(e),color:a},brush:t}]}{const n=H(e),s=V(e),i=[{brush:t,orig:n[0],dest:n[1]}];return s&&i.push({brush:t,orig:n[1],piece:{role:s,color:a}}),i}}const un=[{name:"fast",delay:1e3},{name:"slow",delay:5e3}],hn={name:"realtimeReplay",delay:"realtime"},pn={name:"byCPL",delay:"cpl"};function mn(e,t){return n("section",{className:"actions_bar analyse_actions_bar"},n("button",{className:"action_bar_button fa "+(e.retroGlowing?"fa-play glow":"fa-list"),oncreate:s(e.study?e.study.actionMenu.open:e.menu.open)}),n("button",{className:"action_bar_button fa fa-gear",oncreate:s(e.settings.open)}),e.study&&e.study.chat?null:n("button",{className:"action_bar_button","data-icon":"B",oncreate:s(e.settings.flip)}),e.study&&e.study.chat?n("button",{className:"action_bar_button fa fa-comments withChip",oncreate:s(e.study.chat.open)},e.study.chat.nbUnread>0?n("span",{className:"chip"},e.study.chat.nbUnread<=99?e.study.chat.nbUnread:99):null):null,t?n("button",{className:"action_bar_button fa fa-"+(e.settings.s.smallBoard?"expand":"compress"),oncreate:s(e.settings.toggleBoardSize,(()=>T.show({text:"Expand/compress board",duration:"short",position:"bottom"})))}):null,n("button",{className:"action_bar_button fa fa-backward",oncreate:s(e.stoprewind,void 0,e.rewind)}),n("button",{className:"action_bar_button fa fa-forward",disabled:!!e.retro,oncreate:s(e.stopff,void 0,e.fastforward)}),e.study?n("button",{className:"action_bar_button fa fa-bars",oncreate:s(e.study.sideMenu.open)}):null)}function vn(e){return e.reduce(((e,t)=>e.set(fn(t),t)),new Map)}function fn(e){return e.map((e=>e.ply+":"+e.uci)).join(",")}class gn{constructor(e){var t;this.focusKey=null,this.loading=!1,this._minimized=!1;const a=e.forecast;this._lines=vn((null==a?void 0:a.steps)||[]);const n=null==a?void 0:a.onMyTurn;this.isMyTurn=!!n,this._gameId=e.game.id,this._playerId=(null===(t=e.player)||void 0===t?void 0:t.id)||null}truncate(e){const t=this.isMyTurn?1:0;return(e.length%2!==t?e.slice(0,-1):e).slice(0,30)}isCandidate(e){const t=this.truncate(e);if(!this.isLongEnough(t))return!1;for(const e of this._lines.values())if(this.isPrefix(e,t))return!1;return!0}removeForecast(e){this._lines.delete(e),this.focusKey=null,this.save()}add(e){const t=this.truncate(e);this.isCandidate(t)&&(this._lines.set(fn(t),t),this.fixAll(),this.save())}save(){const t=this._playerId,a=this._gameId;!this.isMyTurn&&t&&(this.loading=!0,c(),function(t,a,n){return e(`/${t}${a}/forecasts`,{method:"POST",body:JSON.stringify(n)})}(a,t,this.lines).then((e=>{e.reload?this.reloadToLastPly():(this.loading=!1,this._lines=vn(e.steps||[]),c())})))}playAndSave(t){const a=this._playerId,n=this._gameId;if(!this.isMyTurn||!a)return;const s=this.findStartingWithNode(t).filter((e=>e.length>0)).map((e=>e.slice(1)));this.loading=!0,c(),function(t,a,n,s){return e(`/${t}${a}/forecasts/${n.uci}`,{method:"POST",body:JSON.stringify(s)})}(n,a,t,s).then((e=>{e.reload?this.reloadToLastPly():(this.loading=!1,this._lines=vn(e.steps||[]),c())}))}findStartingWithNode(e){return this.lines.filter((t=>this.isPrefix(t,[e])))}reloadToLastPly(){r.deleteQueryParam("ply",!0)}get lines(){return Array.from(this._lines.values())}isPrefix(e,t){return e.length>=t.length&&fn(e).startsWith(fn(t))}collides(e,t){for(let a=0,n=Math.min(e.length,t.length);a<n;a++)if(e[a].uci!==t[a].uci)return this.isMyTurn?0!==a&&a%2==0:a%2==1;return!1}toggleMinimized(){this._minimized=!this._minimized}get minimized(){return this._minimized}isLongEnough(e){return e.length>=(this.isMyTurn?1:2)}fixAll(){for(const[e,t]of this._lines.entries())for(const[a,n]of this._lines.entries())if(e!==a&&this.isPrefix(n,t)||this.collides(t,n)){this._lines.delete(e);break}}}var yn=/^(?:0|[1-9]\d*)$/;function bn(e,t,a){if(!K(a))return!1;var n=typeof t;return!!("number"==n?function(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}(e.length)&&!X(e)}(a)&&function(e,t){var a=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==a||"symbol"!=a&&yn.test(e))&&e>-1&&e%1==0&&e<t}(t,a.length):"string"==n&&t in a)&&function(e,t){return e===t||e!=e&&t!=t}(a[t],e)}function wn(e,t,a){var n=-1,s=e.length;t<0&&(t=-t>s?0:s+t),(a=a>s?s:a)<0&&(a+=s),s=t>a?0:a-t>>>0,t>>>=0;for(var i=Array(s);++n<s;)i[n]=e[n+t];return i}var kn=Math.ceil,xn=Math.max;function Mn(e){const t=[];return e[0].ply%2==0&&(t.push({index:Math.floor((e[0].ply+1)/2),black:e[0].san,white:null}),e=e.slice(1)),function(e,t,a){t=(a?bn(e,t,a):void 0===t)?1:xn(tt(t),0);var n=null==e?0:e.length;if(!n||t<1)return[];for(var s=0,i=0,o=Array(kn(n/t));s<n;)o[i++]=wn(e,s,s+=t);return o}(e,2).forEach((([e,a])=>{t.push({index:(e.ply+1)/2,white:e.san,black:null==a?void 0:a.san})})),t}function Cn(e){const t=e.forecast;if(!t||e.synthetic||!Oe(e.data))return null;const a=Pn(e,t),o=t.isCandidate(a);return n("div.analyse-training_box.analyse-forecast_box.box",{className:t.minimized?"minimized":"",oncreate:s((()=>{t.focusKey=null}))},[Sn(t),n("div.forecasts-wrapper.native_scroller",[n("div.forecasts-list",{className:h.game.pieceNotation()?"displayPieces":""},[...t.lines.map((e=>{const a=fn(e);return n("div.forecast[data-icon=G]",{key:a,oncreate:s((e=>{e.stopPropagation(),t.focusKey=a}))},[n("sans",Nn(e)),t.focusKey===a?n("span.fa.fa-times-circle.delete",{oncreate:s((e=>{e.stopPropagation(),t.removeForecast(a)}))}):null])}))]),n("div.add",{className:o?"enabled":"","data-icon":o?"O":"",oncreate:s((()=>{const a=Pn(e,t);t.add(a)}))},[o?n("div",[n("span",i("addCurrentVariation")),n("sans",Nn(a))]):n("span",i("playVariationToCreateConditionalPremoves"))]),Tn(e,a),t.loading?n("div.spinner_overlay",n("div.spinner.fa.fa-hourglass-half")):null])])}function Pn(e,t){const a=e.tree.getCurrentNodesAfterPly(e.nodeList,e.mainline,e.data.game.turns);return t.truncate(a.map((e=>({ply:e.ply,fen:e.fen,uci:e.uci,san:e.san}))))}function Nn(e){return e[0]?(e[0].san||(e=e.slice(1)),e[0]?Mn(e).map((({black:e,white:t,index:a})=>n("move",[n("index",a+(t?".":"...")),t?n("san",t):null,e?n("san",e):null]))):[]):[]}function Tn(e,t){var a;if(!(null===(a=e.forecast)||void 0===a?void 0:a.isMyTurn))return;const o=t[0];if(!o)return;const r=e.forecast.findStartingWithNode(o);if(!r.length)return;const l=r.filter((e=>e.length>1)).length;return n("div.on-my-turn",n("button.defaultButton",{oncreate:s((()=>e.forecast.playAndSave(o)))},[n("span.fa.fa-check"),n("span",[n("strong",i("playX",t[0].san))," ",l?n("span",G("andSaveNbPremoveLines",l)):null])]))}function Sn(e){return n("div.titleWrapper",[n("div.title",[i("conditionalPremoves"),e.lines.length>0?` (${e.lines.length})`:null]),n("div.actions",[n("button.window-button",{oncreate:s((()=>e.toggleMinimized()))},n("span.fa",{className:e.minimized?"fa-window-maximize":"fa-window-minimize"}))])])}function _n(e,t,a){const s=h.analyse.smallBoard();return Me.board(Y(),[En(t||"white",s,a||Pe),n("div.analyse-tableWrapper",o.getVdom("monochrome")),e?n("section.analyse_actions_bar"):null])}function In(e,t){const a=e.availableTabs(),s=Z();return n.fragment({key:"size"+e.settings.s.smallBoard},[on(e),n("div.analyse-tableWrapper",["crazyhouse"!==e.data.game.variant.key||!t&&s?null:ha(e),!t&&s?pa(e):null,Dn(e,a),t?null:mn(e,t),!t&&s?ma(e):null]),t?mn(e,t):null])}function On(e){return[Ke(e),e.study?Ht.view(e.study.actionMenu):Lt.view(e.menu),e.study&&e.study.chat?st(e.study.chat):null,Jt.view(e.settings),e.notes?at(e.notes):null,gt.view(e.continuePopup),va(e)]}function An(e){const t=e.data.game.variant.key,a=ee(t);let s=h.analyse.availableVariants;return"fromPosition"===t&&(s=s.concat([["From position","fromPosition"]])),n("div.select_input.main_header-selector.header-subTitle",[n("label",{for:"variant_selector"},n(`i[data-icon=${a}]`)),n("select",{id:"variant_selector",value:t,onchange:e=>{const t=e.target.value;h.analyse.syntheticVariant(t),r.set(`/analyse/variant/${t}`)}},s.map((e=>n("option",{key:e[1],value:e[1]},e[0]))))])}function En(e,t,a){return n("section.board_wrapper.analyse-boardWrapper",{className:t?"halfsize ":""},n(Q,{orientation:e,fen:a}))}function Bn(e,t){const a=e.currentTab(t),s=t.map((t=>{var a;return"comments"===t.id&&e.node.comments&&e.node.comments.length>0?Object.assign(Object.assign({},t),{chip:e.node.comments.length}):"forecasts"===t.id&&(null===(a=e.forecast)||void 0===a?void 0:a.lines)&&e.forecast.lines.length>0?Object.assign(Object.assign({},t),{chip:e.forecast.lines.length}):t}));return n("div.analyse-header",["ceval"!==a.id?n(ta,{ctrl:e}):null,n("div.analyse-tabs",[n("div.tab-title",Gn(e,a)),n(Se,{buttons:s,selectedIndex:e.currentTabIndex(t),onTabChange:e.onTabChange,wrapperClass:"analyse"})])])}function Gn(e,t){const a=i(t.title);let s;if("moves"===t.id){s=[function(e){const t=e.tree.getOpening(e.nodeList)||e.data.game.opening;if(t)return n("div",[n("strong",t.eco)," "+t.name])}(e)||a]}else s="ceval"===t.id?[n("span",e.ceval.getEngineName()+(e.ceval.getEngineEvaluation()?` (${e.ceval.getEngineEvaluation()})`:"")),e.ceval.isSearching()?n("div.ceval-spinner",n("span.fa.fa-spinner.fa-pulse")):null]:"explorer"===t.id?[ca(e)]:[a];return n.fragment({},s)}const zn={infos:function(e){const t=e.data.player,a=e.data.opponent;return t&&a?n("div",{className:"analyse-gameInfos native_scroller"},n("div",{className:"analyseOpponent li-button",oncreate:I((()=>t.user&&r.set(`/@/${t.user.id}/`)))},n("div",{className:"analysePlayerName"},n("span",{className:"color-icon "+t.color}),F(t,!0),W(t),t.berserk?n("span",{"data-icon":"`"}):null)),n("div",{className:"analyseOpponent li-button",oncreate:I((()=>a.user&&r.set(`/@/${a.user.id}/`)))},n("div",{className:"analysePlayerName"},n("span",{className:"color-icon "+a.color}),F(a,!0),W(a),a.berserk?n("span",{"data-icon":"`"}):null)),n("div",{className:"gameInfos"},e.formattedDate?e.formattedDate:null,"import"===e.data.game.source&&e.data.game.importedBy?n("div",null,"Imported by ",e.data.game.importedBy):null),$e.finished(e.data)?function(e){const t=Ue(e.data,e.data.game.winner);return n("div",{className:"status"},$e.toLabel(e.data.game.status.name,e.data.game.turns,e.data.game.winner,e.data.game.variant.key),t?". "+i("white"===t.color?"whiteIsVictorious":"blackIsVictorious")+".":null)}(e):null,e.data.tournament?n("div",{className:"analyse-tournamentInfo li-button",oncreate:I((()=>e.data.tournament&&r.set(`/tournament/${e.data.tournament.id}`)))},n("span",{className:"fa fa-trophy"}),e.data.tournament.name+" Arena"):null,n("h2",{className:"analyse-tabContentTitle"},i("replayMode")),function(e){const t=e.data,a="correspondence"!==t.game.speed&&t.game.moveCentis&&0!==t.game.moveCentis.length,o=[...un,...a?[hn]:[],...t.analysis?[pn]:[]];return n("div.analyse-autoplay",o.map((t=>n("button.buttonMetal",{oncreate:s((()=>e.autoplay.toggle(t.delay)))},i(t.name)))))}(e)):null},moves:function(e){return n("div.analyse-replayWrapper",[n(Pa,{ctrl:e,rightTabActive:!1})])},explorer:function(e){const t=e.explorer.current(),a=e.explorer.config,o=a.open(),r=!o&&e.explorer.loading(),c=l({explorerTable:!0,loading:r}),d=e.tree.getOpening(e.nodeList)||e.data.game.opening;return n("div",{id:"explorerTable",className:c},t&&t.isOpening?n("div",{className:"explorer-fixedTitle"},n("span",null,d?d.eco+" "+d.name:""),o||t&&t.isOpening?n("div",{className:"toconf","data-icon":o?"L":"%",oncreate:s(a.toggleOpen)}):null):null,r?n("div",{className:"spinner_overlay"},n("div",{className:"spinner fa fa-hourglass-half"})):null,o?function(e){return n("div.explorerConfig",{},na.view(e.explorer.config))}(e):null,!o&&e.explorer.failing()?n("div.explorer-data.empty",{},n("div.failing.message",[n("h3",[n("i.withIcon[data-icon=,]"),"Oops, sorry!"]),n("p","The explorer is temporarily"),n("p","out of service. Try again soon!")])):null,o||e.explorer.failing()?null:function(e){const t=e.explorer.current();if(t&&function(e){return!!e.isOpening}(t))return n(ia,{data:t,ctrl:e});if(t&&function(e){return!!e.tablebase}(t)){const a=t.moves;return a.length?n("div",{className:"explorer-data"},da(e,i("winning"),a.filter((e=>"loss"===e.category)),t.fen),da(e,i("unknown"),a.filter((e=>"unknown"===e.category)),t.fen),da(e,i("winOr50MovesByPriorMistake"),a.filter((e=>"maybe-loss"===e.category)),t.fen),da(e,i("winPreventedBy50MoveRule"),a.filter((e=>"blessed-loss"===e.category)),t.fen),da(e,i("drawn"),a.filter((e=>"draw"===e.category)),t.fen),da(e,i("lossSavedBy50MoveRule"),a.filter((e=>"cursed-win"===e.category)),t.fen),da(e,i("lossOr50MovesByPriorMistake"),a.filter((e=>"maybe-win"===e.category)),t.fen),da(e,i("losing"),a.filter((e=>"win"===e.category)),t.fen)):t.checkmate?ua(i("checkmate")):t.stalemate?ua(i("stalemate")):t.variant_win||t.variant_loss?ua(i("variantEnding")):oa(e)}return n("div",null)}(e))},analysis:function(e){const t=e.data;return n("div.analyse-gameAnalysis.native_scroller",[t.analysis?Ja(e):e.study?Ya(e):Ka(e),t.game.moveCentis?Qa(e,t.game.moveCentis):null])},ceval:function(e){return e.ceval.enabled()?n("div.ceval-Wrapper",[Qt(e),ea(e)]):n("div.ceval-notEnabled","Computer eval is disabled")},pgnTags:function(e){const t=e.study;return t?n("div.native_scroller",[n("table.study-tags",[n("tbody",t.data.chapter.tags.map((([e,t])=>n("tr.study-tag",[n("th",e),n("td",n.trust(Ce(t)))]))))])]):n("div","oops! nothing to see here")},comments:function(e){const t=e.node.comments||[];return n("div.native_scroller.study-comments",t.map((e=>n("div.study-comment",[n("div.by",("string"==typeof e.by?e.by:e.by.name)+":"),n("div",n(Vt,{text:e.text}))]))))}};function Dn(e,t){const a=e.retro||e.practice||e.forecast;return n("div.analyse-table.box",[Bn(e,t),n(_e,{className:"analyse-tabsContent"+(a?" withTrainingBox":""),selectedIndex:e.currentTabIndex(t),tabs:t.map((t=>({id:t.id,f:()=>zn[t.id](e)}))),onTabChange:e.onTabChange,boardView:!0}),e.retro?Oa(e):null,e.practice?La(e):null,e.forecast?Cn(e):null])}class jn{constructor(e){this.ctrl=e}move(){return this.ctrl.canGoForward()?(this.ctrl.next(),c(),!0):(this.stop(),c(),!1)}evalToCp(e){return e.eval?e.eval.mate?e.eval.mate>0?990:-990:e.eval.cp:e.ply%2?990:-990}nextDelay(){if("string"!=typeof this.delay||this.ctrl.onMainline){if("realtime"===this.delay){if(this.ctrl.node.ply<2)return 1e3;const e=this.ctrl.data.game.moveCentis;if(!e)return 1500;return 10*e[this.ctrl.node.ply-this.ctrl.tree.root.ply]+130||2e3}if("cpl"===this.delay){const e=30;if(this.ctrl.node.ply>=this.ctrl.mainline.length-1)return 0;const t=this.evalToCp(this.ctrl.node),a=this.evalToCp(this.ctrl.node.children[0]);return Math.max(500,Math.min(1e4,Math.abs(t-a)*e))}return this.delay}return 1500}schedule(){this.timeoutId=setTimeout((()=>{this.move()&&this.schedule()}),this.nextDelay())}start(e){this.delay=e,this.stop(),this.schedule()}stop(){clearTimeout(this.timeoutId),this.timeoutId=void 0}toggle(e){this.active(e)?this.stop():(this.active()||this.move()||this.ctrl.jump(""),this.start(e))}active(e){return!(e&&e!==this.delay||!this.timeoutId)}}function Un(){const e={state:"pending"};return e.promise=new Promise(((t,a)=>{e.resolve=a=>{e.state="fulfilled",t(a)},e.reject=()=>{e.state="rejected",a()}})),e}const $n=new RegExp(""+/^info depth (\d+) seldepth \d+ multipv (\d+) /.source+/score (cp|mate) ([-\d]+) /.source+/(?:(upper|lower)bound )?nodes (\d+) nps \S+ /.source+/(?:hashfull \d+ )?(?:tbhits \d+ )?time (\S+) /.source+/pv (.+)/.source);class Fn{constructor(e,t,a){this.threads=t,this.hash=a,this.expectedPvs=1,this.startQueue=[],this.stopped=!1,this.engineName="Stockfish",this.init=async()=>{try{window.addEventListener("stockfish",this.listener,{passive:!0});const e=await this.stockfish.start();this.engineName=e.engineName,await this.stockfish.setVariant(),await this.stockfish.setOption("UCI_AnalyseMode","true"),await this.stockfish.setOption("Threads",this.threads),"web"!==te.getPlatform()&&await this.stockfish.setOption("Hash",this.hash)}catch(e){}},this.start=e=>{this.stop(),this.startQueue.push(e),clearTimeout(this.stopTimeoutId);const t=new Promise(((e,t)=>{this.stopTimeoutId=setTimeout(t,1e4)}));return Promise.race([this.ready.promise,t]).then(this.search).catch((()=>{this.reset().then(this.search)}))},this.stop=()=>{this.stopped||(this.stopped=!0,this.stockfish.send("stop"))},this.exit=()=>(window.removeEventListener("stockfish",this.listener,!1),this.stockfish.exit()),this.reset=()=>this.exit().then(this.init),this.search=async()=>{const e=this.startQueue.pop();e&&(this.work=e,this.curEval=void 0,this.expectedPvs=1,this.stopped=!1,this.startQueue=[],this.ready=Un(),await this.stockfish.setOption("MultiPV",e.multiPv),await this.stockfish.send(["position","fen",e.initialFen,"moves"].concat(e.moves).join(" ")),e.maxDepth>=99?await this.stockfish.send("go depth 99"):await this.stockfish.send("go movetime 90000 depth "+e.maxDepth))},this.listener=e=>{this.processOutput(e.output)},this.stockfish=new ae(e),this.ready=Un(),this.ready.resolve()}isSearching(){return"pending"===this.ready.state}processOutput(e){var t;const a=/^info string (classical|NNUE) evaluation/.exec(e);if(a&&(this.evaluation=a[1]),0===e.indexOf("bestmove")&&(this.ready.resolve(),null===(t=this.work)||void 0===t||t.emit()),this.stopped||void 0===this.work)return;const n=$n.exec(e);if(!n)return;const s=parseInt(n[1]),i=parseInt(n[2]),o="mate"===n[3],r=parseInt(n[4]),l=n[5],c=parseInt(n[6]),d=parseInt(n[7]),u=n[8].split(" ");if(o&&!r)return;this.expectedPvs<i&&(this.expectedPvs=i);const h=this.work.threatMode?0:1,p=this.work.ply%2===h?-r:r;if(l&&1===i)return;const m={moves:u,cp:o?void 0:p,mate:o?p:void 0,depth:s};1===i?this.curEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:s,knps:c/d,nodes:c,cp:m.cp,mate:m.mate,pvs:[m],millis:d}:this.curEval&&(this.curEval.pvs.push(m),this.curEval.depth=Math.min(this.curEval.depth,s)),i===this.expectedPvs&&this.curEval&&this.work.emit(this.curEval)}}class Wn{constructor(e,t){this.opts=e,this.emit=t,this.minDepth=6,this.initialized=!1,this.started=!1,this.isDeeper=!1,this.lastStarted=void 0,this.init=()=>this.engine.init().then((()=>{this.initialized=!0})),this.destroy=()=>{this.initialized&&this.engine.exit().then((()=>{this.initialized=!1,this.started=!1})).catch((()=>{this.initialized=!1,this.started=!1}))},this.stop=()=>{this.enabled()&&this.started&&(this.engine.stop(),this.started=!1)},this.toggle=()=>{this.isEnabled=!this.isEnabled},this.disable=()=>{this.isEnabled=!1},this.toggleInfinite=()=>{this.opts.infinite=!this.opts.infinite,this.restart()},this.goDeeper=()=>{this.lastStarted&&this.start(this.lastStarted.threatMode,this.lastStarted.path,this.lastStarted.nodes,!1,!0)},this.onEmit=(e,t)=>{var a,n;t&&(a=t.pvs,n=e.ply%2==0?"white":"black",a.sort(((e,t)=>an(n,t)-an(n,e)))),t&&Ln(t),this.emit(e.path,t,e.threatMode)},this.allowed=e.allowed,this.variant=e.variant,this.isEnabled=h.analyse.enableCeval(),this.engine=new Fn(e.variant,e.cores,e.hashSize)}enabled(){return this.opts.allowed&&this.isEnabled}async start(e,t,a,n,s){if(!this.enabled())return;this.isDeeper=s;const i=a[a.length-1],o=this.effectiveMaxDepth(s),r=e?i.threat:i.ceval;if(r&&r.depth>=o)return;const l={initialFen:a[0].fen,currentFen:i.fen,moves:[],maxDepth:n?h.analyse.cevalMaxDepth():this.effectiveMaxDepth(s),path:t,ply:i.ply,multiPv:n?1:this.opts.multiPv,threatMode:e,emit:e=>{this.enabled()&&this.onEmit(l,e)}};if(e){const e=i.ply%2==1?"w":"b",t=i.fen.replace(/ (w|b) /," "+e+" ");l.currentFen=t,l.initialFen=t}else for(let e=1;e<a.length;e++){const t=a[e];Rn(this.variant,t.san)?(l.moves=[],l.initialFen=t.fen):l.moves.push(t.uci)}this.engine.start(l),this.started=!0,this.lastStarted={threatMode:e,path:t,nodes:a}}restart(){this.lastStarted&&this.start(this.lastStarted.threatMode,this.lastStarted.path,this.lastStarted.nodes,!1,!1)}isInit(){return this.initialized}isSearching(){return this.engine.isSearching()}setMultiPv(e){this.opts.multiPv=e,this.restart()}getMultiPv(){return this.opts.multiPv}canGoDeeper(){return!this.isDeeper&&!this.opts.infinite&&!this.engine.isSearching()}getEngineName(){return this.engine.engineName}getEngineEvaluation(){return this.engine.evaluation}effectiveMaxDepth(e=!1){return e||this.opts.infinite?99:h.analyse.cevalMaxDepth()}}const Ln=(()=>{const e=[];return t=>{if((e=>e.knps&&e.depth>=16&&void 0!==e.cp&&Math.abs(e.cp)<500&&e.fen.split(/\s/)[0].split(/[nbrqkp]/i).length-1>=10)(t)&&(e.push(t.knps),e.length>9)){const t=function(e){e.sort(((e,t)=>e-t));const t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}(e)||0;let a=18;t>100&&(a=19),t>150&&(a=20),t>250&&(a=21),t>500&&(a=22),t>1e3&&(a=23),t>2e3&&(a=24),t>3500&&(a=25),t>5e3&&(a=26),t>7e3&&(a=27),h.analyse.cevalMaxDepth()!==a&&h.analyse.cevalMaxDepth(a),e.length>40&&e.shift()}}})();function Rn(e,t){return!!t.startsWith("O-O")||"crazyhouse"!==e&&(!!t.includes("x")||(t.toLowerCase()===t||"threeCheck"===e&&t.includes("+")))}function qn(e){return!!e.children.find((function(e){return!!e.comp}))}function Hn(e){return e.split(" ").slice(0,4).join(" ")}function Vn(e){const t=e.data.game;let a=[];const n=[];let s=[];const i={current:null,feedback:"find",minimized:!1,color:e.bottomColor()};function o(e){return s.includes(e)}function r(){const t="white"===e.bottomColor()?1:0;return a=function(e,t){const a=[];for(let n=1;n<e.length;n++){const s=e[n],i=e[n-1];t(s)&&s.eval&&i.eval&&Math.abs(nn("white",i.eval,s.eval))>.075&&qn(i)&&a.push(s)}return a}(e.mainline,(e=>e.ply%2===t&&!n.includes(e.ply))),a.find((e=>!o(e.ply)))}function l(){i.feedback="find";const a=r();if(!a)return i.current=null,c();const s={node:a,path:e.mainlinePathToPly(a.ply)},o=xt(s.path),d={node:e.tree.nodeAtPath(o),path:o},u=d.node.children.find((e=>!!e.comp));i.current={fault:s,prev:d,solution:{node:u,path:o+u.id},openingUcis:[]},"standard"===t.variant.key&&t.division&&(!t.division.middle||s.node.ply<t.division.middle)&&e.explorer.fetchMasterOpening(d.node.fen).then((e=>{const t=i.current,a=[];e.moves.forEach((e=>{e.white+e.draws+e.black>1&&a.push(e.uci)})),a.find((e=>s.node.uci===e))?(n.push(s.node.ply),setTimeout(l,100)):(t.openingUcis=a,i.current=t)})),e.userJump(d.path),c()}function d(){const t=e.node,a=i.current;if(a&&"eval"===i.feedback&&a.fault.node.ply===t.ply&&function(e){return!!e.ceval&&(e.ceval.depth>=18||e.ceval.depth>=14&&void 0!==e.ceval.millis&&e.ceval.millis>7e3)}(t)){e.stopCevalImmediately();nn(i.color,t.ceval,a.prev.node.eval)>-.035?u():p()}}function u(){i.feedback="win",c()}function p(){i.feedback="fail";const t={node:e.node,path:e.path};e.userJump(i.current.prev.path),!e.tree.pathIsMainline(t.path)&&De(t.node.children)&&e.tree.deleteNodeAt(t.path),c()}function m(){const e=i.feedback;return"find"===e||"fail"===e}function v(){s=[],l()}return{vm:i,isPlySolved:o,onJump:function(){const t=e.node,a=i.feedback,n=i.current;n&&("eval"!==a||n.fault.node.ply===t.ply?m()&&n.fault.node.ply===t.ply&&(n.openingUcis.some((e=>t.uci===e))||t.comp?u():t.eval?p():(i.feedback="eval",e.ceval.enabled()||(e.ceval.toggle(),e.initCeval()),d())):i.feedback="find")},jumpToCurrent:l,nextMistake:function(){s.push(i.current.fault.node.ply),l()},viewSolution:function(){i.feedback="view",e.userJump(i.current.solution.path)},hideComputerLine:function(e){return e.ply%2==0!=("white"===i.color)&&!o(e.ply)},showBadNode:function(){const t=i.current;if(t&&m()&&t.prev.path===e.path)return t.fault.node},onCeval:d,onMergeAnalysisData:function(){m()&&!i.current&&l()},isSolving:m,completion:()=>[s.length,a.length],flip(){e.settings.flip(),i.color=e.bottomColor(),v()},reset:v,pieceTheme:h.general.theme.piece(),close:e.toggleRetro,toggleWindow(){i.minimized=!i.minimized},node:()=>e.node}}function Jn(e,t){const a=e.data.game.variant.key,n=E(!1),s=E(!0),i=E(null),o=E(null),r=E(!1);function l(){e.ceval.enabled()||(e.ceval.toggle(),e.initCeval())}function d(t,a=0){if(e.gameOver(t)||t.tbhit)return!0;const n=t.ceval;return!!n&&(n.depth+a>=15||n.depth>=13&&Number(n.millis)>3e3)}function u(e){return e&&(e.winner?{mate:"white"===e.winner?10:-10}:{cp:0})}function p(e){return e.tbhit&&e.tbhit.best||e.ceval&&e.ceval.pvs[0].moves[0]}function m(t,a,n){let s,i;const o=e.gameOver(a);if("checkmate"===o)s="goodMove";else{const n=u(a.tbhit)||(a.threefold||"draw"===o?{cp:0}:a.ceval),r=u(t.tbhit)||t.ceval,l=-nn(e.bottomColor(),n,r);i=p(t),(i===a.uci||a.san.startsWith("O-O")&&i===se[a.uci])&&(i=null),s=i?l<.025?"goodMove":l<.06?"inaccuracy":l<.14?"mistake":"blunder":"goodMove"}return{prev:t,node:a,path:n,verdict:s,best:i?{uci:i,san:v(t).unwrap((e=>Kt(e,_(i))),(e=>"--"))}:void 0}}function v(t){const a=S(t.fen).unwrap();return ft(Yt(e.data.game.variant.key),a)}function f(){return e.turnColor()===e.bottomColor()}function g(){const n=e.node;if(!s())return i(null),c();if(!Fe(a,n.fen)||We(n.tbhit))if(l(),f()){const e=o();e&&(e.uci=p(n)||e.uci)}else{if(i(null),n.san&&d(n)){const t=e.tree.parentNode(e.path);if(d(t,1))i(m(t,n,e.path));else{const t=e.tree.parentNode(xt(e.path));d(t,1)&&i(m(t,n,e.path))}}!r()&&function(e){const a=e.ceval;return!!a&&(a.depth>=Math.min(a.maxDepth||99,t())||a.depth>=15&&(a.cloud||Number(a.millis)>5e3))}(n)?(e.playUci(p(n)),r(!0)):c()}}function y(){l(),Fe(a,e.node.fen)?e.explorer.fetchTablebaseHit(e.node.fen).then((t=>{t&&e.node.fen===t.fen&&(e.node.tbhit=t),g()})).catch((()=>{We(e.node.tbhit)||(e.node.tbhit=null),g()})):g()}function b(){s(!0),y(),c()}return ne(y),{onCeval:g,onJump(){r(!1),o(null),function(e,t){if(void 0!==t.threefold)return;const a=Hn(t.fen);let n=0;for(const t in e)Hn(e[t].fen)===a&&n++;t.threefold=n>2}(e.nodeList,e.node),y()},isMyTurn:f,comment:i,running:s,hinting:o,resume:b,playableDepth:t,reset(){i(null),o(null)},preUserJump(e,t){e!==t&&(s(!1),i(null))},postUserJump(e,t){e!==t&&f()&&b()},onUserMove(){s(!0)},playCommentBest(){const t=i();t&&(e.jump(xt(t.path)),t.best&&e.playUci(t.best.uci))},hint(){const t=e.node.ceval?e.node.ceval.pvs[0].moves[0]:null,a=o();!t||a&&"move"===a.mode?o(null):o({mode:a?"move":"piece",uci:t}),c()},currentNode:()=>e.node,bottomColor:e.bottomColor,pieceTheme:h.general.theme.piece(),minimized:n,toggleWindow(){n(!n())}}}var Xn={drop(e,t,a){if("pawn"===e&&("1"===t[1]||"8"===t[1]))return!1;if(null==a)return!0;return-1!==(Array.isArray(a)?a:a.match(/.{2}/g)||[]).indexOf(t)}};function Kn(t,a,n,s){const i={fen:a,variant:t};return s||(i.topGames=0,i.recentGames=0),"lichess"===n.db&&(n.speeds&&(i.speeds=n.speeds.join(",")),n.ratings&&(i.ratings=n.ratings.join(","))),e("https://explorer.lichess.ovh/"+n.db,{headers:{Accept:"application/json","X-Requested-With":"__delete",[ie]:"__delete"},credentials:"omit",query:i})}function Yn(t,a,n){return e("https://tablebase.lichess.ovh/"+t,{headers:{Accept:"application/json, text/*","X-Requested-With":"__delete",[ie]:"__delete"},credentials:"omit",query:{fen:a},timeout:n})}function Qn(e,t){const a=E(!0),n=E(!1),s=E({moves:[]});let i={};function o(e,t){i[e]=t,s(t)}const r=!!(Le(e.data)||Re(e.data)||e.data.game.offline),l="fromPosition"===e.data.game.variant.key?"standard":e.data.game.variant.key,d=na.controller(e.data.game.variant,(function(e){e&&(i={},g())})),u=oe((()=>{const e=document.getElementById("explorerTable");e&&(e.scrollTop=0)}),200);function h(){a(!1),n(!0),c()}const p=oe((e=>{const t={db:d.data.db.selected(),speeds:d.data.speed.selected(),ratings:d.data.rating.selected()};return Kn(l,e,t,r).then((t=>{t.isOpening=!0,t.fen=e,o(e,t),a(!1),n(!1),c()})).catch(h)}),1e3,{leading:!0,trailing:!0}),m=oe((e=>Yn(l,e).then((t=>{t.tablebase=!0,t.fen=e,o(e,t),a(!1),n(!1),c()})).catch(h)),500,{leading:!0,trailing:!0});const f={isOpening:!0,moves:[]};function g(){if("explorer"!==e.currentTab(e.availableTabs()).id)return;const t=e.node;t.ply>50&&!Zn(l,t.fen)&&o(t.fen,f);const d=i[t.fen];var h;d?(s(d),a(!1),n(!1)):(a(!0),h=t.fen,r&&Zn(l,h)?m(h):p(h)),c(),u()}return{allowed:t,setStep:g,loading:a,failing:n,config:d,withGames:r,current:s,fetchMasterOpening:function(){const e={};return function(t){return e[t]?Promise.resolve(e[t]):Kn("standard",t,{db:"masters"},!1).then((a=>(e[t]=a,a)))}}(),fetchTablebaseHit:e=>Yn(l,e,2e3).then((t=>{var a;if("unknown"===t.category)throw"unknown tablebase position";const n=Ne(e);return{fen:e,best:null===(a=t.moves[0])||void 0===a?void 0:a.uci,winner:sa(v(n),t.category)}}))}}function Zn(e,t){const a=t.split(/\s/)[0].split(/[nbrqkp]/i).length-1;return"standard"===e||"chess960"===e?a<=8:("atomic"===e||"antichess"===e)&&a<=7}var es={make:(e,t,a,n)=>new re(function(e,t,a,n){const s=h.game.pieceMove();return{fen:e.fen,check:e.check,lastMove:e.lastMove,turnColor:e.turnColor,orientation:t,coordinates:h.game.coords(),movable:{free:!1,color:e.movableColor,dests:e.dests,showDests:h.game.pieceDestinations(),rookCastle:1===h.game.rookCastle()},draggable:{enabled:"drag"===s||"both"===s,magnified:h.game.magnified()},selectable:{enabled:"tap"===s||"both"===s},events:{move:a,dropNewPiece:n},premovable:{enabled:!1},highlight:{lastMove:h.game.highlights(),check:h.game.highlights()},animation:{enabled:!!h.game.animations(),duration:le(h.game.animations())}}}(e,t,a,n))};function ts(e){return{analysisProgress(t){e.mergeAnalysisData(t)},evalHit(t){e.evalCache.onCloudEval(t)},fen(t){e.forecast&&t.id===e.data.game.id&&0!==Mt(e.mainline).fen.indexOf(t.fen)&&e.forecast.reloadToLastPly()}}}const as={id:"infos",title:i("gameInformation"),className:"fa fa-info-circle"},ns={id:"moves",title:i("movesPlayed"),className:"fa fa-list-alt"},ss={id:"ceval",title:"Stockfish",className:"fa fa-cogs"},is={id:"explorer",title:i("openingExplorer"),className:"fa fa-book"},os={id:"analysis",title:i("gameAnalysis"),className:"fa fa-area-chart"},rs={id:"pgnTags",title:i("pgnTags"),className:"fa fa-tags"},ls={id:"comments",title:i("comments"),className:"fa fa-comment-o"};class cs{constructor(e,t){this.data=e,this.rootCtrl=t,this.toggleLike=()=>{this.rootCtrl.socket.send("like",{liked:!this.data.liked})},this.toggleShowComments=()=>{this.vm.showComments=!this.vm.showComments},this.actionMenu=Ht.controller(this.rootCtrl),this.sideMenu=new de("right","studyMenu","studyMenu-backdrop"),this.analyseCtrl=t,e.features.chat&&e.chat&&(this.chat=new it(t.socket,e.id,e.chat.lines,void 0,e.chat.writeable,u.isShadowban(),"Study")),this.vm={showComments:!1},null===h.study.tour()&&(qt(this),h.study.tour(window.deviceInfo.appVersion))}canContribute(){const e=u.getUserId(),t=e&&this.data.members[e];return!!t&&"w"===t.role}createSocket(){return ue.createStudy(this.data.id,(e=this,Object.assign(Object.assign({},ts(e.rootCtrl)),{liking(t){e.data.likes=t.l.likes,t.w&&t.w.s===ce()&&(e.data.liked=t.l.me),c()},message(t){e.chat&&e.chat.append(t)}})));var e}}class ds{constructor(e,t,a,n,s,i,o){this.data=e,this.source=a,this.orientation=n,this.shouldGoBack=s,this.promoting=null,this.onMainline=!0,this.contextMenu=null,this.replaying=!1,this.analysisProgress=!1,this.retroGlowing=!1,this.showThreat=!1,this._currentTabIndex=0,this.canDrop=()=>!0,this.player=()=>this.data.game.player,this.availableTabs=()=>{let e=[ns];return this.study&&this.study.data.chapter.tags.length>0&&(e=[rs,...e]),this.synthetic||(e=[as,...e]),this.study&&(e=[...e,ls]),this.retro||this.practice||!this.ceval.enabled()||(e=[...e,ss]),(this.study||Wt(this.data)&&Ee(this.data))&&(e=[...e,os]),he()&&this.explorer.allowed&&(e=[...e,is]),e},this.currentTabIndex=e=>this._currentTabIndex>e.length-1?e.length-1:this._currentTabIndex,this.currentTab=e=>e[this.currentTabIndex(e)],this.onTabChange=e=>{this._currentTabIndex=e;const t=this.currentTab(this.availableTabs());this.updateHref(),"moves"===t.id?this.debouncedScroll():"explorer"===t.id&&this.explorer.setStep(),c()},this.resetTabs=()=>this.onTabChange(this.currentTabIndex(this.availableTabs())),this.setPath=e=>{this.path=e,this.nodeList=this.tree.getNodeList(e),this.node=Mt(this.nodeList),this.mainline=Ct(this.tree.root),this.onMainline=this.tree.pathIsMainline(e)},this.initCeval=()=>{this.ceval.enabled()&&(this.ceval.isInit()?this.debouncedStartCeval():this.ceval.init().then(this.debouncedStartCeval))},this.startCeval=()=>{if(this.ceval.enabled()&&this.canUseCeval()){const e=!!this.retro||!!this.practice;this.ceval.start(this.showThreat,this.path,this.nodeList,e,!1),this.evalCache.fetch(this.path,e?1:this.ceval.getMultiPv())}},this.stopCevalImmediately=()=>{this.ceval.stop(),this.debouncedStartCeval.cancel()},this.toggleRetro=e=>{this.retro?("backbutton"!==e&&r.backbutton.stack.pop(),this.retro=null,h.analyse.enableCeval()?this.startCeval():this.ceval.disable()):(this.stopCevalImmediately(),this.practice&&(this.practice=null),this.retro=Vn(this),r.backbutton.stack.push(this.toggleRetro),this.retro.jumpToCurrent())},this.togglePractice=()=>{this.practice||!this.ceval.allowed?this.practice=null:(this.retro&&(this.retro=null),this.practice=Jn(this,(()=>18)))},this.toggleShowThreat=()=>{this.ceval.allowed&&(this.ceval.enabled()||this.ceval.toggle(),this.showThreat=!this.showThreat,this.startCeval())},this.debouncedScroll=oe((()=>qe(document.getElementById("replay"))),200),this.jump=(e,t)=>{const a=e!==this.path;this.setPath(e),this.updateBoard(),this.fetchOpening(),this.node&&this.node.san&&"forward"===t&&(-1!==this.node.san.indexOf("x")?pe.throttledCapture():pe.throttledMove()),this.ceval.stop(),this.debouncedExplorerSetStep(),this.updateHref(),a&&(this.retro&&this.retro.onJump(),this.practice&&this.practice.onJump(),this.debouncedStartCeval())},this.userJump=(e,t)=>{if(this.autoplay.stop(),this.practice){const a=this.path;this.practice.preUserJump(a,e),this.jump(e,t),this.practice.postUserJump(a,this.path)}else this.jump(e,t)},this.jumpToMain=e=>{this.userJump(this.mainlinePathToPly(e))},this.jumpToIndex=e=>{this.jumpToMain(e+1+(this.data.game.startedAtTurn||0))},this.canGoForward=()=>this.node.children.length>0,this.next=()=>{if(!this.canGoForward())return!1;const e=this.node.children[0];return e&&this.userJump(this.path+e.id,"forward"),!0},this.fastforward=()=>{this.replaying=!0;const e=this.next();return e||(this.replaying=!1,this.debouncedScroll()),e},this.stopff=()=>{this.replaying=!1,this.next(),this.debouncedScroll()},this.rewind=()=>{this.replaying=!0;const e=this.prev();return e||(this.replaying=!1,this.debouncedScroll()),e},this.stoprewind=()=>{this.replaying=!1,this.prev(),this.debouncedScroll()},this.toggleBookmark=()=>me(this.data.game.id).then((()=>{this.data.bookmarked=!this.data.bookmarked,c()})).catch(d),this.playUci=e=>{const t=ve(e);"@"===e[1]?this.chessground.apiNewPiece({color:this.chessground.state.movable.color,role:fe[e[0]]},t[1]):t[2]?this.sendMove(t[0],t[1],fe[t[2].toUpperCase()]):this.sendMove(t[0],t[1]),this.explorer.loading(!0)},this.canUseCeval=()=>!this.gameOver(),this.hasAnyComputerAnalysis=()=>this.data.analysis||this.ceval.enabled(),this.hasFullComputerAnalysis=()=>Object.keys(this.mainline[0].eval||{}).length>0,this.isOfflineOrNotPlayable=()=>"offline"===this.source||!(!this.study||!this.study.data)||!Oe(this.data),this.unload=()=>{this.autoplay.stop(),this.ceval&&this.ceval.destroy()},this._deleteNode=e=>{this.tree.deleteNodeAt(e),this.contextMenu=null,wt(this.path,e)?this.userJump(xt(e)):this.jump(this.path)},this.updateHref=oe((()=>{r.setQueryParams({tabId:this.currentTab(this.availableTabs()).id,ply:String(this.node.ply),curFen:this.node.fen})}),200),this.canEvalGet=e=>e.ply<15,this.sendMove=(e,t,a)=>{const n={orig:e,dest:t,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};a&&(n.promotion=a),this.practice&&this.practice.onUserMove(),rt(n).then(this.addNode).catch((e=>{}))},this.userMove=(e,t,a)=>{a?pe.capture():pe.move(),Ye.start(this,e,t,this.sendMove)||this.sendMove(e,t)},this.userNewPiece=(e,t)=>{if(Xn.drop(e.role,t,this.node.drops)){pe.move();const a={role:e.role,pos:t,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};lt(a).then(this.addNode).catch((e=>{this.jump(this.path)}))}else this.jump(this.path)},this.addNode=({situation:e,path:t})=>{const a=this.node,n={id:e.id,ply:e.ply,fen:e.fen,children:[],dests:e.dests,drops:e.drops,check:e.check,end:e.end,player:e.player,checkCount:e.checkCount,uci:e.uci,san:e.san,crazyhouse:e.crazyhouse,pgnMoves:a&&a.pgnMoves?a.pgnMoves.concat(e.pgnMoves):e.pgnMoves};if(void 0===t)return;const s=this.tree.addNode(n,t);s&&(this.jump(s),this.debouncedScroll(),c())},this.onCevalMsg=(e,t,a)=>{t?this.tree.updateAt(e,(n=>{var s;if(n.fen===t.fen||a){if(a){const e=t;(!n.threat||He(e,n.threat)||(null===(s=n.threat)||void 0===s?void 0:s.maxDepth)<e.maxDepth)&&(n.threat=e)}else!n.ceval||He(t,n.ceval)?n.ceval=t:t.cloud||(n.ceval.cloud&&this.ceval.isDeeper?n.ceval=t:t.maxDepth>n.ceval.maxDepth&&(n.ceval.maxDepth=t.maxDepth));n.ceval&&n.ceval.pvs.length>0&&(n.ceval.best=n.ceval.pvs[0].moves[0]),e===this.path&&(this.retro&&this.retro.onCeval(),this.practice&&this.practice.onCeval(),t.cloud&&t.depth>=this.ceval.effectiveMaxDepth()&&this.ceval.stop(),c())}})):"ceval"===this.currentTab(this.availableTabs()).id&&c()},this.debouncedStartCeval=oe(this.startCeval,500,{trailing:!0}),this.getNodeSituation=oe((()=>{this.node&&!this.node.dests&&ct({variant:this.data.game.variant.key,fen:this.node.fen,path:this.path}).then((({situation:e,path:t})=>{this.tree.updateAt(t,(t=>{t.dests=e.dests,t.end=e.end,t.player=e.player})),t===this.path&&(this.updateBoard(),c(),this.gameOver()&&this.stopCevalImmediately())})).catch((e=>{}))}),50),this.fetchOpening=oe((()=>{if(he()&&this.node&&void 0===this.node.opening&&this.node.ply<=20&&this.node.ply>0&&ge.has(this.data.game.variant.key)){const e={fen:this.node.fen,path:this.path},t=this.data.game.variant.key;"standard"!==t&&(e.variant=t),this.tree.updateAt(this.path,(t=>{t.opening=null,this.socket.ask("opening","opening",e).then((e=>{e.opening&&e.path&&(t.opening=e.opening,e.path===this.path&&c())})).catch(ye)}))}}),50),this.synthetic=Le(e),this.ongoing=!this.synthetic&&Oe(e),this.initialPath=Pt,this.study=void 0!==t?new cs(t,this):void 0,this.forecast=e.forecast?new gn(e):void 0,this._currentTabIndex=this.study&&0!==this.study.data.chapter.tags.length||!this.synthetic?1:0,-1===h.analyse.supportedVariants.indexOf(this.data.game.variant.key)&&(T.show({text:`Analysis board does not support ${this.data.game.variant.name} variant.`,position:"center",duration:"short"}),r.set("/")),this.tree=Nt(Tt(this.data.treeParts)),this.settings=Jt.controller(this),this.menu=Lt.controller(this),this.continuePopup=gt.controller(),this.autoplay=new jn(this),this.notes=u.isConnected()&&"correspondence"===this.data.game.speed?new nt(this.data):null,this.retro=null,this.practice=null;const l=(()=>{const e=this.study&&this.study.data;if(!Ve.includes(this.data.game.variant.key))return!1;if(e&&!e.chapter.features.computer&&!e.chapter.practice)return!1;return!!S(this.data.game.fen).unwrap((e=>ft(be(this.data.game.variant.key),e).unwrap((()=>!0),(()=>!1))),(()=>!1))&&this.isOfflineOrNotPlayable()})();this.ceval=new Wn({allowed:l,variant:this.data.game.variant.key,multiPv:h.analyse.cevalMultiPvs(),cores:h.analyse.cevalCores(),hashSize:h.analyse.cevalHashSize(),infinite:h.analyse.cevalInfinite()},this.onCevalMsg);const p=!this.study||this.study.data.chapter.features.explorer;this.explorer=Qn(this,p),this.debouncedExplorerSetStep=oe(this.explorer.setStep,le(h.game.animations())+50);const m=void 0!==i?i:this.tree.lastPly();this.gamePath=this.synthetic||this.ongoing?void 0:St(Ct(this.tree.root));const v=Ct(this.tree.root);if(this.initialPath=_t(v,(e=>e.ply<=m)),this.setPath(this.initialPath),this.data.game.createdAt&&(this.formattedDate=we(new Date(this.data.game.createdAt))),this.study?this.socket=this.study.createSocket():!this.data.analysis&&u.isConnected()&&Wt(this.data)&&Ee(this.data)&&void 0!==this.data.url&&void 0!==this.data.player.version?this.socket=ue.createGame(this.data.url.socket,this.data.player.version,ts(this),this.data.url.round):this.socket=ue.createAnalysis(ts(this)),this.synthetic||setTimeout((()=>{this.socket.send("startWatching",this.data.game.id)}),1e3),this.evalCache=function({variant:e,canGet:t,getNode:a,receive:n,socketIface:s}){const i=new Set;return{fetch(n,o){const r=a();if(r.ceval&&r.ceval.cloud||!t(r))return;if(i.has(r.fen))return;i.add(r.fen);const l={fen:r.fen,path:n};"standard"!==e&&(l.variant=e),o>1&&(l.mpv=o),s.send("evalGet",l)},onCloudEval(e){n(e.path,function(e){const t={fen:e.fen,nodes:1e3*e.knodes,depth:e.depth,pvs:e.pvs.map((e=>{const t={moves:e.moves.split(" ")};return void 0!==e.cp?t.cp=e.cp:t.mate=e.mate,t})),cloud:!0};return void 0!==t.pvs[0].cp?t.cp=t.pvs[0].cp:t.mate=t.pvs[0].mate,t.cloud=!0,t}(e))}}}({variant:this.data.game.variant.key,canGet:this.canEvalGet,getNode:()=>this.node,receive:this.onCevalMsg,socketIface:this.socket}),this.updateBoard(),o){const e=this.currentTabIndex(this.availableTabs()),t=this.availableTabs().findIndex((e=>e.id===o));t>=0&&e!==t&&this.onTabChange(t)}"explorer"===this.currentTab(this.availableTabs()).id&&this.debouncedExplorerSetStep(),setTimeout(this.debouncedScroll,250),setTimeout(this.initCeval,1e3)}playerName(e){const t=Ue(this.data,e);return this.study?Ra(this.study.data,e)||"Anonymous":F(t)}topColor(){return v(this.bottomColor())}bottomColor(){return this.settings.s.flip?v(this.data.orientation):this.data.orientation}turnColor(){return Je(this.node.ply)}promote(e,t){this.tree.promoteAt(e,t),this.contextMenu=null,this.jump(e)}deleteNode(e){const t=this.tree.nodeAtPath(e);if(!t)return;const a=It(t);a.nodes>=10||a.comments>0?ke.confirm({title:"Confirm",message:`Delete ${a.nodes} move(s)`+(a.comments?` and ${a.comments} comment(s)`:"")+"?"}).then((()=>this._deleteNode(e))):this._deleteNode(e)}restartPractice(){this.practice=null,this.togglePractice()}mergeAnalysisData(e){this.analysisProgress||(this.analysisProgress=!0,c()),this.tree.merge(e.tree),this.data.analysis=e.analysis;const t=Ct(e.tree);t.every((e=>void 0!==e.eval||!(!e.san||!e.san.includes("#"))))&&(this.data.treeParts=t,this.analysisProgress=!1,this.retroGlowing=!0,setTimeout((()=>{this.retroGlowing=!1,c()}),8e3),pe.dong(),dt.quick(),c()),this.retro&&this.retro.onMergeAnalysisData(),c()}gameOver(e){const t=e||this.node;if(!t)return!1;if(void 0===t.end){if(t.check){const e=t.san;return!!!(!e||"#"!==e[e.length-1])&&"checkmate"}return!1}return!!t.end&&(t.check?"checkmate":"draw")}nextNodeBest(){return Ot(this.node,(e=>e.eval?e.eval.best:void 0))}mainlinePathToPly(e){return _t(this.mainline,(t=>t.ply<=e))}prev(){return this.userJump(xt(this.path),"backward"),!0}updateBoard(){const e=this.node;"threeCheck"!==this.data.game.variant.key||e.checkCount||(e.checkCount=Te(e.fen));const t=Je(e.ply),a=xe(e.dests),n={fen:e.fen,turnColor:t,orientation:this.settings.s.flip?v(this.orientation):this.orientation,movableColor:this.gameOver()?null:t,dests:a||null,check:!!e.check,lastMove:e.uci?L(e.uci):null};this.cgConfig=n,this.data.game.player=t,this.chessground?this.chessground.set(n):this.chessground=es.make(n,this.orientation,this.userMove,this.userNewPiece),a||this.getNodeSituation()}}export{ds as A,In as a,Ft as g,_n as l,On as o,An as r};
