import{m as e,o as t,E as a,h as s,D as r,z as o,w as n,g as l,d as i,r as c,a7 as m,c as d,ba as u,bx as g,bq as p,b as f,cd as b,s as h,aH as v,al as k}from"./main.js";import{l as P}from"./layout-c7d0a2f4.js";import"./browse-1f8ce718.js";import"./game-2ffc1d0e.js";import"./perfs-2bc54d35.js";import"./countries-a19495bf.js";import"./html-1975aa10.js";import{g as N,u as j}from"./userXhr-6849aa54.js";import{u as G}from"./userView-40d332b0.js";import{G as w}from"./GameItem-ca94f525.js";function y(l){return e("div",{className:"userGamesWrapper"},e("div",{className:"select_input select_games_filter"},e("label",{htmlFor:"filterGames"}),e("select",{id:"filterGames",onchange:l.onFilterChange},l.scrollState.availableFilters.map((t=>e("option",{value:t.key,selected:l.scrollState.currentFilter===t.key},o(t.label,t.count)))))),function(o){const{games:l,paginator:i}=o.scrollState;return e("div",{id:"scroller-wrapper",className:"native_scroller userGame-scroller box",oncreate:t((e=>function(e,t){var s;const r=function(e){const t=e.target;return"BUTTON"===t.tagName?t:void 0}(t),o=null===(s=t.target)||void 0===s?void 0:s.closest(".tournament"),l=a(t),i=null==l?void 0:l.dataset.id,c=null==l?void 0:l.dataset.pid;if(i&&r)e.toggleBookmark(i);else if(o){const e=o.dataset.id;e&&n.set(`/tournament/${e}`)}else i&&e.goToGame(i,c)}(o,e)),void 0,a),onscroll:s(o.onScroll,30)},i?e("ul",{className:"userGames",oncreate:o.onGamesLoaded},l.map(((t,a)=>e(w,{key:t.id,g:t,index:a,boardTheme:o.boardTheme,userId:o.scrollState.userId}))),o.scrollState.isLoadingNextPage?e("li",{className:"list_item loadingNext"},"loading..."):null):e("div",{className:"loader_container"},r.getVdom("monochrome")))}(l))}const F={all:"nbGames",rated:"nbRated",win:"nbWins",loss:"nbLosses",draw:"nbDraws",bookmark:"nbBookmarks",me:"nbGamesWithYou",import:"nbImportedGames",playing:"nbPlaying"};let I;function T(e,t){let a=!1;const s=I&&e===I.userId,r=l.general.theme.board(),o={userId:e,user:void 0,availableFilters:[],currentFilter:t||"all",games:[],paginator:void 0,isLoadingNextPage:!1,scrollPos:0};function b(e){return e.paginator&&e.paginator.currentPageResults&&e.paginator.currentPageResults.forEach((e=>{e.date=d(new Date(e.timestamp))})),e}const h=i((()=>{I=o}),200),v=e=>{o.paginator=e.paginator,o.games=e.paginator.currentPageResults,setTimeout((()=>{const e=document.getElementById("scroller-wrapper");e&&(e.scrollTop=0)}),50),c()};return s?setTimeout((()=>{Object.assign(o,I),c()}),300):Promise.all([N(o.userId,o.currentFilter,1,!1).then(b),j(o.userId,!1)]).then((([e,t])=>{(e=>{o.user=e;const t=Object.keys(e.count).filter((t=>Object.prototype.hasOwnProperty.call(F,t)&&("all"===t||e.count[t]>0))).map((e=>({key:e,label:F[e],count:o.user?o.user.count[e]:0})));o.availableFilters=t})(t),v(e)})).catch((e=>{m(e)})),{scrollState:o,onScroll:e=>{const t=e.target,a=t.firstChild,s=o.paginator,r=s&&s.nextPage;var n;t.scrollTop+t.offsetHeight+50>a.offsetHeight&&!o.isLoadingNextPage&&r&&r<40&&(n=r,o.isLoadingNextPage=!0,N(o.userId,o.currentFilter,n).then(b).then((e=>{o.paginator=e.paginator,o.isLoadingNextPage=!1,o.games=o.games.concat(e.paginator.currentPageResults),h(),c()})),c()),o.scrollPos=t.scrollTop,h()},onGamesLoaded:({dom:e})=>{s&&!a&&u((()=>{e.parentNode.scrollTop=I.scrollPos,a=!0}))},onFilterChange:e=>{o.currentFilter=e.target.value,N(o.userId,o.currentFilter,1,!0).then(b).then(v)},toggleBookmark:e=>{g(e).then((()=>{const t=o.games.findIndex((t=>t.id===e)),a=o.games[t];if(a){const e=Object.assign({},a,{bookmarked:!a.bookmarked});o.games[t]=e,c()}})).catch(m)},boardTheme:r,goToGame:(t,a)=>{const s=o.games.find((e=>e.id===t));if(s){const r=s.players.white.user,o=r&&r.id===e?"white":"black";p.set(s.id,{fen:s.fen,orientation:o});f.getUserId()===e&&void 0!==a?n.set(`/game/${t}${a}?goingBack=1`):n.set(`/analyse/online/${t}/${o}?curFen=${s.fen}&slide=1`)}}}}const x={oncreate:b,oninit(e){h.createDefault(),this.ctrl=T(e.attrs.id,e.attrs.filter)},view(e){const{id:t,username:a,title:s,patron:r}=e.attrs,o=this.ctrl.scrollState.user,n=o?G(o.online,o.patron,o.username,o.title):G(!1,Boolean(r),a||t,s),l=v(null,k(n));return P.free(l,y(this.ctrl))}};export default x;
