import{m as e,o as a,E as t,h as s,D as r,z as o,w as n,g as l,d as i,r as c,a7 as m,c as d,aR as u,bC as g,bv as p,b as f,ce as b,s as h,aN as v,am as k}from"./main.js";import{l as N}from"./layout-e08f9316.js";import{u as P}from"./userView-e85acd19.js";import"./html-1975aa10.js";import"./perfs-9aa7202a.js";import"./countries-a19495bf.js";import{g as G,u as j}from"./userXhr-ce47bd25.js";import"./game-0dbfee7c.js";import{G as y}from"./GameItem-6cb234dd.js";function F(l){return e("div",{className:"userGamesWrapper"},e("div",{className:"select_input select_games_filter"},e("label",{htmlFor:"filterGames"}),e("select",{id:"filterGames",onchange:l.onFilterChange},l.scrollState.availableFilters.map((a=>e("option",{value:a.key,selected:l.scrollState.currentFilter===a.key},o(a.label,a.count)))))),function(o){const{games:l,paginator:i}=o.scrollState;return e("div",{id:"scroller-wrapper",className:"native_scroller userGame-scroller box",oncreate:a((e=>function(e,a){var s;const r=function(e){const a=e.target;return"BUTTON"===a.tagName?a:void 0}(a),o=null===(s=a.target)||void 0===s?void 0:s.closest(".tournament"),l=t(a),i=null==l?void 0:l.dataset.id,c=null==l?void 0:l.dataset.pid;if(i&&r)e.toggleBookmark(i);else if(o){const e=o.dataset.id;e&&n.set(`/tournament/${e}`)}else i&&e.goToGame(i,c)}(o,e)),void 0,t),onscroll:s(o.onScroll,30)},i?e("ul",{className:"userGames",oncreate:o.onGamesLoaded},l.map(((a,t)=>e(y,{key:a.id,g:a,index:t,boardTheme:o.boardTheme,userId:o.scrollState.userId}))),o.scrollState.isLoadingNextPage?e("li",{className:"list_item loadingNext"},"loading..."):null):e("div",{className:"loader_container"},r.getVdom("monochrome")))}(l))}const I={all:"nbGames",rated:"nbRated",win:"nbWins",loss:"nbLosses",draw:"nbDraws",bookmark:"nbBookmarks",me:"nbGamesWithYou",import:"nbImportedGames",playing:"nbPlaying"};let T;function w(e,a){let t=!1;const s=T&&e===T.userId,r=l.general.theme.board(),o={userId:e,user:void 0,availableFilters:[],currentFilter:a||"all",games:[],paginator:void 0,isLoadingNextPage:!1,scrollPos:0};function b(e){return e.paginator&&e.paginator.currentPageResults&&e.paginator.currentPageResults.forEach((e=>{e.date=d(new Date(e.timestamp))})),e}const h=i((()=>{T=o}),200),v=e=>{o.paginator=e.paginator,o.games=e.paginator.currentPageResults,setTimeout((()=>{const e=document.getElementById("scroller-wrapper");e&&(e.scrollTop=0)}),50),c()};return s?setTimeout((()=>{Object.assign(o,T),c()}),300):Promise.all([G(o.userId,o.currentFilter,1,!1).then(b),j(o.userId,!1)]).then((([e,a])=>{(e=>{o.user=e;const a=Object.keys(e.count).filter((a=>Object.prototype.hasOwnProperty.call(I,a)&&("all"===a||e.count[a]>0))).map((e=>({key:e,label:I[e],count:o.user?o.user.count[e]:0})));o.availableFilters=a})(a),v(e)})).catch((e=>{m(e)})),{scrollState:o,onScroll:e=>{const a=e.target,t=a.firstChild,s=o.paginator,r=s&&s.nextPage;var n;a.scrollTop+a.offsetHeight+50>t.offsetHeight&&!o.isLoadingNextPage&&r&&r<40&&(n=r,o.isLoadingNextPage=!0,G(o.userId,o.currentFilter,n).then(b).then((e=>{o.paginator=e.paginator,o.isLoadingNextPage=!1,o.games=o.games.concat(e.paginator.currentPageResults),h(),c()})),c()),o.scrollPos=a.scrollTop,h()},onGamesLoaded:({dom:e})=>{s&&!t&&u((()=>{e.parentNode.scrollTop=T.scrollPos,t=!0}))},onFilterChange:e=>{o.currentFilter=e.target.value,G(o.userId,o.currentFilter,1,!0).then(b).then(v)},toggleBookmark:e=>{g(e).then((()=>{const a=o.games.findIndex((a=>a.id===e)),t=o.games[a];if(t){const e=Object.assign({},t,{bookmarked:!t.bookmarked});o.games[a]=e,c()}})).catch(m)},boardTheme:r,goToGame:(a,t)=>{const s=o.games.find((e=>e.id===a));if(s){const r=s.players.white.user,o=r&&r.id===e?"white":"black";p.set(s.id,{fen:s.fen,orientation:o});f.getUserId()===e&&void 0!==t?n.set(`/game/${a}${t}?goingBack=1`):n.set(`/analyse/online/${a}/${o}?curFen=${s.fen}&slide=1`)}}}}const x={oncreate:b,oninit(e){h.createDefault(),this.ctrl=w(e.attrs.id,e.attrs.filter)},view(e){const{id:a,username:t,title:s,patron:r}=e.attrs,o=this.ctrl.scrollState.user,n=o?P(o.online,o.patron,o.username,o.title):P(!1,Boolean(r),t||a,s),l=v(null,k(n));return N.free(l,F(this.ctrl))}};export default x;
