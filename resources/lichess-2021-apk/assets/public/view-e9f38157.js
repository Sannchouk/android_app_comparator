import{aW as e,aC as t,g as a,aX as n,aY as o,b as i,q as s,ar as r,aB as c,a2 as l,m as u,C as d,aZ as p,o as h,ah as f,a_ as m}from"./main.js";import{l as g,p as v,g as y,j as b}from"./game-2ffc1d0e.js";import{r as M}from"./crazyValid-11f86c1c.js";import{C as k}from"./CrazyPocket-cee87a95.js";import{b as w,g as N,o as C,c as _}from"./replay-4865f30a.js";import{m as T,d as P,t as D,p as j}from"./chess-3e18520f.js";function F(o,i){const s=i.uciMoves.length?i.uciMoves[i.uciMoves.length-1]:null,r=a.game.pieceMove();return{fen:i.fen,orientation:e(o),turnColor:i.player,lastMove:s?t(s):null,check:i.check,otb:"offline_otb"===o.game.id,coordinates:a.game.coords(),otbMode:a.otb.flipPieces()?"flip":"facing",symmetricCoordinates:"offline_otb"===o.game.id,autoCastle:!0,highlight:{lastMove:a.game.highlights(),check:a.game.highlights()},movable:{free:!1,color:g(o)?i.player:null,showDests:a.game.pieceDestinations(),dests:i.dests,rookCastle:1===a.game.rookCastle()},animation:{enabled:!!a.game.animations(),duration:n(a.game.animations())},premovable:{enabled:!1},draggable:{enabled:"drag"===r||"both"===r,centerPiece:o.pref.centerPiece,distance:3,magnified:a.game.magnified()},selectable:{enabled:"tap"===r||"both"===r}}}var x={make:function(e,t,a,n,i,s){const r=F(e,t);return r.movable.events={after:a,afterNewPiece:n},r.events={move:i,dropNewPiece:s},new o(r)},reload:function(e,t,a){e.reconfigure(F(t,a))},end:function(e){e.stop()},changeOTBMode:function(e,t){e.setOtbMode(t?"flip":"facing")}};const z={key:"standard",name:"Standard",short:"STD",title:"Standard rules of chess (FIDE)"};function A(e){const t=e.color||"white",o={color:t,username:"offline_ai"===e.id?i.appUser(s(t)):s(t),spectator:!1};return{game:{id:e.id,offline:!0,variant:e.variant||z,initialFen:e.initialFen||r,source:"offline",fen:e.fen||r,player:e.player||"white",turns:0,startedAtTurn:0,status:{id:20,name:"created"},speed:"unlimited",createdAt:Date.now()},player:o,opponent:{color:c(t),username:s(c(t))},pref:{animationDuration:n(a.game.animations()),centerPiece:e.pref&&e.pref.centerPiece||!1},steps:[],offlineClock:e.clock}}function R(e,t,a){const n=e.replay.situation();e.data.game.status=t||{id:20,name:"started"},e.data.game.winner=a||n.winner}class S{constructor(e,t,a,n,o,i){this.situation=()=>this.situations[this.ply],this.addMove=(e,t,a)=>{const n=this.situation();T({variant:this.variant,fen:n.fen,pgnMoves:n.pgnMoves,uciMoves:n.uciMoves,promotion:a,orig:e,dest:t}).then(this.addMoveOrDrop).catch(console.error.bind(console))},this.addDrop=(e,t)=>{const a=this.situation();P({variant:this.variant,fen:a.fen,pgnMoves:a.pgnMoves,uciMoves:a.uciMoves,role:e,pos:t}).then(this.addMoveOrDrop).catch(console.error.bind(console))},this.claimDraw=()=>{const e=this.situation();D({variant:this.variant,initialFen:this.initialFen,pgnMoves:e.pgnMoves}).then((e=>{e.threefoldRepetition?this.onThreefoldRepetition(e.status):l.show({text:s("incorrectThreefoldClaim"),position:"center",duration:"short"})})).catch(console.error.bind(console))},this.pgn=(e,t)=>{const a=this.situation();return j({variant:this.variant,initialFen:this.initialFen,pgnMoves:a.pgnMoves,white:e,black:t})},this.addMoveOrDrop=e=>{this.ply++,this.ply<this.situations.length&&(this.situations=this.situations.slice(0,this.ply)),this.situations.push(e.situation),this.onReplayAdded(this.situation())},this.init(e,t,a,n),this.onReplayAdded=o,this.onThreefoldRepetition=i}init(e,t,a,n){this.variant=e,this.initialFen=t,this.situations=a,this.ply=n||0}}let U;function O(e,t,a,n,o,i,s){const r=e.replay.situation(),l=!!r.crazyhouse,d=("player"===n?e.data.player:e.data.opponent).color,p=["playTable","offline",n,l?"crazy":"",void 0!==o?o?"mode_flip":"mode_facing":"",e.chessground.state.turnColor===e.data.player.color?"player_turn":"opponent_turn"].join(" ");return u("section",{id:n+"_info",className:p},u("div",{className:"antagonistInfos offline"+(l?" crazy":"")},u("div",{className:"antagonistUser"},t,l&&s?Z(s,d):""),l?null:u("div",{className:"ratingAndMaterial"},"horde"===e.data.game.variant.key?null:M(a),"threeCheck"===e.data.game.variant.key?u("div",{className:"checkCount"}," +",function(e,t){const a=e.replay.situation();return a.checkCount?"white"===c(t)?a.checkCount.white:a.checkCount.black:0}(e,d)):null)),r.crazyhouse?u(k,{ctrl:e,crazyData:r.crazyhouse,color:d,position:n,customPieceTheme:i}):s?Z(s,d):null)}function I(e){return u("section",{className:"actions_bar"},u("button",{className:"action_bar_button fa fa-list",oncreate:d(e.actions.open)}),u("button",{className:"action_bar_button fa fa-plus-circle",oncreate:d(e.newGameMenu.open,(()=>l.show({text:s("createAGame"),duration:"short",position:"bottom"})))}),u("button",{className:"fa fa-share-alt action_bar_button",oncreate:d(e.sharePGN,(()=>l.show({text:s("sharePgn"),duration:"short",position:"bottom"})))}),u("button",{className:"action_bar_button","data-icon":"A",oncreate:d(e.goToAnalysis)}),q(e),E(e))}function G(e){if(!e.replay)return null;const t=e.replay.situation();if(y.finished(e.data)){const a=b(e.data),n=t.winner,o=y.toLabel(e.data.game.status.name,e.data.game.turns,e.data.game.winner,e.data.game.variant.key)+(n?". "+s("white"===n?"whiteIsVictorious":"blackIsVictorious")+".":"");return u("div",{className:"result"},a,u("br",null),u("em",{className:"resultStatus"},o))}return null}function L(e){return v(e.data)?u("button.draw-yes",{oncreate:d((()=>e.replay.claimDraw()))},u("span","½"),s("threefoldRepetition")):null}function V(e){return U=void 0===U?a.game.pieceNotation():U,u("div.replay.box",{className:U?" displayPieces":"",oncreate:t=>{setTimeout((()=>w(t.dom)),100),h((t=>C(e,t)),void 0,N)(t)},onupdate:e=>w(e.dom)},H(e.replay))}function B(e){return U=void 0===U?a.game.pieceNotation():U,e.moveList?u("div.replay_inline",{className:U?" displayPieces":"",oncreate:t=>{setTimeout((()=>_(t.dom)),100),m((t=>C(e,t)),void 0,N)(t)},onupdate:e=>_(e.dom)},H(e.replay)):null}function q(e){return u("button.action_bar_button.fa.fa-chevron-left",{oncreate:d(e.jumpPrev,e.jumpFirst),className:f({disabled:!(e.replay.ply>e.firstPly())})})}function E(e){return u("button.action_bar_button.fa.fa-chevron-right",{oncreate:d(e.jumpNext,e.jumpLast),className:f({disabled:!(e.replay.ply<e.lastPly())})})}function H(e){return e.situations.filter((e=>void 0!==e.san)).map((t=>{return u("move.replayMove",{className:t.ply===e.ply?"current":"","data-ply":t.ply},[1&t.ply?u("index",(a=t.ply,n=!0,u("index",W(a,n)))):null,p(t.san)]);var a,n}))}function W(e,t){return function(e){return Math.floor((e-1)/2)+1}(e)+(t?e%2==1?".":"...":"")}function X(e){return(e<10?"0":"")+e}function Y(e,t=!1){const a=new Date(e),n=a.getUTCMilliseconds(),o=X(a.getUTCMinutes()),i=X(a.getUTCSeconds());if(e>=36e5){return X(a.getUTCHours())+(t&&n<500?" ":":")+o}if(e<1e4){const e=Math.floor(n/100).toString();return[o+":"+i,u("tenths","."+e)]}return o+":"+i}function Z(e,t){const a=e.activeSide(),n=e.getTime(t),o=a===t,i="stage"===e.clockType?e.getMoves(t):null;return u("div",{className:f({clock:!0,outoftime:!n,running:o,offlineClock:!0,stageClock:!!i})},[Y(n,o),i?u("div.clockMoves","Moves: "+i):null])}export{S as R,L as a,V as b,B as c,A as d,O as e,E as f,x as g,q as h,I as i,G as r,R as s};
