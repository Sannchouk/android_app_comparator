import{w as t,ba as e,r as a,d as s,a7 as i,c as r,m as o,cw as c,C as n,af as d,q as l,h,o as u,cx as p,D as g,cu as m,cf as v,G as y,s as S,aH as f}from"./main.js";import{l as b}from"./layout-c7d0a2f4.js";import{b as w,l as P}from"./studyXhr-6378d14d.js";class C{constructor(r="all",o="hot",c){if(this.cat=r,this.order=o,this.q=c,this.initialized=!1,this.toggleSearch=()=>{this.state.showSearch=!this.state.showSearch},this.canCancelSearch=t=>{this.state.canCancelSearch=t},this.cancelSearch=()=>{this.q?t.setQueryParams({cat:this.cat,order:this.order},!0):this.state.showSearch=!1},this.onSearch=e=>{e.preventDefault(),e.stopPropagation();const a=e.target[0].value.trim();t.setQueryParams({q:a},!0)},this.onCatChange=e=>{const a=e.target.value;t.setQueryParams({cat:a},!0)},this.onOrderChange=e=>{const a=e.target.value;t.setQueryParams({order:a},!0)},this.onScroll=t=>{const e=t.target,a=e.firstChild,s=this.state.paginator,i=s&&s.nextPage;e.scrollTop+e.offsetHeight+50>a.offsetHeight&&!this.state.isLoading&&i&&i<40&&this.loadNextPage(i),this.state.scrollPos=e.scrollTop,this.saveState()},this.afterLoad=({dom:t})=>{this.cacheAvailable&&!this.initialized&&e((()=>{q&&(t.parentNode.scrollTop=q.scrollPos),this.initialized=!0}))},this.loadNextPage=t=>{this.state.isLoading=!0;(this.q?w(this.q,t):P(this.cat,this.order,t)).then((t=>{this.state.paginator=t.paginator,this.state.isLoading=!1,this.state.studies=this.state.studies.concat(t.paginator.currentPageResults.map(I)),this.saveState(),a()})),a()},this.saveState=s((()=>{q=this.state}),200),this.state={studies:[],paginator:void 0,scrollPos:0,showSearch:!!this.q,canCancelSearch:!!this.q,isLoading:!1,stateId:this.q||this.cat+this.order},this.cacheAvailable=!!q&&this.state.stateId===q.stateId,this.cacheAvailable)setTimeout((()=>{Object.assign(this.state,q),a()}),300);else{(this.q?w(this.q):P(this.cat,this.order)).then((t=>{this.state.studies=t.paginator.currentPageResults.map(I),this.state.paginator=t.paginator,a()})).catch(i)}}goToStudy(e){t.set(`/study/${e}`)}}let q;function I(t){return Object.assign(Object.assign({},t),{date:r(new Date(t.updatedAt))})}const T=[["all",l("allStudies")],["mine",l("myStudies")],["member",l("studiesIContributeTo")],["public",l("myPublicStudies")],["private",l("myPrivateStudies")],["likes",l("myFavoriteStudies")]],x=[["hot",l("hot")],["newest",l("dateAddedNewest")],["updated",l("recentlyUpdated")],["popular",l("mostPopular")]];function L(t){const e=t.state?t.state.studies:[];return o("div#scroller-wrapper.native_scroller.study-pagerScroller.box",{onscroll:h(t.onScroll,30),oncreate:u((e=>function(t,e){const a=m(e,".study-pagerItem"),s=null==a?void 0:a.dataset.id;s&&t.goToStudy(s)}(t,e)),void 0,p(".study-pagerItem"))},t.state.paginator?e.length?o("ul",{oncreate:t.afterLoad},[...e.map(((t,e)=>o(N,{study:t,index:e}))),t.state.isLoading?o("li.list_item.study-pagerItem","loading..."):[]]):o("div.study-pagerEmpty","None yet"):o("div.study-pagerLoader",g.getVdom("monochrome")))}const N={onbeforeupdate:({attrs:t},{attrs:e})=>t.study!==e.study,view({attrs:t}){const{study:e,index:a}=t,s=e.owner?v(e.owner):"?";return o("li.list_item.study-pagerItem",{className:a%2==0?"even":"odd","data-id":e.id},[o("div.study-pagerItemTitle",[o("i[data-icon=4]"),o("div",[o("h2",e.name),o("h3",[o("i.fa",{className:e.liked?"fa-heart":"fa-heart-o"}),o("span",` ${e.likes} • ${s} • ${e.date}`)])])]),o("div.study-pagerItemBody",[o("ul.chapters",e.chapters.map((t=>o("li",[o("span.fa.fa-circle-o"),t])))),o("ul.members",e.members.filter((t=>null!==t.user)).map((t=>o("li.withIcon",{"data-icon":"w"===t.role?"":"v"},v(t.user)))))])])}};var j={oncreate:y,oninit({attrs:t}){S.createDefault(),this.ctrl=new C(t.cat,t.order,t.q)},view(){const t=this.ctrl;return b.free(f(l("studyMenu")),function(t){return o("div.study-pagerWrapper",[o("div.study-pagerSubHeader.subHeader",[t.state.showSearch?o("form.study-pagerSearchWrapper",{onsubmit:t.onSearch},[o("div.inputWrapper",[o("input#studySearch[type=search]",{placeholder:"Search studies",autocapitalize:"off",autocomplete:"off",oncreate:c,value:t.q,oninput:s((e=>{const s=e.target.value.trim();t.canCancelSearch(s.length>0),a()}),200,{leading:!0,trailing:!0})}),t.state.canCancelSearch?o("div.cancel",{oncreate:n(t.cancelSearch)},d):null]),o("button",l("search"))]):o("div.study-pagerSelectWrapper",[o("div.categories",o("select.study-pagerSelect",{value:t.cat,onchange:t.onCatChange},T.map((t=>o("option",{key:t[0],value:t[0]},t[1]))))),o("div.orders",o("select.study-pagerSelect",{value:t.order,onchange:t.onOrderChange},x.map((t=>o("option",{key:t[0],value:t[0]},t[1])))))]),o("div.study-pagerToggleSearch.fa.fa-search",{oncreate:n(t.toggleSearch)})]),L(t)])}(t))}};export default j;
