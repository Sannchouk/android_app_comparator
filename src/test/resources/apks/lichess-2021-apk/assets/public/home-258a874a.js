import{f as e,d as t,r as a,i as n,s as o,l as s,a as r,b as i,n as l,t as c,c as u,Z as d,e as m,g as h,h as f,j as p,k as b,N as g,A as v,m as w,o as y,p as _,q as k,u as z,v as P,w as T,x as S,y as N,z as C,B as G,C as M,D as j,E as x,F as I,G as O,H as L,I as B}from"./main.js";import{p as D,l as F}from"./layout-c7d0a2f4.js";import{o as A}from"./browse-1f8ce718.js";import{supportedTypes as W,timelineOnTap as E,renderTimelineEntry as V}from"./timeline-8b6b0aef.js";import{l as R,d as $}from"./offlineService-13905bf9.js";import{e as q}from"./fen-acee80a0.js";import"./CountdownTimer-265e230d.js";import{M as Y}from"./miniBoard-183a9cfa.js";import{T as H,a as U}from"./TabView-c796731e.js";import"./tournamentXhr-b8f81bd7.js";import{r as K}from"./tournamentsListView-044a49a4.js";class X{constructor(w){this.isScrolling=!1,this.afterScroll=t((()=>{this.isScrolling=!1,a()}),200),this.onScroll=()=>{this.isScrolling=!0,this.afterScroll()},this.redrawIfNotScrolling=()=>{this.isScrolling||a()},this.socketSend=(e,t)=>{this.socket&&this.socket.send(e,t)},this.unload=()=>{this.networkListener.remove(),this.appStateListener.remove()},this.init=()=>{n()&&(this.socket=o.createLobby("homeLobby",(()=>{this.reloadCorresPool(),this.getFeatured()}),{redirect:o.redirectToGame,reload_seeks:this.reloadCorresPool,resync:()=>s().then((e=>{o.setVersion(e.lobby.version)})),n:(e,t)=>{r.homePong.dispatch(t)},featured:()=>{this.getFeatured()},fen:e=>{this.featuredGame&&this.featuredGame.id===e.id&&(this.featuredGame.fen=e.fen,this.featuredGame.lastMove=e.lm,this.featuredGame.c={black:e.bc,white:e.wc},a())},finish:e=>{this.featuredGame&&this.featuredGame.id===e.id&&(this.featuredGame.finished=!0,"b"===e.win?this.featuredGame.winner="black":"w"===e.win&&(this.featuredGame.winner="white"),a())}}),Promise.all([e("/tournament/featured",void 0),i.refresh().then((()=>i.isKidMode()?Promise.resolve([]):e("/api/streamer/featured",void 0)))]).then((e=>{const[t,n]=e;this.featuredTournaments=t.featured,this.featuredStreamers=n,a()})).catch(l),e("/training/daily",void 0).then((e=>{this.dailyPuzzle=e,a()})),c().then((e=>{this.timeline=e.entries.filter((e=>-1!==W.indexOf(e.type))).slice(0,15).map((e=>(e.fromNow=u(new Date(e.date)),e))),a()})).catch((()=>{this.timeline=[]})))},this.loadOfflinePuzzle=()=>{const e=i.get();e&&R($,e).then((e=>{this.offlinePuzzle=e,a()}))},this.onTabChange=e=>{const t=window.location.search.replace(/\?tab=\w+$/,"");try{window.history.replaceState(window.history.state,"",t+"?tab="+e)}catch(e){}this.selectedTab=e,1===this.selectedTab&&this.reloadCorresPool(),a()},this.cancelCorresSeek=e=>{const t=document.getElementById(e);t&&d(t,"opacity","0",300,"ease-out").then((()=>this.socketSend("cancelSeek",e))).catch(console.log.bind(console))},this.joinCorresSeek=e=>{this.socketSend("joinSeek",e)},this.reloadCorresPool=()=>{1===this.selectedTab&&m(!1).then((e=>{this.corresPool=function(e){const t=i.getUserId();t&&e.sort(((e,a)=>Z(e)===t?-1:Z(a)===t?1:0));return[...e.map((e=>[e,(Z(e)===t?e.id:e.username)+e.mode+e.perf.key+e.days+e.color])).filter((([e,t],a,n)=>n.map((e=>e[1])).indexOf(t)===a)).map((([e])=>e))]}(e).filter((e=>h.game.supportedVariants.includes(e.variant.key))).sort(((e,t)=>e.rating>t.rating?-1:1)),this.redrawIfNotScrolling()}))},this.getFeatured=f((()=>{p("best",!1).then((e=>{const t=J(e.opponent),a=J(e.player);this.featuredGame={c:e.clock?{white:Math.round(e.clock.white),black:Math.round(e.clock.black)}:void 0,black:"white"===e.game.player?t:a,orientation:e.orientation,fen:e.game.fen,id:e.game.id,lastMove:e.game.lastMove,white:"white"===e.game.player?a:t},this.socketSend("startWatching",e.game.id),this.redrawIfNotScrolling()}))}),1e3),this.corresPool=[],this.selectedTab=w||0,b()?this.init():this.loadOfflinePuzzle(),this.networkListener=g.addListener("networkStatusChange",(e=>{e.connected&&this.init()})),this.appStateListener=v.addListener("appStateChange",(e=>{e.isActive&&this.init()}))}}function Z(e){return e.username.toLowerCase()}function J(e){return{name:e.name||e.username||e.user&&e.user.username||"",rating:e.rating||0,ratingDiff:e.ratingDiff||0,berserk:e.berserk,title:e.user&&e.user.title}}function Q(e){return b()?function(e){var t;const a=null===(t=i.get())||void 0===t?void 0:t.playban,n=a&&new Date(a.date+6e4*a.mins);return w("div",{className:"home"},n&&(n.valueOf()-Date.now())/1e3>1?(o=n,w("div",{className:"home-playbanInfo"},w("h2",null,k("sorry")),w("p",null,k("weHadToTimeYouOutForAWhile")),w("br",null),w("p",null,w.trust(k("timeoutExpires",`<strong>${P(o)}</strong>`))),w("h2",null,k("why")),w("p",null,k("pleasantChessExperience"),w("br",null),k("goodPractice"),w("br",null),k("potentialProblem")),w("h2",null,k("howToAvoidThis")),w("ul",null,w("li",null,k("playEveryGame")),w("li",null,k("tryToWin")),w("li",null,k("resignLostGames"))),w("br",null),w("p",null,k("temporaryInconvenience"),w("br",null),k("wishYouGreatGames"),w("br",null),k("thankYouForReading")))):function(e){const t=[{id:"quick",f:()=>N((()=>_.openRealTime("custom")))},{id:"corres",f:()=>function(e){return w("div.corresPoolWrapper.native_scroller",[w("table.corres_seeks",[w("thead",[w("tr",[w("th",""),w("th",k("player")),w("th",k("rating")),w("th",k("time")),w("th",k("mode"))])]),w("tbody",e.corresPool.map((t=>function(e,t){const a=t.username.toLowerCase()===i.getUserId()?"cancelCorresSeek":"joinCorresSeek",n=""===t.color?"random":"white"===t.color?"white":"black";return w("tr",{key:"seek"+t.id,id:t.id,className:"corres_seek "+a,oncreate:y((()=>e[a](t.id)))},[w("td",w("span.color-icon."+n)),w("td",t.username),w("td",t.rating+(t.provisional?"?":"")),w("td",t.days?C("nbDays",t.days):"∞"),w("td",w("span.withIcon",{"data-icon":G(t.perf.key)},k(1===t.mode?"rated":"casual")))])}(e,t))))]),w("div.corres_create",[w("button.defaultButton",{oncreate:M(_.openCorrespondence)},k("createAGame"))])])}(e)}];return w("div.home__lobby",[w(H,{buttons:[{label:k("quickPairing")},{label:k("correspondence")}],selectedIndex:e.selectedTab,onTabChange:e.onTabChange,wrapperClass:"homeSetup",withBottomBorder:!0}),w(U,{selectedIndex:e.selectedTab,tabs:t,onTabChange:e.onTabChange,className:"home__setupTabView"})])}(e),function(e){return w("div",{className:"home__start"},w("div",{className:"home__buttons"},w("button",{className:"buttonMetal",oncreate:y((()=>_.openRealTime("custom")))},k("createAGame")),w("button",{className:"buttonMetal",oncreate:y((()=>z.open()))},k("playWithAFriend")),w("button",{className:"buttonMetal",oncreate:y(D.open)},k("playWithTheMachine"))),w(ee,{ctrl:e}))}(e),w("div",{className:"home__side"},function(e){var t;return(null===(t=e.featuredStreamers)||void 0===t?void 0:t.length)?w("ul.home__streamers",e.featuredStreamers.map((e=>w("li.home__streamer",{oncreate:y((()=>A(e.url)))},[w("strong[data-icon=]",(e.user.title?e.user.title+" ":"")+e.user.name),w("span.status"," "+e.status)])))):null}(e),function(e){var t;return(null===(t=e.featuredTournaments)||void 0===t?void 0:t.length)?w("div",{className:"home__tournament"},K(e.featuredTournaments)):null}(e),function(e){const t=e.timeline;if(void 0===t)return w("section",{className:"home__timeline loading"},j.getVdom("monochrome"));if(0===t.length)return w("section",{className:"home__timeline"});return w("section",{className:"home__timeline"},w("ul",{oncreate:y(E,void 0,x)},t.map(V)),w("div",{className:"more"},w("button",{oncreate:y((()=>T.set("/timeline")))},k("more")," »")))}(e)),function(e){const t=e.featuredGame,a=t?{fixed:!1,fen:t.fen,orientation:t.orientation,lastMove:t.lastMove,link:()=>{T.set("/tv?channel=best")},gameObj:t}:{fixed:!1,orientation:"white",fen:q};return w("section",{className:"home__featured"},w(Y,a))}(e),function(e){const t=e.dailyPuzzle,a=t&&t.puzzle&&t.game&&t.game.treeParts?{fixed:!0,fen:t.game.treeParts.fen,lastMove:t.game.treeParts.uci,orientation:t.puzzle.color,link:()=>T.set(`/training/${t.puzzle.id}?initFen=${t.puzzle.fen}&initColor=${t.puzzle.color}`),topText:k("puzzleOfTheDay"),bottomText:"white"===t.puzzle.color?k("whitePlays"):k("blackPlays")}:{fixed:!0,orientation:"white",fen:q};return w("section",{className:"home__miniPuzzle"},w(Y,a))}(e));var o}(e):function(e){const t=e.offlinePuzzle,a=t?{fixed:!0,fen:t.puzzle.fen,orientation:t.puzzle.color,link:()=>T.set("/training")}:null;return w("div",{className:"homeOfflineWrapper"+(a?" withBoard":"")},w("div",{className:"home homeOffline"},w("section",{className:"playOffline"},w("h2",null,k("playOffline")),w("button",{className:"fatButton",oncreate:y((()=>T.set("/ai")))},k("computer")),w("button",{className:"fatButton",oncreate:y((()=>T.set("/otb")))},k("overTheBoard"))),a?w("section",{className:"home__miniPuzzle"},w("h2",{className:"homeTitle"},k("puzzles")),w(Y,a)):void 0))}(e)}const ee={oncreate({attrs:e}){const t=te(e.ctrl,"#nb_games_in_play > strong",8,o.getCurrentPingInterval),a=te(e.ctrl,"#nb_connected_players > strong",10,o.getCurrentPingInterval);this.render=e=>{a(e.d),setTimeout((()=>{t(e.r)}),o.getCurrentPingInterval()/2)},r.homePong.add(this.render)},onremove(){r.homePong.remove(this.render)},view:()=>w("div.home__stats",[w("div#nb_connected_players",w.trust(k("nbPlayers:other","<strong>?</strong>"))),w("div#nb_games_in_play",w.trust(k("nbGames:other","<strong>?</strong>")))])};function te(e,t,a,n){let o,s;function r(t,n,o,r){const i=S(Math.round((n*(a-1-r)+o*(r+1))/a));t&&i!==s&&(e.isScrolling||(t.textContent=i,s=i))}let i=[];return function(e,s){const l=document.querySelector(t);if(!l||!e&&0!==e)return;s&&(a=Math.abs(s)),i.forEach(clearTimeout),i=[];const c=0===o?0:o||e;o=e;const u=Math.abs(n()/a);for(let t=0;t<a;t++)i.push(setTimeout((()=>r(l,c,e,t)),Math.round(t*u)))}}var ae={oninit({attrs:e}){this.ctrl=new X(I(e.tab)),r.sessionRestored.add(this.ctrl.loadOfflinePuzzle)},oncreate:O,onremove(){o.destroy(),this.ctrl.unload(),r.sessionRestored.remove(this.ctrl.loadOfflinePuzzle)},view(){const e=L("lichess.org");return F.free(e,Q(this.ctrl),void 0,void 0,"ios"===B.platform?this.ctrl.onScroll:void 0)}};export default ae;
