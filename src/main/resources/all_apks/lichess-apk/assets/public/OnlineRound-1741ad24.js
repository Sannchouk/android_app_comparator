import{b1 as t,g as e,r as s,b3 as a,bz as i,bA as o,aE as n,h as r,s as h,a2 as c,q as l,w as d,bB as p,k as m,b as u,aM as k,bC as g,a7 as v,A as b,a as f,bk as y,I as w,bD as M}from"./main.js";import{l as T,q as C,p as D,s as S,v as P,w as x,x as A,k as U,g as j}from"./game-0dbfee7c.js";import{f as I,h as B,p as F,c as R,a as z}from"./crazyValid-b1cecd22.js";import{a as O,r as L,N}from"./toInteger-d296e300.js";import{C as V}from"./chat-e47e82a7.js";import{v as G}from"./vibrate-5137c134.js";class E{constructor(t){this.ctrl=t,this.register=()=>{this.current=setTimeout(this.expire,1e4)},this.clear=()=>{clearTimeout(this.current)},this.expire=()=>{this.ctrl.reloadGameData()}}}function q(a,n,r=!1){const h=a.steps[a.steps.length-1],c=a.game.lastMove?i(a.game.lastMove):"crazyhouse"===a.game.variant.key&&h&&null!==h.uci?o(h.uci):null,l=e.game.pieceMove();return{fen:n,orientation:t(a,r),turnColor:a.game.player,lastMove:c,check:h.check,coordinates:e.game.coords(),autoCastle:!0,highlight:{lastMove:e.game.highlights(),check:e.game.highlights()},movable:{free:!1,color:T(a)?a.player.color:null,dests:T(a)?C(a.possibleMoves):{},showDests:e.game.pieceDestinations(),rookCastle:1===e.game.rookCastle()},animation:{enabled:!!e.game.animations(),duration:a.pref.animationDuration},premovable:{enabled:a.pref.enablePremove,showDests:e.game.pieceDestinations(),castle:"antichess"!==a.game.variant.key,events:{set:()=>s(),unset:s}},predroppable:{enabled:a.pref.enablePremove&&"crazyhouse"===a.game.variant.key,events:{set:()=>s(),unset:s}},draggable:{enabled:"drag"===l||"both"===l,distance:3,magnified:e.game.magnified(),preventDefault:"crazyhouse"!==a.game.variant.key},selectable:{enabled:"tap"===l||"both"===l}}}var W={make:function(t,e,s,i,o,n){const r=q(t,e);return r.movable.events={after:s,afterNewPiece:i},r.events={move:o,dropNewPiece:n},r.viewOnly=t.player.spectator,new a(r)},reload:function(t,e,s,a){t.reconfigure(q(e,s,a))}};class ${constructor(t,e){this.opts=e,this.emergSound={play:n.lowtime,delay:2e4,playable:{white:!0,black:!0}},this.elements={white:null,black:null},this.setClock=(t,e,s,a=0)=>{const i=D(t)&&(S(t)>1||t.clock.running),o=10*a;this.times={white:1e3*e,black:1e3*s,activeColor:i?t.game.player:void 0,lastUpdate:performance.now()+o},i&&this.scheduleTick(this.times[t.game.player],o)},this.addTime=(t,e)=>{this.times[t]+=10*e},this.stopClock=()=>{const t=this.times.activeColor;if(t){const e=this.elapsed();this.times[t]=Math.max(0,this.times[t]-e),this.times.activeColor=void 0}},this.millisOf=t=>this.times.activeColor===t?Math.max(0,this.times[t]-this.elapsed()):this.times[t],this.isRunning=()=>void 0!==this.times.activeColor,this.unload=()=>{clearTimeout(this.tickTimeoutID),this.times.activeColor=void 0},this.scheduleTick=(t,e)=>{void 0!==this.tickTimeoutID&&clearTimeout(this.tickTimeoutID),this.tickTimeoutID=setTimeout(this.tick,t%(this.showTenths(t)?100:500)+1+e)},this.tick=()=>{this.tickTimeoutID=void 0;const t=this.times.activeColor;if(!t)return;const e=performance.now(),s=Math.max(0,this.times[t]-this.elapsed(e));this.scheduleTick(s,0),0===s?this.opts.onFlag():this.updateElement(t,s),this.opts.soundColor===t&&(this.emergSound.playable[t]?s<this.emergMs&&!(e<this.emergSound.next)&&(this.emergSound.play(),this.emergSound.next=e+this.emergSound.delay,this.emergSound.playable[t]=!1):s>1.5*this.emergMs&&(this.emergSound.playable[t]=!0))},this.elapsed=(t=performance.now())=>Math.max(0,t-this.times.lastUpdate);const s=t.clock;if(0===e.showTenths)this.showTenths=()=>!1;else{const t=1===e.showTenths?1e4:36e5;this.showTenths=e=>e<t}this.emergMs=1e3*Math.min(60,Math.max(10,.125*s.initial)),this.setClock(t,s.white,s.black)}updateElement(t,e){const s=this.elements[t];if(s){const a=this.showTenths(e),i=I(e,a,this.times.activeColor===t);a?s.innerHTML=i:s.textContent=i,e<this.emergMs?s.classList.add("emerg"):s.classList.remove("emerg")}}}class Y{constructor(t,e){this.lastUpdate={white:t.white,black:t.black,at:Date.now()},this.els={black:null,white:null},this.data=t,this.onFlag=e}setLastUpdate(t){this.lastUpdate.white=t.white,this.lastUpdate.black=t.black,this.lastUpdate.at=Date.now()}update(t,e){this.data.white=t,this.data.black=e,this.setLastUpdate(this.data)}tick(t){this.data[t]=Math.max(0,this.lastUpdate[t]-(Date.now()-this.lastUpdate.at)/1e3),0===this.data[t]&&this.onFlag();const e=1e3*this.data[t],s=this.els[t];s&&(s.textContent=B(e))}}class H{constructor(t,e){this.ctrl=t,this.moreTime=r((()=>{this.iface.send("moretime")}),300),this.outoftime=function(t,e,s){let a,i=0;return(...o)=>{const n=performance.now()-i,r=()=>{a=void 0,i=performance.now(),t*=e,s(...o)};a&&clearTimeout(a),n>t?r():a=setTimeout(r,t-n)}}(500,1.1,(()=>{this.iface.send("flag",this.ctrl.data.game.player)})),this.berserk=r((()=>{this.iface.send("berserk",null,{ackable:!0})}),200);const a={takebackOffers(e){!t.data.player.proposingTakeback&&e[t.data.player.color]&&(n.dong(),G.quick()),!t.data.opponent.proposingTakeback&&e[t.data.opponent.color]&&(n.dong(),G.quick()),t.data.player.proposingTakeback=e[t.data.player.color],t.data.opponent.proposingTakeback=e[t.data.opponent.color],s()},move(e){e.isMove=!0,t.apiMove(e),s()},drop(e){e.isDrop=!0,t.apiMove(e),s()},clockInc(e){t.clock&&(t.clock.addTime(e.color,e.time),s())},cclock(e){t.data.correspondence&&t.correspondenceClock&&(t.data.correspondence.white=e.white,t.data.correspondence.black=e.black,t.correspondenceClock.update(e.white,e.black),s())},checkCount(e){const a="white"===t.data.player.color;t.data.player.checks=a?e.white:e.black,t.data.opponent.checks=a?e.black:e.white,s()},berserk(e){t.setBerserk(e)},redirect(t){h.redirectToGame(t)},reload:function(e){e&&e.t&&a[e.t]?a[e.t](e.d):t.reloadGameData()},endData(e){t.endWithData(e),s()},rematchOffer(e){t.data.player.offeringRematch=e===t.data.player.color;(t.data.opponent.offeringRematch=e===t.data.opponent.color)&&c.show({text:l("yourOpponentWantsToPlayANewGameWithYou"),position:"center",duration:"short"}),s()},rematchTaken(e){t.data.game.rematch=e},drawOffer(e){t.data.player.offeringDraw=e===t.data.player.color;(t.data.opponent.offeringDraw=e===t.data.opponent.color)&&c.show({text:l("yourOpponentOffersADraw"),position:"center",duration:"short"}),s()},gone(e){t.data.opponent.ai||"correspondence"===t.data.game.speed||(P(t.data,t.data.opponent.color,e),t.chat&&t.chat.showing||s())},message(e){t.chat&&t.chat.append(e)},tvSelect(s){t.data.tv&&s.channel===t.data.tv&&e&&e()},crowd(e){x(t.data,"white",e.white),x(t.data,"black",e.black),t.data.watchers=e.watchers,t.chat&&t.chat.showing||s()}};this.iface=h.createGame(t.data.url.socket,t.data.player.version,a,t.data.url.round,t.data.userTV)}}class J{constructor(a,o,r,l=!1,y,w,M){this.goingBack=a,this.id=o,this.onFeatured=y,this.promoting=null,this.player=()=>this.data.player.color,this.zenAvailable=()=>!this.data.player.spectator&&D(this.data),this.isZen=()=>this.zenAvailable()&&this.zenModeEnabled,this.toggleZenMode=()=>{this.zenModeEnabled=!this.zenModeEnabled,s()},this.goToAnalysis=()=>{const e=this.data;d.set(`/analyse/online/${e.game.id}/${t(e)}?ply=${this.vm.ply}&curFen=${e.game.fen}`)},this.openUserPopup=(t,e)=>{if(void 0===this.score){const t=this.data;if(!t||!t.player.user||!t.opponent.user)return;O(t.player.user.id,t.opponent.user.id).then((t=>{this.score=t,s()}))}this.vm.miniUser[t].data||p(e).then((e=>{this.vm.miniUser[t].data=e,s()})).catch((()=>{this.vm.miniUser[t].showing=!1,s()})),this.vm.miniUser[t].showing=!0},this.closeUserPopup=t=>{this.vm.miniUser[t].showing=!1},this.showActions=()=>{d.backbutton.stack.push(this.hideActions),this.vm.showingActions=!0,this.vm.showingShareActions=!1},this.showShareActions=()=>{this.vm.showingShareActions=!0},this.hideActions=t=>{"backbutton"!==t&&this.vm.showingActions&&d.backbutton.stack.pop(),this.vm.showingActions=!1,this.vm.showingShareActions=!1},this.flip=()=>{this.vm.flip=!this.vm.flip,this.data.tv?this.vm.flip?d.set("/tv?flip=1",!0):d.set("/tv",!0):this.chessground.set({orientation:t(this.data,this.vm.flip)})},this.canOfferDraw=()=>A(this.data)&&(this.lastDrawOfferAtPly||-99)<this.vm.ply-20,this.offerDraw=()=>{this.canOfferDraw()&&(this.lastDrawOfferAtPly=this.vm.ply,this.socket.iface.send("draw-yes",null))},this.canDrop=()=>!this.replaying()&&T(this.data),this.jump=t=>{if(t<this.firstPly()||t>this.lastPly())return!1;const e=this.replaying(),s=t>this.vm.ply;this.vm.ply=t;const a=this.plyStep(t),o={fen:a.fen,lastMove:a.uci?i(a.uci):null,check:a.check,turnColor:this.vm.ply%2==0?"white":"black"};return this.replaying()||(o.movableColor=T(this.data)?this.data.player.color:null,o.dests=C(this.data.possibleMoves)),this.chessground.set(o),!e&&this.replaying()&&this.chessground.stop(),a.san&&s&&(-1!==a.san.indexOf("x")?n.throttledCapture():n.throttledMove()),!0},this.userJump=t=>{this.cancelMove(),this.chessground.selectSquare(null),this.jump(t)},this.jumpNext=()=>this.jump(this.vm.ply+1),this.jumpPrev=()=>this.jump(this.vm.ply-1),this.jumpFirst=()=>this.jump(this.firstPly()),this.jumpLast=()=>this.jump(this.lastPly()),this.cancelMove=t=>{"backbutton"!==t&&d.backbutton.stack.pop(),this.vm.moveToSubmit=null,this.vm.dropToSubmit=null,this.jump(this.vm.ply)},this.submitMove=t=>{t&&(this.vm.moveToSubmit||this.vm.dropToSubmit)&&!this.vm.submitFeedback?(this.vm.moveToSubmit?this.actualSendMove(this.vm.moveToSubmit):this.vm.dropToSubmit&&this.actualSendMove(this.vm.dropToSubmit),"correspondence"!==this.data.game.speed||m()||c.show({text:"You need to be connected to Internet to send your move.",position:"bottom",duration:"short"}),this.vm.moveToSubmit=null,this.vm.dropToSubmit=null,this.vm.submitFeedback=[this.data.game.turns,performance.now()]):this.cancelMove()},this.onReload=t=>{t.steps.length!==this.data.steps.length&&(this.vm.ply=t.steps[t.steps.length-1].ply),this.chat&&this.chat.onReload(t.chat),this.data.tv&&(t.tv=this.data.tv),this.data.userTV&&(t.userTV=this.data.userTV),this.setData(t),this.makeCorrespondenceClock(),this.clock&&this.data.clock&&this.clock.setClock(this.data,this.data.clock.white,this.data.clock.black),this.lastMoveMillis=void 0,this.replaying()||W.reload(this.chessground,this.data,t.game.fen,this.vm.flip),s()},this.reloadGameData=(t=!1)=>{Promise.all([L(this),h.getVersion()]).then((([e,s])=>{null===s||s>e.player.version?t?d.reload():this.reloadGameData(!0):this.onReload(e)})).catch(d.reload)},this.endWithData=t=>{const e=this.data;e.game.winner=t.winner,e.game.status=t.status,e.game.boosted=t.boosted,e.opponent.offeringDraw=!1,this.userJump(this.lastPly()),this.chessground.stop(),this.vm.submitFeedback&&(this.vm.submitFeedback=void 0),t.ratingDiff&&(e.player.ratingDiff=t.ratingDiff[e.player.color],e.opponent.ratingDiff=t.ratingDiff[e.opponent.color]),this.clock&&t.clock&&this.clock.setClock(e,.01*t.clock.wc,.01*t.clock.bc),e.game.turns>1&&(n.dong(),e.player.color===e.game.winner?G.good():G.bad()),this.data.player.spectator||(u.backgroundRefresh(),k(),c.show({text:this.gameStatus(),position:"center",duration:"short"})),this.score},this.toggleBookmark=()=>g(this.data.game.id).then((()=>{this.data.bookmarked=!this.data.bookmarked,s()})).catch(v),this.correspondenceClockTick=()=>{this.correspondenceClock&&D(this.data)&&this.correspondenceClock.tick(this.data.game.player)},this.userMove=(t,e,s)=>{const a=!!s.premove;F.start(this,t,e,a)||this.sendMove(t,e,void 0,a)},this.onUserNewPiece=(t,e,s)=>{!this.replaying()&&R.drop(this.data,t,e,this.data.possibleDrops)?this.sendNewPiece(t,e,!!s.predrop):this.jump(this.vm.ply)},this.onMove=(t,e,s)=>{s?("atomic"===this.data.game.variant.key?(z.capture(this.chessground,e),n.explosion()):n.capture(),this.data.player.spectator||G.heavy()):(n.move(),this.data.player.spectator||G.tap())},this.onNewPiece=()=>{n.move()},this.onResume=()=>{this.blur=!0,L(this).then((t=>{h.setVersion(t.player.version),this.onReload(t)}))},this.setData(r),this.data.userTV=w,this.zenModeEnabled=e.game.zenMode(),this.blur=!1,this.vm={ply:this.lastPly(),flip:l,miniUser:{player:{showing:!1,data:null},opponent:{showing:!1,data:null}},clockPosition:e.game.clockPosition()||"right",showCaptured:!!this.data.pref.showCaptured,moveList:e.game.moveList(),showingActions:!1,showingShareActions:!1,confirmResign:!1,confirmDraw:!1,goneBerserk:{[this.data.player.color]:!!this.data.player.berserk,[this.data.opponent.color]:!!this.data.opponent.berserk},moveToSubmit:null,dropToSubmit:null,tClockEl:null,offlineWatcher:!m()},this.socket=new H(this,this.onFeatured),this.chat=u.isKidMode()||this.data.tv||!this.data.player.spectator&&(this.data.game.tournamentId||this.data.opponent.ai)?null:new V(this.socket.iface,this.data.game.id,this.data.chat||[],this.data.player.spectator?void 0:this.data.player,u.isConnected()||"friend"===this.data.game.source,u.isShadowban(),"correspondence"===this.data.game.speed?"Corres":"Game"),this.notes="correspondence"===this.data.game.speed?new N(this.data):null,this.chessground=W.make(this.data,r.game.fen,this.userMove,this.onUserNewPiece,this.onMove,this.onNewPiece),this.clock=this.data.clock?new $(this.data,{onFlag:this.socket.outoftime,soundColor:this.data.player.spectator||!this.data.pref.clockSound?null:this.data.player.color,showTenths:this.data.pref.clockTenths}):null,this.makeCorrespondenceClock(),this.correspondenceClock&&(this.clockIntervId=setInterval(this.correspondenceClockTick,6e3)),this.appStateListener=b.addListener("appStateChange",(t=>{t.isActive&&this.onResume()})),f.gameBackButton.add((()=>{0!==d.backbutton.stack.length||T(this.data)||d.backHistory()})),this.transientMove=new E(this),void 0!==M&&this.jump(M),s()}replaying(){return this.vm.ply!==this.lastPly()}firstPly(){return this.data.steps[0].ply}lastPly(){return this.data.steps[this.data.steps.length-1].ply}plyStep(t){return this.data.steps[t-this.firstPly()]}isClockRunning(){return!!this.data.clock&&D(this.data)&&(this.data.game.turns-this.data.game.startedAtTurn>1||this.data.clock.running)}sendMove(t,e,a,i=!1){const o={u:t+e};a&&(o.u+="knight"===a?"n":a[0]);const n=this.getBlurAndReset();this.data.pref.submitMove&&!i?(d.backbutton.stack.push(this.cancelMove),this.vm.moveToSubmit=o,s()):(this.actualSendMove(o,i,n),"correspondence"!==this.data.game.speed||m()||c.show({text:"You need to be connected to Internet to send your move.",position:"bottom",duration:"short"}))}sendNewPiece(t,e,a){const i={role:t,pos:e},o=this.getBlurAndReset();this.data.pref.submitMove&&!a?setTimeout((()=>{d.backbutton.stack.push(this.cancelMove),this.vm.dropToSubmit=i,s()}),this.data.pref.animationDuration||0):this.actualSendMove(i,a,o)}getBlurAndReset(){return!!this.blur&&(this.blur=!1,!0)}apiMove(t){var e,a;const o=this.data,r=T(o);if(r&&(this.lastMoveMillis=performance.now()),this.vm.submitFeedback&&this.vm.submitFeedback[0]+1===t.ply){const t="correspondence"===this.data.game.speed?Math.max(500-(performance.now()-this.vm.submitFeedback[1]),0):0;setTimeout((()=>{this.vm.submitFeedback=void 0,r&&(n.confirmation(),G.tap()),s()}),t)}o.game.turns=t.ply,o.game.player=t.ply%2==0?"white":"black";const h=t.ply%2==0?"black":"white",c="white"===o.player.color?o.player:o.opponent,l="black"===o.player.color?o.player:o.opponent,d=o.player.color===o.game.player;t.status&&(o.game.status=t.status),t.winner&&(o.game.winner=t.winner),t.check&&G.doubleTap();const p=c.offeringDraw,m=l.offeringDraw;if(!p&&t.wDraw&&(n.dong(),G.warn()),!m&&t.bDraw&&(n.dong(),G.warn()),c.offeringDraw=t.wDraw,l.offeringDraw=t.bDraw,o.possibleMoves=d?t.dests:void 0,o.possibleDrops=d?t.drops:void 0,!this.replaying()){this.vm.ply++;const s={turnColor:o.game.player,dests:r?C(o.possibleMoves):{},check:!!t.check};if(function(t){return t.isMove}(t)){const o=new Map;if(t.enpassant){const e=t.enpassant;o.set(e.key,null)}const n=new Map;if(t.castle&&!this.chessground.state.autoCastle){const e=t.castle;n.set(e.king[0],null),n.set(e.rook[0],null),n.set(e.king[1],{role:"king",color:e.color}),n.set(e.rook[1],{role:"rook",color:e.color})}const r=new Map([...o,...n]),h=i(t.uci),c=this.chessground.state.pieces;!t.castle||"king"===(null===(e=c.get(t.castle.king[0]))||void 0===e?void 0:e.role)&&"rook"===(null===(a=c.get(t.castle.rook[0]))||void 0===a?void 0:a.role)?this.chessground.apiMove(h[0],h[1],r,s):this.chessground.set(s)}else(function(t){return t.isDrop})(t)&&this.chessground.apiNewPiece({role:t.role,color:h},y(t.uci),s);if(t.promotion&&this.chessground.promote(t.promotion.key,t.promotion.pieceClass),t.enpassant){const e=t.enpassant;"atomic"===o.game.variant.key?z.enpassant(this.chessground,e.key,e.color):n.capture()}}if(t.clock){const e=t.clock;if(this.clock){const t=r&&d?0:e.lag||1;this.clock.setClock(o,e.white,e.black,t)}else this.correspondenceClock&&this.correspondenceClock.update(e.white,e.black)}if(o.game.threefold=!!t.threefold,o.steps.push({ply:this.lastPly()+1,fen:t.fen,san:t.san,uci:t.uci,check:t.check,crazy:t.crazyhouse}),x(o,h,!0),this.data.expiration&&(this.data.steps.length>2?this.data.expiration=void 0:this.data.expiration.movedAt=Date.now()),r&&h===o.player.color&&this.transientMove.clear(),!this.replaying()&&h!==o.player.color&&(this.chessground.state.premovable.current||this.chessground.state.predroppable.current)){const t="atomic"===o.game.variant.key?100:1;setTimeout((()=>{this.chessground.playPremove(),this.playPredrop()}),t)}"correspondence"===this.data.game.speed&&u.refresh().then((()=>{"ios"===w.platform&&M.setNumber({badge:u.myTurnGames().length})}))}gameStatus(){const t=U(this.data,this.data.game.winner);return j.toLabel(this.data.game.status.name,this.data.game.turns,this.data.game.winner,this.data.game.variant.key)+(t?". "+l("white"===t.color?"whiteIsVictorious":"blackIsVictorious")+".":"")}goBerserk(){this.socket.berserk(),n.berserk()}setBerserk(t){this.vm.goneBerserk[t]||(this.vm.goneBerserk[t]=!0,t!==this.data.player.color&&n.berserk(),s())}unload(){this.transientMove.clear(),this.clock&&this.clock.unload(),clearInterval(this.clockIntervId),this.appStateListener.remove(),f.gameBackButton.removeAll()}acceptTakeback(){this.chessground.cancelPremove(),this.socket.iface.send("takeback-yes")}makeCorrespondenceClock(){this.data.correspondence&&!this.correspondenceClock&&(this.correspondenceClock=new Y(this.data.correspondence,this.socket.outoftime))}actualSendMove(t,e=!1,a=!1){var i;const o=e?0:void 0!==this.lastMoveMillis?performance.now()-this.lastMoveMillis:void 0,n={ackable:!0,withLag:!(!this.clock||void 0!==o&&this.isClockRunning()),millis:o,blur:a};null===(i=this.clock)||void 0===i||i.stopClock(),s(),void 0!==t.u?this.socket.iface.send("move",t,n):function(t){return void 0!==t.role}(t)&&this.socket.iface.send("drop",t,n),this.transientMove.register()}playPredrop(){return this.chessground.playPredrop((t=>R.drop(this.data,t.role,t.key,this.data.possibleDrops)))}setData(t){t.expiration&&(t.expiration.movedAt=Date.now()-t.expiration.idleMillis),this.data=t}}export{J as O};
