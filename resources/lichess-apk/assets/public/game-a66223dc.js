import{bn as e,w as t,bo as a,bp as n,bq as i,br as o,s as r,W as s,ay as l,aN as c,at as d,a5 as h,m as u,q as g,C as p,a2 as m,b,Y as f,D as v,aL as w,bs as y,r as T,a7 as j,bt as I,bu as _,aM as C,a3 as x,bv as k,bw as P,a_ as A,aE as N,aG as L,bx as R,by as E}from"./main.js";import{l as O}from"./layout-e08f9316.js";import"./perfs-9aa7202a.js";import"./countries-a19495bf.js";import{e as U}from"./fen-f2d95e2d.js";import"./CountdownTimer-b4d0f21b.js";import"./tournamentXhr-acdac63d.js";import{n as B,l as G,o as D}from"./game-0dbfee7c.js";import{v as F,e as W}from"./crazyValid-b1cecd22.js";import"./GameTitle-217d24e1.js";import"./Board-0a9e6a9d.js";import"./promotion-0e7cb1ce.js";import{S as H}from"./index-c282ab51.js";import"./toInteger-d296e300.js";import"./chat-e47e82a7.js";import{v as S}from"./vibrate-5137c134.js";import{O as V}from"./OnlineRound-1741ad24.js";class Y{constructor(s){this.data=s,this.joinChallenge=()=>{const n=this.challenge;return n?e(n.id).then((e=>{clearTimeout(this.pingTimeoutId),t.set("/game"+e.url.round,!0)})).then((()=>a.remove(n.id))):Promise.reject("no challenge")},this.declineChallenge=()=>{const e=this.challenge;return e?n(e.id).then((()=>{clearTimeout(this.pingTimeoutId),a.remove(e.id)})).then(t.backHistory):Promise.reject("no challenge")},this.cancelChallenge=()=>{const e=this.challenge;return e?i(e.id).then((()=>{clearTimeout(this.pingTimeoutId),a.remove(e.id)})).then(t.backHistory):Promise.reject("no challenge")},this.unload=()=>{clearTimeout(this.pingTimeoutId)},this.reloadChallenge=()=>{const e=this.challenge;e&&o(e.id).then((e=>{switch(this.challenge=e.challenge,e.challenge.status){case"accepted":t.set(`/game/${e.challenge.id}`,!0);break;case"declined":t.backHistory()}}))},this.pingNow=()=>{clearTimeout(this.pingTimeoutId),this.pingTimeoutId=setTimeout(this.pingNow,2e3),this.socket&&this.socket.send("ping")},this.onSocketOpen=()=>{this.reloadChallenge(),this.pingNow()},this.challenge=s.challenge,this.socket=r.createChallenge(s.challenge.id,s.socketVersion,this.onSocketOpen,{reload:this.reloadChallenge})}}class q extends s{async write(e){if("undefined"==typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if(void 0!==e.string)await this.writeText(e.string);else if(e.url)await this.writeText(e.url);else{if(!e.image)throw new Error("Nothing to write");if("undefined"==typeof ClipboardItem)throw this.unavailable("Writing images to the clipboard is not supported in this browser");try{const t=await(await fetch(e.image)).blob(),a=new ClipboardItem({[t.type]:t});await navigator.clipboard.write([a])}catch(e){throw new Error("Failed to write image")}}}async read(){if("undefined"==typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if("undefined"==typeof ClipboardItem)return this.readText();try{const e=await navigator.clipboard.read(),t=e[0].types[0],a=await e[0].getType(t);return{value:await this._getBlobData(a,t),type:t}}catch(e){return this.readText()}}async readText(){if("undefined"==typeof navigator||!navigator.clipboard||!navigator.clipboard.readText)throw this.unavailable("Reading from clipboard not supported in this browser");return{value:await navigator.clipboard.readText(),type:"text/plain"}}async writeText(e){if("undefined"==typeof navigator||!navigator.clipboard||!navigator.clipboard.writeText)throw this.unavailable("Writting to clipboard not supported in this browser");await navigator.clipboard.writeText(e)}_getBlobData(e,t){return new Promise(((a,n)=>{const i=new FileReader;t.includes("image")?i.readAsDataURL(e):i.readAsText(e),i.onloadend=()=>{const e=i.result;a(e)},i.onerror=e=>{n(e)}}))}}const M=l("Clipboard",{web:()=>new q});function $(e){let n,i=F(d,"white");const o=e.challenge,r=c("lichess.org");return o&&(i=F(o.initialFen||d,"white"),"in"===o.direction?n=function(e,a){let n;n=a.rated&&!b.isConnected()?u("div.error",[g("thisGameIsRated"),u("br"),u("br"),g("youNeedAnAccountToDoThat"),u("div.go_or_cancel",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p(f.open)},g("signIn")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(t.backHistory)},g("cancel"))])]):b.isConnected()?u("div.go_or_cancel",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p(e.joinChallenge)},g("join")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(e.declineChallenge)},g("decline"))]):u("div",[u("button[data-icon=E].withIcon",{oncreate:p(e.joinChallenge)},g("join"))]);const i=a.challenger?g("playerisInvitingYou",X(a.challenger)):g("playerisInvitingYou","Anonymous");return h("join_url_challenge",void 0,(function(){return u("div.infos",[u("div.challenger",i),u("br"),z(a),u("br"),n])}),!0)}(e,o):"out"===o.direction&&(n=o.destUser?function(e,n){function i(){return u("div.infos",[u("div",g("waitingForOpponent")),u("br"),u("div.user",X(n.destUser)),z(n),u("br"),v.getVdom(),u("br"),u("br"),u("button.withIcon[data-icon=L]",{oncreate:p(e.cancelChallenge)},g("cancel")),a.isPersistent(n)?u("div",[u("br"),u("button",{oncreate:p((()=>t.set("/")))},[u("span.fa.fa-home"),g("Return to home")])]):null])}return h("await_url_challenge",void 0,i,!0)}(e,o):function(e,n){const i=a.isPersistent(n);return h("await_url_challenge",void 0,(function(){return u("div.infos",[z(n),u("br"),u("p.explanation",g("toInviteSomeoneToPlayGiveThisUrl")),u("div.copy_container",[u("div.icon_container",[u("span.fa.fa-clipboard")]),u("input.lichess_game_url",{oncreate:p((function(){M.write({url:J(n)}),m.show({text:"Copied to clipboard",position:"center",duration:"short"})})),value:J(n),readonly:!0})]),u("p.explanation.small",g("theFirstPersonToComeOnThisUrlWillPlayWithYou")),u("div.go_or_cancel.clearfix",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p((function(){H.share({url:J(n)})}))},g("shareGameUrl")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(e.cancelChallenge)},g("cancel"))]),i?u("div",[u("br"),u("button",{oncreate:p((()=>t.set("/")))},[u("span.fa.fa-home"),g("Return to home")])]):null])}),!0)}(e,o))),O.board(r,i,"challenge",n)}function J(e){return"https://lichess.org/"+e.id}function z(e){const t=e.rated?g("rated"):g("casual"),n=a.challengeTime(e);return u("div",{className:"gameInfos"},u("span",{"data-icon":"p"},n)," • ",u("span",null,e.variant.name)," • ",u("span",null,t))}function X(e){const t=e.rating+(e.provisional?"?":"");return`${e.name} (${t})`}var K={oninit(e){w();const a=performance.now();y(e.attrs.id,e.attrs.color).then((n=>{void 0!==n.challenge?(e.state.challenge=new Y(n),T()):function(e){return void 0!==e.url}(n)&&function(e,a,n){if(n.player.spectator||B(n)){if(G(n)&&0===D(n,n.player.color)){N.dong(),S.quick();const e=L(n.game.variant.key),t=function(e){return"game.variant.prompt."+e}(n.game.variant.key);e.alert&&-1===[1,3].indexOf(e.id)&&!R.get(t)&&E.alert({title:"Alert",message:e.alert}).then((()=>{R.set(t,!0)}))}const t=performance.now()-a;setTimeout((()=>{const t=Number(e.attrs.ply),a=isNaN(t)?void 0:t;e.state.round=new V(!!e.attrs.goingBack,e.attrs.id,n,!1,void 0,void 0,a)}),Math.max(400-t,0)),x.resetLastJoined(),void 0===n.player.user&&R.set("lastPlayedGameURLAsAnon",n.url.round)}else m.show({text:g("unsupportedVariant",n.game.variant.name),position:"center",duration:"short"}),t.set("/")}(e,a,n)})).catch((e=>{j(e),t.set("/")}))},oncreate(e){e.attrs.goingBack?I(e.dom):_(e.dom)},onremove(){C(),r.destroy(),this.round&&this.round.unload(),this.challenge&&this.challenge.unload()},view({attrs:e}){if(this.round)return W(this.round);if(this.challenge)return $(this.challenge);const t=x.lastJoined();let a;if(t)a=F(t.fen,t.color,t.lastMove,t.variant.key);else{const t=k.get(e.id);a=t?F(t.fen,t.orientation):F(U,"white")}return O.board(e.goingBack?P():A(),a)}};export default K;
